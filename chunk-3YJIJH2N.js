import{cb as N,d as E,db as R,e as k,f as x,i as g,ib as v,k as f,n as b,s as S,v as m,z as u}from"./chunk-T4RMSDZY.js";var C=(s=>(s.HEALTH_WORKER="HEALTH_WORKER",s.FACILITY_MANAGER="FACILITY_MANAGER",s.GOVERNMENT_OFFICIAL="GOVERNMENT_OFFICIAL",s))(C||{});function I(o){switch(o?.toUpperCase().trim()){case"HEALTH_WORKER":return"HEALTH_WORKER";case"FACILITY_MANAGER":return"FACILITY_MANAGER";case"GOVERNMENT_OFFICIAL":return"GOVERNMENT_OFFICIAL";default:return"HEALTH_WORKER"}}var c={production:!1,apiUrl:"http://localhost:8080",useMockAuth:!1,enableApiLogging:!0,enableErrorRetry:!0,maxRetryAttempts:3,retryDelay:1e3};var y=class o{toasts$=new k;toasts=[];constructor(){window.addEventListener("toast-dismiss",(e=>{this.removeToast(e.detail.id)}))}getToasts(){return this.toasts$.asObservable()}show(e,t,s){let i={id:Date.now().toString()+Math.random().toString(36).substr(2,9),type:e,message:t,duration:s};this.toasts.push(i),this.toasts$.next([...this.toasts]),s&&s>0&&setTimeout(()=>{this.removeToast(i.id)},s)}success(e,t){this.show("success",e,t)}error(e){this.show("error",e,0)}warning(e,t){this.show("warning",e,t)}info(e,t){this.show("info",e,t)}removeToast(e){this.toasts=this.toasts.filter(t=>t.id!==e),this.toasts$.next([...this.toasts])}clear(){this.toasts=[],this.toasts$.next([])}static \u0275fac=function(t){return new(t||o)};static \u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"})};var T=class o{router=u(v);toastService=u(y);handleError(e){let t={message:"An unexpected error occurred",status:e.status||0,timestamp:new Date().toISOString(),path:e.url||"",details:e.error};if(e.status===0)return t.message="Cannot connect to server. Please check your internet connection and ensure the backend is running.",t;switch(e.error&&(typeof e.error=="string"?t.message=e.error:e.error.message?t.message=e.error.message:e.error.error&&(t.message=e.error.error)),e.status){case 400:t.message=t.message||"Invalid request. Please check your input.";break;case 401:t.path?.includes("/api/auth/login")||t.path?.includes("/api/auth/register")||(t.message=t.message||"Your session has expired. Please log in again.",this.handleUnauthorized());break;case 403:t.message=t.message||"You do not have permission to perform this action.";break;case 404:t.message=t.message||"The requested resource was not found.";break;case 409:t.message=t.message||"A conflict occurred. The resource may already exist.";break;case 422:t.message=t.message||"Validation error. Please check your input.";break;case 500:t.message="Server error. Please try again later or contact support.";break;case 503:t.message="Service temporarily unavailable. Please try again later.";break;default:t.message==="An unexpected error occurred"&&(t.message=`Error ${e.status}: ${t.message}`)}return c.enableApiLogging&&!c.production&&console.error("API Error:",{status:t.status,message:t.message,path:t.path,details:t.details}),t}handleUnauthorized(){localStorage.removeItem("token"),localStorage.removeItem("user"),localStorage.removeItem("tokenExpiration"),localStorage.removeItem("rememberMe"),this.router.navigate(["/login"],{queryParams:{returnUrl:this.router.url,expired:"true"}}),this.toastService.error("Your session has expired. Please log in again.")}isRetryableError(e){return c.enableErrorRetry?e.status===0||e.status>=500&&e.status<600?!0:[408,429,503,504].includes(e.status):!1}getErrorMessage(e){return e instanceof N?this.handleError(e).message:e.message}getValidationErrors(e){return e.status===422&&e.error?.errors?e.error.errors:{}}static \u0275fac=function(t){return new(t||o)};static \u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"})};var A=class o{http=u(R);router=u(v);errorHandler=u(T);apiUrl=c.apiUrl;currentUserSubject=new x(null);currentUser$=this.currentUserSubject.asObservable();tokenExpirationTimer=null;constructor(){this.loadUserFromStorage(),this.checkTokenExpiration()}login(e,t=!1){if(c.useMockAuth)return this.mockLogin(e);let i={username:e.usernameOrEmail||e.username||"",password:e.password};return this.http.post(`${this.apiUrl}/api/auth/login`,i).pipe(f(a=>{if(!a||!a.token)throw new Error("Invalid response from server");let r=a.user||a,n=r.fullName||r.name||"",p=n.split(" ").filter(O=>O.length>0),l="";typeof r.role=="string"?l=r.role:r.role?.name?l=r.role.name:r.role&&(l=String(r.role)),l=l.toUpperCase().trim();let U=I(l),h={id:String(r.id||r.userId||""),username:r.username||"",email:r.email,role:U,facilityId:r.facilityId,facilityName:r.facilityName,districtId:r.districtId,fullName:n,firstName:p[0]||r.firstName||r.username,lastName:p.slice(1).join(" ")||r.lastName||"",isActive:r.active!==!1,active:r.active!==!1,status:r.status||(r.active!==!1?"ACTIVE":"INACTIVE")};typeof h.role!="string"&&(h.role=String(h.role));let d=a.expiresIn||18e5;return d<1e5&&(d=d*1e3),{token:a.token,user:h,expiresIn:d}}),S(a=>{this.setSession(a,t),this.scheduleTokenExpiration(a.expiresIn)}),b(a=>{let r=this.errorHandler.handleError(a);return g(()=>r)}))}mockLogin(e){return new E(t=>{setTimeout(()=>{let s={"health.worker":{user:{id:"1",username:"health.worker",email:"health.worker@vaxtrack.com",role:"HEALTH_WORKER",facilityId:"FAC001",facilityName:"Mvog-Ada Health Center",fullName:"Dr. Sarah Mbah",firstName:"Sarah",lastName:"Mbah",isActive:!0,active:!0},password:"password123"},"facility.manager":{user:{id:"2",username:"facility.manager",email:"facility.manager@vaxtrack.com",role:"FACILITY_MANAGER",facilityId:"FAC001",facilityName:"Mvog-Ada Health Center",fullName:"John Manager",firstName:"John",lastName:"Manager",isActive:!0,active:!0},password:"password123"},"gov.official":{user:{id:"3",username:"gov.official",email:"gov.official@vaxtrack.com",role:"GOVERNMENT_OFFICIAL",facilityId:"",facilityName:"System Administration",fullName:"Government Official",firstName:"Government",lastName:"Official",isActive:!0,active:!0},password:"password123"}},i=e.usernameOrEmail||e.username||"",a=e.password||"",r=Object.keys(s).find(n=>s[n].user.username.toLowerCase()===i.toLowerCase()||s[n].user.email?.toLowerCase()===i.toLowerCase());if(r&&s[r].password===a){let n=s[r].user,l={token:`mock-token-${Date.now()}-${n.id}`,user:n,expiresIn:18e5};this.setSession(l),t.next(l),t.complete()}else t.error({status:401,error:{message:"Invalid username or password"}})},500)})}logout(){this.tokenExpirationTimer&&(clearTimeout(this.tokenExpirationTimer),this.tokenExpirationTimer=null),!c.useMockAuth&&this.isAuthenticated()?this.http.post(`${this.apiUrl}/api/auth/logout`,{}).subscribe({next:()=>{this.clearSession()},error:()=>{this.clearSession()}}):this.clearSession()}clearSession(){localStorage.removeItem("token"),localStorage.removeItem("user"),localStorage.removeItem("tokenExpiration"),localStorage.removeItem("rememberMe"),this.currentUserSubject.next(null),this.router.navigate(["/login"])}getToken(){return localStorage.getItem("token")}getCurrentUser(){if(fetch("http://127.0.0.1:7243/ingest/beb0f3e8-0ff1-4b21-b2a4-519a994a184e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"auth.service.ts:233",message:"getCurrentUser called",data:{hasValue:!!this.currentUserSubject.value,hasToken:!!this.getToken()},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"F"})}).catch(()=>{}),!this.currentUserSubject.value){let e=localStorage.getItem("user");if(e)try{let t=JSON.parse(e);return this.currentUserSubject.next(t),fetch("http://127.0.0.1:7243/ingest/beb0f3e8-0ff1-4b21-b2a4-519a994a184e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"auth.service.ts:240",message:"getCurrentUser loaded from storage",data:{userRole:t?.role},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"F"})}).catch(()=>{}),t}catch(t){console.error("Error parsing user from storage:",t)}}return this.currentUserSubject.value}isAuthenticated(){return this.getToken()?this.isTokenExpired()?(fetch("http://127.0.0.1:7243/ingest/beb0f3e8-0ff1-4b21-b2a4-519a994a184e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"auth.service.ts:256",message:"isAuthenticated - token expired",data:{},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"F"})}).catch(()=>{}),this.clearSession(),!1):(fetch("http://127.0.0.1:7243/ingest/beb0f3e8-0ff1-4b21-b2a4-519a994a184e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"auth.service.ts:262",message:"isAuthenticated - true",data:{hasUser:!!this.getCurrentUser()},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"F"})}).catch(()=>{}),!0):(fetch("http://127.0.0.1:7243/ingest/beb0f3e8-0ff1-4b21-b2a4-519a994a184e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"auth.service.ts:250",message:"isAuthenticated - no token",data:{},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"F"})}).catch(()=>{}),!1)}hasRole(e){return this.getCurrentUser()?.role===e}hasAnyRole(e){let t=this.getCurrentUser();return t?e.includes(t.role):!1}setSession(e,t=!1){fetch("http://127.0.0.1:7243/ingest/beb0f3e8-0ff1-4b21-b2a4-519a994a184e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"auth.service.ts:262",message:"setSession called",data:{hasUser:!!e.user,userRole:e.user?.role},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"F"})}).catch(()=>{}),localStorage.setItem("token",e.token),localStorage.setItem("user",JSON.stringify(e.user));let s=Date.now(),i=s+e.expiresIn;localStorage.setItem("tokenExpiration",i.toString()),fetch("http://127.0.0.1:7243/ingest/beb0f3e8-0ff1-4b21-b2a4-519a994a184e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"auth.service.ts:303",message:"Token expiration set",data:{now:s,expiresIn:e.expiresIn,expirationTime:i},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"G"})}).catch(()=>{}),t?localStorage.setItem("rememberMe","true"):localStorage.removeItem("rememberMe"),this.currentUserSubject.next(e.user),fetch("http://127.0.0.1:7243/ingest/beb0f3e8-0ff1-4b21-b2a4-519a994a184e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"auth.service.ts:278",message:"setSession completed",data:{currentUserSet:!!this.currentUserSubject.value,userRole:this.currentUserSubject.value?.role},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"F"})}).catch(()=>{})}loadUserFromStorage(){let e=localStorage.getItem("user");if(e)try{let t=JSON.parse(e);if(this.isTokenExpired()){this.clearSession();return}this.currentUserSubject.next(t)}catch{this.clearSession()}}isTokenExpired(){let e=localStorage.getItem("tokenExpiration");if(!e)return fetch("http://127.0.0.1:7243/ingest/beb0f3e8-0ff1-4b21-b2a4-519a994a184e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"auth.service.ts:340",message:"isTokenExpired - no expiration time",data:{},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"G"})}).catch(()=>{}),!0;let t=parseInt(e,10),s=Date.now(),i=t-s;fetch("http://127.0.0.1:7243/ingest/beb0f3e8-0ff1-4b21-b2a4-519a994a184e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"auth.service.ts:348",message:"isTokenExpired check",data:{expiration:t,now:s,timeUntilExpiration:i,expirationTime:e,buffer:3e5},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"G"})}).catch(()=>{});let a=Math.min(3e5,Math.max(0,i)),r=s>=t-a;return fetch("http://127.0.0.1:7243/ingest/beb0f3e8-0ff1-4b21-b2a4-519a994a184e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"auth.service.ts:355",message:"isTokenExpired result",data:{isExpired:r},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"G"})}).catch(()=>{}),r}scheduleTokenExpiration(e){this.tokenExpirationTimer&&clearTimeout(this.tokenExpirationTimer);let t=e-3e5;t>0&&(this.tokenExpirationTimer=setTimeout(()=>{this.isTokenExpired()&&this.handleTokenExpiration()},t))}handleTokenExpiration(){this.clearSession(),this.router.navigate(["/login"],{queryParams:{expired:"true"}})}refreshToken(e){return this.http.post(`${this.apiUrl}/api/auth/refresh`,{refreshToken:e}).pipe(f(t=>{if(!t||!t.token)throw new Error("Invalid refresh response");let s=t.user||{},i=s.fullName||"",a=i.split(" ").filter(l=>l.length>0),r=s.role?.name||s.role||"",n=I(r),p={id:String(s.id||""),username:s.username||"",email:s.email,role:n,facilityId:s.facilityId,facilityName:s.facilityName,fullName:i,firstName:a[0]||s.username,lastName:a.slice(1).join(" ")||"",isActive:s.active!==!1,active:s.active!==!1};return{token:t.token,user:p,expiresIn:t.expiresIn||18e5}}),S(t=>{this.setSession(t),this.scheduleTokenExpiration(t.expiresIn)}),b(t=>(this.clearSession(),g(()=>t))))}checkTokenExpiration(){if(this.isTokenExpired()&&this.getToken())this.clearSession();else if(this.getToken()){let e=localStorage.getItem("tokenExpiration");if(e){let t=parseInt(e,10),s=Date.now(),i=t-s-3e5;i>0?this.scheduleTokenExpiration(i):this.handleTokenExpiration()}}}getProfile(){return this.http.get(`${this.apiUrl}/api/auth/profile`).pipe(f(e=>{let t=e.fullName||e.name||"",s=t.split(" ").filter(n=>n.length>0),i=e.role?.name||e.role||"",a=I(i),r={id:String(e.id||""),username:e.username||"",email:e.email,role:a,facilityId:e.facilityId,facilityName:e.facilityName,fullName:t,firstName:s[0]||e.firstName||e.username,lastName:s.slice(1).join(" ")||e.lastName||"",isActive:e.active!==!1,active:e.active!==!1};return this.currentUserSubject.next(r),localStorage.setItem("user",JSON.stringify(r)),r}),b(e=>{let t=this.errorHandler.handleError(e);return g(()=>t)}))}static \u0275fac=function(t){return new(t||o)};static \u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"})};export{C as a,c as b,y as c,T as d,A as e};
