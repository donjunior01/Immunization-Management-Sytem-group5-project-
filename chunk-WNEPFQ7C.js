import{cb as N,d as T,db as R,e as S,f as y,i as h,ib as E,k as d,n as v,s as x,v as u,z as m}from"./chunk-T4RMSDZY.js";var O=(r=>(r.HEALTH_WORKER="HEALTH_WORKER",r.FACILITY_MANAGER="FACILITY_MANAGER",r.GOVERNMENT_OFFICIAL="GOVERNMENT_OFFICIAL",r))(O||{});function k(a){switch(a?.toUpperCase().trim()){case"HEALTH_WORKER":return"HEALTH_WORKER";case"FACILITY_MANAGER":return"FACILITY_MANAGER";case"GOVERNMENT_OFFICIAL":return"GOVERNMENT_OFFICIAL";default:return"HEALTH_WORKER"}}var c={production:!0,apiUrl:"https://immunizationdb-backend.onrender.com/api",useMockAuth:!1,enableApiLogging:!1,enableErrorRetry:!0,maxRetryAttempts:3,retryDelay:1e3};var I=class a{toasts$=new S;toasts=[];constructor(){window.addEventListener("toast-dismiss",(e=>{this.removeToast(e.detail.id)}))}getToasts(){return this.toasts$.asObservable()}show(e,t,r){let o={id:Date.now().toString()+Math.random().toString(36).substr(2,9),type:e,message:t,duration:r};this.toasts.push(o),this.toasts$.next([...this.toasts]),r&&r>0&&setTimeout(()=>{this.removeToast(o.id)},r)}success(e,t){this.show("success",e,t)}error(e){this.show("error",e,0)}warning(e,t){this.show("warning",e,t)}info(e,t){this.show("info",e,t)}removeToast(e){this.toasts=this.toasts.filter(t=>t.id!==e),this.toasts$.next([...this.toasts])}clear(){this.toasts=[],this.toasts$.next([])}static \u0275fac=function(t){return new(t||a)};static \u0275prov=u({token:a,factory:a.\u0275fac,providedIn:"root"})};var b=class a{router=m(E);toastService=m(I);handleError(e){let t={message:"An unexpected error occurred",status:e.status||0,timestamp:new Date().toISOString(),path:e.url||"",details:e.error};if(e.status===0)return t.message="Cannot connect to server. Please check your internet connection and ensure the backend is running.",t;switch(e.error&&(typeof e.error=="string"?t.message=e.error:e.error.message?t.message=e.error.message:e.error.error&&(t.message=e.error.error)),e.status){case 400:t.message=t.message||"Invalid request. Please check your input.";break;case 401:t.path?.includes("/api/auth/login")||t.path?.includes("/api/auth/register")||(t.message=t.message||"Your session has expired. Please log in again.",this.handleUnauthorized());break;case 403:t.message=t.message||"You do not have permission to perform this action.";break;case 404:t.message=t.message||"The requested resource was not found.";break;case 409:t.message=t.message||"A conflict occurred. The resource may already exist.";break;case 422:t.message=t.message||"Validation error. Please check your input.";break;case 500:t.message="Server error. Please try again later or contact support.";break;case 503:t.message="Service temporarily unavailable. Please try again later.";break;default:t.message==="An unexpected error occurred"&&(t.message=`Error ${e.status}: ${t.message}`)}return c.enableApiLogging&&!c.production&&console.error("API Error:",{status:t.status,message:t.message,path:t.path,details:t.details}),t}handleUnauthorized(){localStorage.removeItem("token"),localStorage.removeItem("user"),localStorage.removeItem("tokenExpiration"),localStorage.removeItem("rememberMe"),this.router.navigate(["/login"],{queryParams:{returnUrl:this.router.url,expired:"true"}}),this.toastService.error("Your session has expired. Please log in again.")}isRetryableError(e){return c.enableErrorRetry?e.status===0||e.status>=500&&e.status<600?!0:[408,429,503,504].includes(e.status):!1}getErrorMessage(e){return e instanceof N?this.handleError(e).message:e.message}getValidationErrors(e){return e.status===422&&e.error?.errors?e.error.errors:{}}static \u0275fac=function(t){return new(t||a)};static \u0275prov=u({token:a,factory:a.\u0275fac,providedIn:"root"})};var w=class a{http=m(R);router=m(E);errorHandler=m(b);apiUrl=c.apiUrl;currentUserSubject=new y(null);currentUser$=this.currentUserSubject.asObservable();tokenExpirationTimer=null;constructor(){this.loadUserFromStorage(),this.checkTokenExpiration()}login(e,t=!1){if(c.useMockAuth)return this.mockLogin(e);let o={username:e.usernameOrEmail||e.username||"",password:e.password};return this.http.post(`${this.apiUrl}/api/auth/login`,o).pipe(d(i=>{if(!i||!i.token)throw new Error("Invalid response from server");let s=i.user||i,n=s.fullName||s.name||"",p=n.split(" ").filter(L=>L.length>0),l="";typeof s.role=="string"?l=s.role:s.role?.name?l=s.role.name:s.role&&(l=String(s.role)),l=l.toUpperCase().trim();let U=k(l),g={id:String(s.id||s.userId||""),username:s.username||"",email:s.email,role:U,facilityId:s.facilityId,facilityName:s.facilityName,districtId:s.districtId,fullName:n,firstName:p[0]||s.firstName||s.username,lastName:p.slice(1).join(" ")||s.lastName||"",isActive:s.active!==!1,active:s.active!==!1,status:s.status||(s.active!==!1?"ACTIVE":"INACTIVE")};typeof g.role!="string"&&(g.role=String(g.role));let f=i.expiresIn||18e5;return f<1e5&&(f=f*1e3),{token:i.token,user:g,expiresIn:f}}),x(i=>{this.setSession(i,t),this.scheduleTokenExpiration(i.expiresIn)}),v(i=>{let s=this.errorHandler.handleError(i);return h(()=>s)}))}mockLogin(e){return new T(t=>{setTimeout(()=>{let r={"health.worker":{user:{id:"1",username:"health.worker",email:"health.worker@vaxtrack.com",role:"HEALTH_WORKER",facilityId:"FAC001",facilityName:"Mvog-Ada Health Center",fullName:"Dr. Sarah Mbah",firstName:"Sarah",lastName:"Mbah",isActive:!0,active:!0},password:"password123"},"facility.manager":{user:{id:"2",username:"facility.manager",email:"facility.manager@vaxtrack.com",role:"FACILITY_MANAGER",facilityId:"FAC001",facilityName:"Mvog-Ada Health Center",fullName:"John Manager",firstName:"John",lastName:"Manager",isActive:!0,active:!0},password:"password123"},"gov.official":{user:{id:"3",username:"gov.official",email:"gov.official@vaxtrack.com",role:"GOVERNMENT_OFFICIAL",facilityId:"",facilityName:"System Administration",fullName:"Government Official",firstName:"Government",lastName:"Official",isActive:!0,active:!0},password:"password123"}},o=e.usernameOrEmail||e.username||"",i=e.password||"",s=Object.keys(r).find(n=>r[n].user.username.toLowerCase()===o.toLowerCase()||r[n].user.email?.toLowerCase()===o.toLowerCase());if(s&&r[s].password===i){let n=r[s].user,l={token:`mock-token-${Date.now()}-${n.id}`,user:n,expiresIn:18e5};this.setSession(l),t.next(l),t.complete()}else t.error({status:401,error:{message:"Invalid username or password"}})},500)})}logout(){this.tokenExpirationTimer&&(clearTimeout(this.tokenExpirationTimer),this.tokenExpirationTimer=null),!c.useMockAuth&&this.isAuthenticated()?this.http.post(`${this.apiUrl}/api/auth/logout`,{}).subscribe({next:()=>{this.clearSession()},error:()=>{this.clearSession()}}):this.clearSession()}clearSession(){localStorage.removeItem("token"),localStorage.removeItem("user"),localStorage.removeItem("tokenExpiration"),localStorage.removeItem("rememberMe"),this.currentUserSubject.next(null),this.router.navigate(["/login"])}getToken(){return localStorage.getItem("token")}getCurrentUser(){if(!this.currentUserSubject.value){let e=localStorage.getItem("user");if(e)try{let t=JSON.parse(e);return this.currentUserSubject.next(t),t}catch(t){console.error("Error parsing user from storage:",t)}}return this.currentUserSubject.value}isAuthenticated(){return this.getToken()?this.isTokenExpired()?(this.clearSession(),!1):!0:!1}hasRole(e){return this.getCurrentUser()?.role===e}hasAnyRole(e){let t=this.getCurrentUser();return t?e.includes(t.role):!1}setSession(e,t=!1){localStorage.setItem("token",e.token),localStorage.setItem("user",JSON.stringify(e.user));let o=Date.now()+e.expiresIn;localStorage.setItem("tokenExpiration",o.toString()),t?localStorage.setItem("rememberMe","true"):localStorage.removeItem("rememberMe"),this.currentUserSubject.next(e.user)}loadUserFromStorage(){let e=localStorage.getItem("user");if(e)try{let t=JSON.parse(e);if(this.isTokenExpired()){this.clearSession();return}this.currentUserSubject.next(t)}catch{this.clearSession()}}isTokenExpired(){let e=localStorage.getItem("tokenExpiration");if(!e)return!0;let t=parseInt(e,10),r=Date.now(),o=t-r,i=Math.min(3e5,Math.max(0,o));return r>=t-i}scheduleTokenExpiration(e){this.tokenExpirationTimer&&clearTimeout(this.tokenExpirationTimer);let t=e-3e5;t>0&&(this.tokenExpirationTimer=setTimeout(()=>{this.isTokenExpired()&&this.handleTokenExpiration()},t))}handleTokenExpiration(){this.clearSession(),this.router.navigate(["/login"],{queryParams:{expired:"true"}})}refreshToken(e){return this.http.post(`${this.apiUrl}/api/auth/refresh`,{refreshToken:e}).pipe(d(t=>{if(!t||!t.token)throw new Error("Invalid refresh response");let r=t.user||{},o=r.fullName||"",i=o.split(" ").filter(l=>l.length>0),s=r.role?.name||r.role||"",n=k(s),p={id:String(r.id||""),username:r.username||"",email:r.email,role:n,facilityId:r.facilityId,facilityName:r.facilityName,fullName:o,firstName:i[0]||r.username,lastName:i.slice(1).join(" ")||"",isActive:r.active!==!1,active:r.active!==!1};return{token:t.token,user:p,expiresIn:t.expiresIn||18e5}}),x(t=>{this.setSession(t),this.scheduleTokenExpiration(t.expiresIn)}),v(t=>(this.clearSession(),h(()=>t))))}checkTokenExpiration(){if(this.isTokenExpired()&&this.getToken())this.clearSession();else if(this.getToken()){let e=localStorage.getItem("tokenExpiration");if(e){let t=parseInt(e,10),r=Date.now(),o=t-r-3e5;o>0?this.scheduleTokenExpiration(o):this.handleTokenExpiration()}}}getProfile(){return this.http.get(`${this.apiUrl}/api/auth/profile`).pipe(d(e=>{let t=e.fullName||e.name||"",r=t.split(" ").filter(n=>n.length>0),o=e.role?.name||e.role||"",i=k(o),s={id:String(e.id||""),username:e.username||"",email:e.email,role:i,facilityId:e.facilityId,facilityName:e.facilityName,fullName:t,firstName:r[0]||e.firstName||e.username,lastName:r.slice(1).join(" ")||e.lastName||"",isActive:e.active!==!1,active:e.active!==!1};return this.currentUserSubject.next(s),localStorage.setItem("user",JSON.stringify(s)),s}),v(e=>{let t=this.errorHandler.handleError(e);return h(()=>t)}))}static \u0275fac=function(t){return new(t||a)};static \u0275prov=u({token:a,factory:a.\u0275fac,providedIn:"root"})};export{O as a,c as b,I as c,b as d,w as e};
