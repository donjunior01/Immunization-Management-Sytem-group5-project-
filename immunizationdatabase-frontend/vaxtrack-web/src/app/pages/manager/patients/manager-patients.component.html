<app-layout pageTitle="Patients Management">
  <div class="patients-page">
    <div class="page-header">
      <div>
        <h1>Patients Management</h1>
        <p class="subtitle">View and manage all patients in your facility</p>
      </div>
      <button class="btn btn-primary" (click)="openCreateModal()">+ Register New Patient</button>
    </div>

    <app-alert *ngIf="errorMessage" type="error" [message]="errorMessage" [show]="!!errorMessage"></app-alert>

    <!-- Filters -->
    <div class="filters-card">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input
          type="text"
          class="search-input"
          placeholder="Search by name, phone, or ID..."
          [(ngModel)]="searchQuery"
          (input)="onSearch()">
      </div>
      <div class="filter-group">
        <label>Gender:</label>
        <select [(ngModel)]="filterGender" (change)="onFilterChange()" class="filter-select" title="Filter by gender">
          <option value="all">All</option>
          <option value="MALE">Male</option>
          <option value="FEMALE">Female</option>
        </select>
      </div>
    </div>

    <!-- Patients Table -->
    <div class="patients-table-card">
      <div class="table-header">
        <h3>All Patients ({{ filteredPatients.length }})</h3>
      </div>
      <div class="table-container">
        <table class="patients-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Age</th>
              <th>Gender</th>
              <th>Guardian</th>
              <th>Phone</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let patient of filteredPatients">
              <td>
                <div class="patient-name">
                  <strong>{{ patient.fullName || (patient.firstName + ' ' + patient.lastName) }}</strong>
                </div>
              </td>
              <td>{{ patient.age || 'N/A' }} months</td>
              <td>
                <span class="gender-badge" [ngClass]="'gender-' + (patient.gender || '').toLowerCase()">
                  {{ patient.gender }}
                </span>
              </td>
              <td>{{ patient.guardianName || 'N/A' }}</td>
              <td>{{ patient.phoneNumber || patient.guardianPhone || 'N/A' }}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn btn-sm btn-info" [routerLink]="['/vaccinator/patients', patient.id]" title="View Patient Details">
                    üëÅÔ∏è View
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="filteredPatients.length === 0">
              <td colspan="6" class="no-data">
                <div class="empty-state">
                  <span class="empty-icon">üë•</span>
                  <p>No patients found</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <app-loader *ngIf="loading"></app-loader>

    <!-- Create Patient Modal -->
    <div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
      <div class="modal-content large" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>üë∂ Register New Patient</h2>
          <button class="modal-close" (click)="closeCreateModal()">√ó</button>
        </div>
        <form [formGroup]="patientForm" (ngSubmit)="onCreateSubmit()" class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label class="required">First Name</label>
              <input type="text" formControlName="firstName" class="form-input" placeholder="Enter first name">
              <span class="error-text" *ngIf="isFieldInvalid('firstName')">
                {{ getFieldError('firstName') }}
              </span>
            </div>
            <div class="form-group">
              <label class="required">Last Name</label>
              <input type="text" formControlName="lastName" class="form-input" placeholder="Enter last name">
              <span class="error-text" *ngIf="isFieldInvalid('lastName')">
                {{ getFieldError('lastName') }}
              </span>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="required">Date of Birth</label>
              <input type="date" formControlName="dateOfBirth" class="form-input" [max]="getTodayDate()" title="Patient date of birth">
              <span class="error-text" *ngIf="isFieldInvalid('dateOfBirth')">
                {{ getFieldError('dateOfBirth') }}
              </span>
            </div>
            <div class="form-group">
              <label class="required">Gender</label>
              <select formControlName="gender" class="form-input" title="Select patient gender">
                <option value="">Select Gender</option>
                <option value="MALE">Male</option>
                <option value="FEMALE">Female</option>
              </select>
              <span class="error-text" *ngIf="isFieldInvalid('gender')">
                {{ getFieldError('gender') }}
              </span>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="required">Guardian Name</label>
              <input type="text" formControlName="guardianName" class="form-input" placeholder="Parent/Guardian full name">
              <span class="error-text" *ngIf="isFieldInvalid('guardianName')">
                {{ getFieldError('guardianName') }}
              </span>
            </div>
            <div class="form-group">
              <label class="required">Guardian Phone</label>
              <div class="phone-input">
                <span class="phone-prefix">+237</span>
                <input type="tel" formControlName="guardianPhone" class="form-input" placeholder="6XXXXXXXX" maxlength="9" pattern="[26]\d{8}">
              </div>
              <span class="error-text" *ngIf="isFieldInvalid('guardianPhone')">
                {{ getFieldError('guardianPhone') }}
              </span>
            </div>
          </div>
          <div class="form-group">
            <label>Address/Village</label>
            <input type="text" formControlName="address" class="form-input" placeholder="Village or address (optional)">
          </div>
          <div class="form-group">
            <label>National ID (Optional)</label>
            <input type="text" formControlName="nationalId" class="form-input" placeholder="National ID number">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="loading || patientForm.invalid">
              {{ loading ? 'Registering...' : 'Register Patient' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</app-layout>

