<app-layout pageTitle="SMS Logs" pageSubtitle="View and manage SMS messages sent by the system">
  <div class="sms-logs-page">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
      <a routerLink="/district/dashboard">Dashboard</a>
      <span class="separator">></span>
      <span>SMS Logs</span>
    </div>

    <app-alert 
      *ngIf="errorMessage" 
      type="error" 
      [message]="errorMessage"
      [show]="!!errorMessage"
      (dismiss)="errorMessage = ''">
    </app-alert>

    <!-- Filters -->
    <div class="filters-section">
      <form [formGroup]="filterForm" (ngSubmit)="onFilterSubmit()" class="filter-form">
        <div class="filter-row">
          <div class="filter-group">
            <label>Start Date</label>
            <input type="date" formControlName="startDate" class="input">
          </div>
          <div class="filter-group">
            <label>End Date</label>
            <input type="date" formControlName="endDate" class="input">
          </div>
          <div class="filter-group">
            <label>Status</label>
            <select formControlName="status" class="input">
              <option value="">All</option>
              <option value="SENT">Sent</option>
              <option value="FAILED">Failed</option>
              <option value="PENDING">Pending</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Phone Number</label>
            <input type="text" formControlName="recipientPhone" class="input" placeholder="e.g., +254712345678">
          </div>
        </div>
        <div class="filter-actions">
          <button type="submit" class="btn btn-primary">Apply Filters</button>
          <button type="button" class="btn btn-secondary" (click)="clearFilters()">Clear</button>
        </div>
      </form>
    </div>

    <!-- Send SMS Button -->
    <div class="action-section">
      <button class="btn btn-primary" (click)="openSendModal()">Send New SMS</button>
    </div>

    <!-- SMS Logs Table -->
    <div class="logs-section">
      <div class="section-header">
        <h2>SMS Messages</h2>
        <span class="count-badge">{{ smsLogs.length }} message(s)</span>
      </div>

      <app-loader *ngIf="loading"></app-loader>

      <div *ngIf="!loading && smsLogs.length === 0" class="empty-state">
        <div class="empty-icon">üì±</div>
        <h3>No SMS Logs Found</h3>
        <p>No SMS messages match your current filters.</p>
      </div>

      <div *ngIf="!loading && smsLogs.length > 0" class="logs-table-container">
        <table class="logs-table">
          <thead>
            <tr>
              <th>Phone Number</th>
              <th>Message</th>
              <th>Status</th>
              <th>Sent At</th>
              <th>Error</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let log of smsLogs" class="log-row">
              <td class="phone-cell">
                <span class="phone-number">{{ log.recipientPhone }}</span>
              </td>
              <td class="message-cell">
                <div class="message-content">{{ log.message }}</div>
              </td>
              <td class="status-cell">
                <span class="status-badge" [ngClass]="getStatusClass(log.status)">
                  <span class="status-icon">{{ getStatusIcon(log.status) }}</span>
                  {{ log.status }}
                </span>
              </td>
              <td class="date-cell">
                <span *ngIf="log.sentAt">{{ log.sentAt | date:'short' }}</span>
                <span *ngIf="!log.sentAt" class="no-date">-</span>
              </td>
              <td class="error-cell">
                <span *ngIf="log.errorMessage" class="error-text" [title]="log.errorMessage">
                  {{ log.errorMessage.length > 50 ? (log.errorMessage | slice:0:50) + '...' : log.errorMessage }}
                </span>
                <span *ngIf="!log.errorMessage" class="no-error">-</span>
              </td>
              <td class="action-cell">
                <button class="btn-delete" (click)="openDeleteModal(log)" title="Delete SMS log">
                  <span class="icon">üóëÔ∏è</span>
                  Delete
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Send SMS Modal -->
    <div class="modal-overlay" *ngIf="showSendModal" (click)="closeSendModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Send SMS</h3>
          <button class="close-btn" (click)="closeSendModal()">&times;</button>
        </div>
        <div class="modal-body">
          <app-alert 
            *ngIf="errorMessage" 
            type="error" 
            [message]="errorMessage"
            [show]="!!errorMessage"
            (dismiss)="errorMessage = ''">
          </app-alert>
          <app-alert 
            *ngIf="successMessage" 
            type="success" 
            [message]="successMessage"
            [show]="!!successMessage"
            (dismiss)="successMessage = ''">
          </app-alert>
          <form [formGroup]="sendSmsForm" (ngSubmit)="onSendSms()">
            <div class="form-group">
              <label class="required">Phone Number</label>
              <input 
                type="tel" 
                formControlName="phone" 
                class="input" 
                placeholder="+254712345678"
                [class.error]="sendSmsForm.get('phone')?.invalid && sendSmsForm.get('phone')?.touched">
              <span class="error-text" *ngIf="getFieldError('phone')">
                {{ getFieldError('phone') }}
              </span>
            </div>
            <div class="form-group">
              <label class="required">Message</label>
              <textarea 
                formControlName="message" 
                class="input" 
                rows="5"
                placeholder="Enter your message here..."
                [class.error]="sendSmsForm.get('message')?.invalid && sendSmsForm.get('message')?.touched">
              </textarea>
              <span class="error-text" *ngIf="getFieldError('message')">
                {{ getFieldError('message') }}
              </span>
              <small class="input-hint">{{ sendSmsForm.get('message')?.value?.length || 0 }}/500 characters</small>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" (click)="closeSendModal()" [disabled]="sendingSms">Cancel</button>
              <button type="submit" class="btn btn-primary" [disabled]="sendSmsForm.invalid || sendingSms">
                <span *ngIf="!sendingSms">Send SMS</span>
                <span *ngIf="sendingSms">Sending...</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" *ngIf="showDeleteModal" (click)="closeDeleteModal()">
      <div class="modal-content delete-modal" (click)="$event.stopPropagation()">
        <div class="modal-header delete-header">
          <h3>‚ö†Ô∏è Delete SMS Log</h3>
          <button class="close-btn" (click)="closeDeleteModal()">√ó</button>
        </div>
        <div class="modal-body">
          <app-alert
            *ngIf="errorMessage"
            type="error"
            [message]="errorMessage"
            [show]="!!errorMessage"
            (dismiss)="errorMessage = ''">
          </app-alert>

          <div class="delete-confirmation">
            <p class="confirmation-text">
              Are you sure you want to delete this SMS log? This action cannot be undone.
            </p>
            <div class="sms-details" *ngIf="smsToDelete">
              <div class="detail-item">
                <span class="detail-label">Phone:</span>
                <span class="detail-value">{{ smsToDelete.recipientPhone }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Message:</span>
                <span class="detail-value">{{ smsToDelete.message }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Status:</span>
                <span class="detail-value status-badge" [ngClass]="getStatusClass(smsToDelete.status)">
                  {{ smsToDelete.status }}
                </span>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()" [disabled]="deletingSms">
              Cancel
            </button>
            <button type="button" class="btn btn-danger" (click)="confirmDelete()" [disabled]="deletingSms">
              <app-loader *ngIf="deletingSms"></app-loader>
              <span *ngIf="!deletingSms">Delete</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</app-layout>

