<app-layout [pageTitle]="getPatientDisplayName() || 'Patient Details'">
  <div class="patient-detail-page">
    <!-- Error Message -->
    <app-alert 
      *ngIf="errorMessage" 
      type="error" 
      [message]="errorMessage"
      [show]="!!errorMessage"
      (dismiss)="errorMessage = ''">
    </app-alert>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
      <app-loader></app-loader>
      <p class="loading-text">Loading patient details...</p>
    </div>

    <!-- Patient Not Found / Error State -->
    <div *ngIf="!loading && !patient" class="empty-state-container">
      <div class="empty-state">
        <div class="empty-icon">ğŸ‘¤</div>
        <h2>{{ errorMessage ? 'Error Loading Patient' : 'Patient Not Found' }}</h2>
        <p>{{ errorMessage || 'The patient you're looking for doesn't exist or couldn't be loaded.' }}</p>
        <button class="btn btn-primary" routerLink="/vaccinator/dashboard">Back to Dashboard</button>
      </div>
    </div>

    <!-- Patient Content -->
    <div *ngIf="patient">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-left">
        <button class="btn-back" routerLink="/vaccinator/dashboard">â† Back to Dashboard</button>
        <div class="patient-header-info">
          <h1>{{ getPatientDisplayName() }}</h1>
          <div class="patient-meta">
            <span class="patient-id">ID: {{ patient.patientId || patient.id }}</span>
            <span class="separator">â€¢</span>
            <span class="patient-age">Age: {{ getPatientAge() }}</span>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" (click)="editPatient()">Edit Patient</button>
        <button class="btn btn-primary" (click)="recordVaccination()">Record Vaccination</button>
        <button class="btn btn-secondary" (click)="printCard()">Print Card</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button 
        class="tab" 
        [class.active]="activeTab === 'overview'"
        (click)="activeTab = 'overview'">Overview</button>
      <button 
        class="tab" 
        [class.active]="activeTab === 'vaccinations'"
        (click)="activeTab = 'vaccinations'">Vaccination History</button>
      <button 
        class="tab" 
        [class.active]="activeTab === 'appointments'"
        (click)="activeTab = 'appointments'">Appointments</button>
      <button 
        class="tab" 
        [class.active]="activeTab === 'documents'"
        (click)="activeTab = 'documents'">Documents</button>
    </div>

    <!-- Overview Tab -->
    <div class="tab-content" *ngIf="activeTab === 'overview'">
      <div class="overview-grid">
        <!-- Left Column: Patient Card -->
        <div class="patient-card">
          <div class="patient-avatar-large">{{ getPatientDisplayName()[0] }}</div>
          <h2>{{ getPatientDisplayName() }}</h2>
          <div class="patient-id-large">ID: {{ patient.patientId || patient.id }}</div>
          <div class="divider"></div>
          <div class="patient-info-list">
            <div class="info-item">
              <span class="info-icon">ğŸ“…</span>
              <div class="info-content">
                <div class="info-label">Birth Date</div>
                <div class="info-value">{{ (patient.birthDate || patient.dateOfBirth) | date:'dd MMMM yyyy' }}</div>
              </div>
            </div>
            <div class="info-item">
              <span class="info-icon">ğŸ‚</span>
              <div class="info-content">
                <div class="info-label">Age</div>
                <div class="info-value">{{ getPatientAge() }}</div>
              </div>
            </div>
            <div class="info-item">
              <span class="info-icon">ğŸ‘¤</span>
              <div class="info-content">
                <div class="info-label">Gender</div>
                <div class="info-value">{{ patient.gender || 'N/A' }}</div>
              </div>
            </div>
            <div class="info-item">
              <span class="info-icon">ğŸ“</span>
              <div class="info-content">
                <div class="info-label">Village</div>
                <div class="info-value">{{ patient.village || 'N/A' }}</div>
              </div>
            </div>
            <div class="info-item">
              <span class="info-icon">ğŸ“</span>
              <div class="info-content">
                <div class="info-label">Guardian</div>
                <div class="info-value">{{ patient.guardianName || 'N/A' }}</div>
              </div>
            </div>
            <div class="info-item">
              <span class="info-icon">â˜ï¸</span>
              <div class="info-content">
                <div class="info-label">Phone</div>
                <div class="info-value">{{ patient.guardianPhone || patient.phoneNumber || 'N/A' }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: Vaccination Status & Next Appointment -->
        <div class="status-column">
          <!-- Vaccination Progress Card -->
          <div class="status-card">
            <h3>Vaccination Progress</h3>
            <div class="progress-bar-large">
              <div class="progress-fill" [style.width.%]="vaccinationProgress"></div>
            </div>
            <div class="progress-text">{{ vaccinationProgress }}% Complete</div>
            
            <div class="vaccination-schedule">
              <div class="schedule-item" *ngFor="let item of [
                { name: 'BCG', dose: 1, status: getVaccinationStatus('BCG', 1) },
                { name: 'OPV', dose: 0, status: getVaccinationStatus('OPV', 0) },
                { name: 'OPV', dose: 1, status: getVaccinationStatus('OPV', 1) },
                { name: 'Penta', dose: 1, status: getVaccinationStatus('Penta', 1) },
                { name: 'Penta', dose: 2, status: getVaccinationStatus('Penta', 2) },
                { name: 'Penta', dose: 3, status: getVaccinationStatus('Penta', 3) },
                { name: 'Measles', dose: 1, status: getVaccinationStatus('Measles', 1) }
              ]">
                <span class="status-icon">{{ getStatusIcon(item.status) }}</span>
                <span class="vaccine-name">{{ item.name }} {{ item.dose > 0 ? '(Dose ' + item.dose + ')' : '' }}</span>
                <span class="status-text" [ngClass]="'status-' + item.status">
                  {{ item.status === 'completed' ? 'Completed' : item.status === 'due' ? 'Due' : 'Pending' }}
                </span>
              </div>
            </div>
          </div>

          <!-- Next Appointment Card -->
          <div class="status-card" *ngIf="nextAppointment">
            <h3>Next Appointment</h3>
            <div class="appointment-info">
              <div class="appointment-date">
                <span class="date-icon">ğŸ“…</span>
                <div>
                  <div class="date-value">{{ nextAppointment.appointmentDate | date:'dd MMM yyyy' }}</div>
                  <div class="time-value">{{ nextAppointment.appointmentTime || 'All Day' }}</div>
                </div>
              </div>
              <div class="appointment-vaccine">
                <strong>Vaccine Due:</strong> {{ nextAppointment.vaccineName || 'N/A' }}
              </div>
              <button class="btn btn-sm btn-secondary" (click)="rescheduleAppointment(nextAppointment)">Reschedule</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Vaccination History Tab -->
    <div class="tab-content" *ngIf="activeTab === 'vaccinations'">
      <div class="vaccination-timeline">
        <div *ngFor="let vaccination of vaccinations" class="timeline-item">
            <div class="timeline-date">
              <div class="date-main">{{ (vaccination.administeredDate || vaccination.date) | date:'dd MMM yyyy' }}</div>
              <div class="date-time">{{ (vaccination.administeredDate || vaccination.date) | date:'h:mm a' }}</div>
            </div>
          <div class="timeline-content">
            <div class="timeline-header">
              <span class="vaccine-icon">ğŸ’‰</span>
              <h3>{{ vaccination.vaccineName }} (Dose {{ vaccination.doseNumber }})</h3>
            </div>
            <div class="timeline-details">
              <div class="detail-row">
                <span class="detail-label">Batch:</span>
                <span class="detail-value">{{ vaccination.batchNumber || 'N/A' }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Expiry:</span>
                <span class="detail-value">{{ vaccination.expiryDate | date:'MMM yyyy' }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Site:</span>
                <span class="detail-value">{{ (vaccination.administrationSite || vaccination.site) || 'N/A' }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Administered by:</span>
                <span class="detail-value">{{ vaccination.administeredBy || 'N/A' }}</span>
              </div>
              <div class="detail-row" *ngIf="vaccination.notes || vaccination.adverseEventNotes">
                <span class="detail-label">Notes:</span>
                <span class="detail-value">{{ vaccination.notes || vaccination.adverseEventNotes }}</span>
              </div>
            </div>
            <button class="btn btn-sm btn-secondary" (click)="viewVaccinationDetails(vaccination)">View Details</button>
          </div>
        </div>
        <div *ngIf="vaccinations.length === 0" class="empty-state">
          <div class="empty-icon">ğŸ’‰</div>
          <p>No vaccination records found</p>
        </div>
      </div>

      <!-- Adverse Events Section -->
      <div class="adverse-events-section">
        <h3 class="section-title">âš ï¸ Adverse Events</h3>
        <div class="adverse-events-list" *ngIf="adverseEvents.length > 0">
          <div *ngFor="let event of adverseEvents" class="adverse-event-card" [ngClass]="'severity-' + event.severity.toLowerCase()">
            <div class="event-header">
              <div class="severity-badge" [ngClass]="'severity-' + event.severity.toLowerCase()">
                {{ event.severity }}
              </div>
              <div class="event-date">{{ event.reportedAt | date:'dd MMM yyyy, h:mm a' }}</div>
            </div>
            <div class="event-description">
              <strong>Description:</strong>
              <p>{{ event.description }}</p>
            </div>
            <div class="event-action" *ngIf="event.actionTaken">
              <strong>Action Taken:</strong>
              <p>{{ event.actionTaken }}</p>
            </div>
            <div class="event-meta">
              <span *ngIf="event.reportedByName">Reported by: {{ event.reportedByName }}</span>
            </div>
          </div>
        </div>
        <div class="empty-state" *ngIf="adverseEvents.length === 0">
          <div class="empty-icon">âœ…</div>
          <p>No adverse events recorded for this patient</p>
        </div>
      </div>
    </div>

    <!-- Appointments Tab -->
    <div class="tab-content" *ngIf="activeTab === 'appointments'">
      <div class="appointments-section">
        <div class="section-header">
          <h3>Upcoming Appointments</h3>
          <button class="btn btn-primary" (click)="scheduleAppointment()">Schedule New Appointment</button>
        </div>
        <div class="appointments-list">
          <div *ngFor="let appointment of getScheduledAppointments()" class="appointment-card">
            <div class="appointment-date-badge">
              <div class="date-day">{{ appointment.appointmentDate | date:'dd' }}</div>
              <div class="date-month">{{ appointment.appointmentDate | date:'MMM' }}</div>
            </div>
            <div class="appointment-details">
              <div class="appointment-time">{{ appointment.appointmentTime || 'All Day' }}</div>
              <div class="appointment-vaccine-name">{{ appointment.vaccineName || 'Vaccine' }}</div>
              <div class="appointment-dose">Dose {{ appointment.doseNumber || 1 }}</div>
            </div>
            <div class="appointment-actions">
              <button class="btn btn-sm btn-secondary" (click)="rescheduleAppointment(appointment)">Reschedule</button>
              <button class="btn btn-sm btn-primary" (click)="recordVaccinationFromAppointment(appointment)">Record Vaccination</button>
            </div>
          </div>
        </div>

        <div class="section-header past-appointments-header">
          <h3>Past Appointments</h3>
        </div>
        <div class="appointments-list">
          <div *ngFor="let appointment of getPastAppointments()" 
               class="appointment-card" [ngClass]="'status-' + appointment.status.toLowerCase()">
            <div class="appointment-date-badge">
              <div class="date-day">{{ appointment.appointmentDate | date:'dd' }}</div>
              <div class="date-month">{{ appointment.appointmentDate | date:'MMM' }}</div>
            </div>
            <div class="appointment-details">
              <div class="appointment-time">{{ appointment.appointmentTime || 'All Day' }}</div>
              <div class="appointment-vaccine-name">{{ appointment.vaccineName || 'Vaccine' }}</div>
              <div class="appointment-status-badge" [ngClass]="'status-' + appointment.status.toLowerCase()">
                {{ appointment.status }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Documents Tab -->
    <div class="tab-content" *ngIf="activeTab === 'documents'">
      <div class="documents-section">
        <div class="empty-state">
          <div class="empty-icon">ğŸ“„</div>
          <p>No documents uploaded</p>
          <button class="btn btn-primary" (click)="uploadDocument()">Upload Document</button>
        </div>
      </div>
    </div>
    </div>

    <!-- Schedule Appointment Modal -->
    <div class="modal-overlay" *ngIf="showScheduleModal" (click)="closeScheduleModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>ğŸ“… Schedule New Appointment</h2>
          <button class="modal-close" (click)="closeScheduleModal()">Ã—</button>
        </div>
        <form [formGroup]="scheduleForm" (ngSubmit)="onScheduleSubmit()" class="modal-body">
          <div class="info-box">
            <p><strong>Patient:</strong> {{ getPatientDisplayName() }}</p>
            <p><strong>Age:</strong> {{ getPatientAge() }}</p>
          </div>
          
          <div class="form-group">
            <label class="required">Vaccine</label>
            <select formControlName="vaccineName" class="form-input">
              <option value="">Select Vaccine</option>
              <option *ngFor="let vaccine of availableVaccines" [value]="vaccine.name">
                {{ vaccine.name }}
              </option>
            </select>
            <span class="error-text" *ngIf="isFieldInvalid('vaccineName', scheduleForm)">
              {{ getFieldError('vaccineName', scheduleForm) }}
            </span>
          </div>

          <div class="form-group">
            <label class="required">Dose Number</label>
            <input 
              type="number" 
              formControlName="doseNumber" 
              class="form-input" 
              min="1" 
              max="5">
            <span class="error-text" *ngIf="isFieldInvalid('doseNumber', scheduleForm)">
              {{ getFieldError('doseNumber', scheduleForm) }}
            </span>
          </div>

          <div class="form-group">
            <label class="required">Appointment Date</label>
            <input 
              type="date" 
              formControlName="appointmentDate" 
              class="form-input" 
              [min]="getTodayDate()">
            <span class="error-text" *ngIf="isFieldInvalid('appointmentDate', scheduleForm)">
              {{ getFieldError('appointmentDate', scheduleForm) }}
            </span>
          </div>

          <div class="form-group">
            <label>Appointment Time (Optional)</label>
            <input 
              type="time" 
              formControlName="appointmentTime" 
              class="form-input">
          </div>

          <div class="form-group">
            <label>Notes (Optional)</label>
            <textarea 
              formControlName="notes" 
              class="form-input" 
              rows="3" 
              placeholder="Additional notes about this appointment"></textarea>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeScheduleModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="schedulingAppointment || scheduleForm.invalid">
              {{ schedulingAppointment ? 'Scheduling...' : 'Schedule Appointment' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Reschedule Appointment Modal -->
  <div class="modal-overlay" *ngIf="showRescheduleModal" (click)="closeRescheduleModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>ğŸ“… Reschedule Appointment</h2>
        <button class="modal-close" (click)="closeRescheduleModal()" aria-label="Close">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="info-box" *ngIf="appointmentToReschedule">
          <p><strong>Current Appointment:</strong></p>
          <p>ğŸ“… {{ appointmentToReschedule.appointmentDate | date:'dd MMM yyyy' }}</p>
          <p *ngIf="appointmentToReschedule.appointmentTime">ğŸ• {{ appointmentToReschedule.appointmentTime }}</p>
          <p>ğŸ’‰ {{ appointmentToReschedule.vaccineName }} - Dose {{ appointmentToReschedule.doseNumber }}</p>
        </div>
        
        <form [formGroup]="rescheduleForm" (ngSubmit)="onRescheduleSubmit()">
          <div class="form-group">
            <label class="required">New Appointment Date</label>
            <input 
              type="date" 
              formControlName="appointmentDate" 
              class="form-input" 
              [min]="getTodayDate()">
            <span class="error-text" *ngIf="isFieldInvalid('appointmentDate', rescheduleForm)">
              {{ getFieldError('appointmentDate', rescheduleForm) }}
            </span>
          </div>

          <div class="form-group">
            <label>New Appointment Time (Optional)</label>
            <input 
              type="time" 
              formControlName="appointmentTime" 
              class="form-input">
          </div>

          <div class="form-group">
            <label>Notes (Optional)</label>
            <textarea 
              formControlName="notes" 
              class="form-input" 
              rows="3" 
              placeholder="Reason for rescheduling or additional notes"></textarea>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeRescheduleModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="reschedulingAppointment || rescheduleForm.invalid">
              {{ reschedulingAppointment ? 'Rescheduling...' : 'Reschedule Appointment' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="modal-overlay" *ngIf="showSuccessModal" (click)="showSuccessModal = false">
    <div class="modal-content success-modal" (click)="$event.stopPropagation()">
      <div class="modal-header success-header">
        <div class="success-icon-wrapper">
          <div class="success-icon-circle">
            <span class="success-checkmark">âœ“</span>
          </div>
        </div>
        <div class="modal-title-section">
          <h2>{{ isRescheduling ? 'ğŸ‰ Appointment Rescheduled Successfully!' : 'ğŸ‰ Appointment Scheduled Successfully!' }}</h2>
          <p class="success-subtitle">{{ isRescheduling ? 'The appointment has been updated in the schedule' : 'The appointment has been added to the schedule' }}</p>
        </div>
        <button class="modal-close" (click)="showSuccessModal = false" aria-label="Close">Ã—</button>
      </div>
      <div class="modal-body success-body">
        <div class="success-details" *ngIf="createdAppointment">
          <div class="detail-card">
            <div class="detail-icon">ğŸ‘¤</div>
            <div class="detail-content">
              <div class="detail-label">Patient Name</div>
              <div class="detail-value">{{ createdAppointment.patientName || (patient?.fullName || (patient?.firstName + ' ' + patient?.lastName)) }}</div>
            </div>
          </div>
          <div class="detail-card">
            <div class="detail-icon">ğŸ’‰</div>
            <div class="detail-content">
              <div class="detail-label">Vaccine</div>
              <div class="detail-value">{{ createdAppointment.vaccineName }}</div>
            </div>
          </div>
          <div class="detail-card">
            <div class="detail-icon">ğŸ”¢</div>
            <div class="detail-content">
              <div class="detail-label">Dose Number</div>
              <div class="detail-value">Dose {{ createdAppointment.doseNumber }}</div>
            </div>
          </div>
          <div class="detail-card">
            <div class="detail-icon">ğŸ“…</div>
            <div class="detail-content">
              <div class="detail-label">Appointment Date</div>
              <div class="detail-value">{{ createdAppointment.appointmentDate | date:'dd MMM yyyy' }}</div>
            </div>
          </div>
          <div class="detail-card" *ngIf="createdAppointment.appointmentTime">
            <div class="detail-icon">ğŸ•</div>
            <div class="detail-content">
              <div class="detail-label">Appointment Time</div>
              <div class="detail-value">{{ createdAppointment.appointmentTime }}</div>
            </div>
          </div>
          <div class="detail-card" *ngIf="createdAppointment.facilityName">
            <div class="detail-icon">ğŸ¥</div>
            <div class="detail-content">
              <div class="detail-label">Facility</div>
              <div class="detail-value">{{ createdAppointment.facilityName }}</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer success-footer">
        <button type="button" class="btn btn-primary" (click)="showSuccessModal = false">
          <span>âœ“</span> Got it
        </button>
      </div>
    </div>
  </div>
</app-layout>

