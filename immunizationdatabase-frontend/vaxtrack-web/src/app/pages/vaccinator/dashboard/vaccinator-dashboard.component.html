<app-layout pageTitle="Vaccinator Dashboard" pageSubtitle="Welcome back! Here's your overview for today">
  <div class="vaccinator-dashboard">
    <app-alert 
      *ngIf="errorMessage" 
      type="error" 
      [message]="errorMessage"
      [show]="!!errorMessage">
    </app-alert>

    <!-- Patient Search Bar -->
    <div class="dashboard-search-section">
      <div class="search-bar-container">
        <span class="search-icon">ğŸ”</span>
        <input
          type="text"
          class="search-input"
          placeholder="Search patients by name, ID, or village..."
          [(ngModel)]="patientSearchQuery"
          (input)="onPatientSearch()"
          [ngModelOptions]="{standalone: true}">
        <button class="btn btn-primary" *ngIf="patientSearchQuery.trim()" (click)="clearSearch()">Clear</button>
      </div>

      <!-- Search Results Dropdown -->
      <div class="quick-search-results" *ngIf="patientSearchQuery.trim().length >= 2 && (searching || searchResults.length > 0 || showNoResults)">
        <div *ngIf="searching" class="search-loading">
          <span class="loading-spinner">â³</span>
          <span>Searching...</span>
        </div>
        <div *ngIf="!searching && searchResults.length > 0" class="search-results-list">
          <div
            *ngFor="let patient of searchResults"
            class="quick-result-item"
            [routerLink]="['/vaccinator/patients', patient.id || patient.patientId]"
            (click)="selectSearchResult(patient)">
            <div class="result-avatar">{{ getPatientDisplayName(patient)[0] }}</div>
            <div class="result-info">
              <div class="result-name">{{ getPatientDisplayName(patient) }}</div>
              <div class="result-details">
                <span>Age: {{ getPatientAgeFromDate(patient.birthDate || patient.dateOfBirth) }}</span>
                <span class="separator">â€¢</span>
                <span>Village: {{ patient.village || patient.address || 'N/A' }}</span>
                <span class="separator">â€¢</span>
                <span>Last Vaccination: {{ getLastVaccinationDate(patient) }}</span>
              </div>
            </div>
            <div class="result-action">â†’</div>
          </div>
        </div>
        <div *ngIf="!searching && searchResults.length === 0 && showNoResults" class="no-results-message">
          <div class="no-results-icon">ğŸ”</div>
          <p>No patients found matching "{{ patientSearchQuery }}"</p>
        </div>
      </div>
    </div>

    <!-- Top Stats Row -->
    <div class="stats-row">
      <div class="stat-card stat-primary">
        <div class="stat-header">
          <div class="stat-icon">ğŸ“…</div>
          <div class="stat-label">Today's Appointments</div>
        </div>
        <div class="stat-value">{{ todayAppointments.length }}</div>
        <div class="stat-trend positive">â†‘ 12% vs yesterday</div>
        <a [routerLink]="['/vaccinator/appointments']" class="stat-link">View All â†’</a>
      </div>
      <div class="stat-card stat-success">
        <div class="stat-header">
          <div class="stat-icon">ğŸ‘¥</div>
          <div class="stat-label">Patients Registered</div>
        </div>
        <div class="stat-value">{{ totalPatients | number }}</div>
        <div class="stat-trend">This Month</div>
      </div>
      <div class="stat-card stat-info">
        <div class="stat-header">
          <div class="stat-icon">ğŸ’‰</div>
          <div class="stat-label">Vaccinations Recorded</div>
        </div>
        <div class="stat-value">{{ vaccinationsThisWeek }}</div>
        <div class="stat-trend">This Week</div>
      </div>
      <div class="stat-card" [ngClass]="getStockCardClass()">
        <div class="stat-header">
          <div class="stat-icon">ğŸ“¦</div>
          <div class="stat-label">Stock Status</div>
        </div>
        <div class="stat-value" [ngClass]="stockStatusClass">{{ stockStatusText }}</div>
        <div class="stat-trend" *ngIf="lowStockVaccines.length > 0" [ngClass]="{'warning': lowStockVaccines.length > 0}">{{ lowStockVaccines.length }} items low</div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content-grid">
      <!-- Left Column: Today's Appointments -->
      <div class="left-column">
        <div class="section-card">
          <div class="section-header">
            <h3 class="section-title">Today's Appointments</h3>
            <a [routerLink]="['/vaccinator/appointments']" class="view-all-link">View All â†’</a>
          </div>
          <div class="filter-tabs">
            <button 
              class="filter-tab" 
              [class.active]="appointmentFilter === 'all'"
              (click)="appointmentFilter = 'all'">All</button>
            <button 
              class="filter-tab" 
              [class.active]="appointmentFilter === 'morning'"
              (click)="appointmentFilter = 'morning'">Morning</button>
            <button 
              class="filter-tab" 
              [class.active]="appointmentFilter === 'afternoon'"
              (click)="appointmentFilter = 'afternoon'">Afternoon</button>
            <button 
              class="filter-tab" 
              [class.active]="appointmentFilter === 'completed'"
              (click)="appointmentFilter = 'completed'">Completed</button>
          </div>
          <div class="appointments-list">
            <div *ngFor="let appointment of todayAppointments" class="appointment-card">
              <div class="appointment-avatar">{{ (appointment.patientName || 'P')[0] }}</div>
              <div class="appointment-info">
                <div class="appointment-name">{{ appointment.patientName || 'Patient' }} ({{ getPatientAge(appointment) }})</div>
                <div class="appointment-details">
                  <span>Parent: {{ appointment.guardianName || 'N/A' }}</span>
                  <span class="separator">â€¢</span>
                  <span>Phone: {{ appointment.guardianPhone || 'N/A' }}</span>
                </div>
                <div class="appointment-vaccine">Vaccine Due: {{ appointment.vaccineName || 'N/A' }}</div>
                <div class="appointment-time">Scheduled: {{ appointment.appointmentTime || 'All Day' }}</div>
              </div>
              <div class="appointment-actions">
                <a [routerLink]="['/vaccinator/patients', appointment.patientId]" class="btn-action-sm">View</a>
                <a [routerLink]="['/vaccinator/vaccinations/record', appointment.patientId]" class="btn-action-sm btn-primary">Record</a>
              </div>
            </div>
            <div *ngIf="todayAppointments.length === 0" class="empty-state">
              <div class="empty-icon">ğŸ“…</div>
              <p>No appointments scheduled for today</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Quick Actions -->
      <div class="right-column">
        <div class="quick-actions-container">
          <h3 class="quick-actions-title">Quick Actions</h3>
          <div class="quick-actions-group">
            <div class="quick-actions-row">
              <a routerLink="/vaccinator/patients/register" class="action-card">
                <div class="action-icon">â•</div>
                <div class="action-label">Register New Patient</div>
              </a>
              <a routerLink="/vaccinator/vaccinations/record" class="action-card">
                <div class="action-icon">ğŸ’‰</div>
                <div class="action-label">Record Vaccination</div>
              </a>
            </div>
            <div class="quick-actions-row">
              <a routerLink="/vaccinator/patients/search" class="action-card">
                <div class="action-icon">ğŸ”</div>
                <div class="action-label">Search Patient</div>
              </a>
              <a routerLink="/vaccinator/appointments" class="action-card">
                <div class="action-icon">ğŸ“…</div>
                <div class="action-label">View Appointments</div>
              </a>
            </div>
            <div class="quick-actions-row">
              <a routerLink="/vaccinator/stock" class="action-card">
                <div class="action-icon">ğŸ“¦</div>
                <div class="action-label">Check Stock</div>
              </a>
              <a routerLink="/vaccinator/vaccinations" class="action-card">
                <div class="action-icon">ğŸ“Š</div>
                <div class="action-label">View History</div>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Patients and Stock Section -->
    <div class="patients-stock-section">
      <div class="section-card">
        <div class="section-header">
          <h3 class="section-title">Recent Patients</h3>
          <a routerLink="/vaccinator/patients" class="view-all-link">View All â†’</a>
        </div>
        <div class="patients-list">
          <div *ngFor="let patient of recentPatients" class="patient-item" [routerLink]="['/vaccinator/patients', patient.id]">
            <div class="patient-avatar">{{ getPatientDisplayName(patient)[0] }}</div>
            <div class="patient-info">
              <div class="patient-name">{{ getPatientDisplayName(patient) }}</div>
              <div class="patient-details">
                <span>{{ getPatientAgeFromDate(patient.birthDate || patient.dateOfBirth) }}</span>
                <span class="separator">â€¢</span>
                <span>{{ patient.guardianName || 'N/A' }}</span>
              </div>
              <div class="patient-contact">
                <span>{{ patient.guardianPhone || patient.phoneNumber || 'N/A' }}</span>
                <span class="separator">â€¢</span>
                <span>Last: {{ getLastVaccination(patient) }}</span>
              </div>
            </div>
            <div class="patient-action">â†’</div>
          </div>
          <div *ngIf="recentPatients.length === 0" class="empty-state">
            <div class="empty-icon">ğŸ‘¥</div>
            <p>No recent patients</p>
            <a routerLink="/vaccinator/patients/register" class="btn btn-primary">Register New Patient</a>
          </div>
        </div>
      </div>

      <div class="section-card">
        <div class="section-header">
          <h3 class="section-title">Stock Levels</h3>
          <a routerLink="/vaccinator/stock" class="view-all-link">View All â†’</a>
        </div>
        <div class="stock-list">
          <div *ngFor="let vaccine of lowStockVaccines" class="stock-item">
            <div class="stock-header">
              <span class="vaccine-name">{{ vaccine.vaccineName }}</span>
              <span class="stock-badge" [ngClass]="getStockStatusClass(vaccine.status)">
                {{ vaccine.status }}
              </span>
            </div>
            <div class="stock-bar">
              <div class="stock-fill" [ngClass]="getStockStatusClass(vaccine.status)" [style.width.%]="getStockPercentage(vaccine)"></div>
            </div>
            <div class="stock-details">
              <span class="stock-quantity">{{ vaccine.totalQuantity }} doses</span>
              <span class="stock-alert" *ngIf="vaccine.status === 'LOW' || vaccine.status === 'CRITICAL'">
                {{ vaccine.status === 'CRITICAL' ? 'âš ï¸ Critical' : 'âš¡ Low' }}
              </span>
            </div>
          </div>
          <div *ngIf="lowStockVaccines.length === 0" class="empty-state">
            <div class="empty-icon">âœ…</div>
            <p>All vaccines are well stocked</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Vaccinations and Sync Status -->
    <div class="vaccinations-sync-section">
      <div class="section-card">
        <div class="section-header">
          <h3 class="section-title">Recent Vaccinations</h3>
          <a routerLink="/vaccinator/vaccinations" class="view-all-link">View All â†’</a>
        </div>
        <div class="vaccinations-list">
          <div *ngFor="let vaccination of recentVaccinations" class="vaccination-item">
            <div class="vaccination-avatar">ğŸ’‰</div>
            <div class="vaccination-info">
              <div class="vaccination-name">{{ vaccination.patientName || 'Patient' }}</div>
              <div class="vaccination-details">
                <span>{{ vaccination.vaccineName }}</span>
                <span class="separator">â€¢</span>
                <span>{{ vaccination.date }}</span>
              </div>
            </div>
            <div class="vaccination-status">âœ“</div>
          </div>
          <div *ngIf="recentVaccinations.length === 0" class="empty-state">
            <div class="empty-icon">ğŸ’‰</div>
            <p>No recent vaccinations</p>
          </div>
        </div>
      </div>

      <div class="section-card sync-card">
        <div class="sync-content">
          <div class="sync-icon">âœ“</div>
          <div class="sync-info">
            <div class="sync-title">All synced</div>
            <div class="sync-time">Last sync: {{ lastSyncTime || '2 min ago' }}</div>
          </div>
          <button class="btn-sync">Sync Now</button>
        </div>
      </div>
    </div>

    <app-loader *ngIf="loading"></app-loader>
  </div>
</app-layout>
