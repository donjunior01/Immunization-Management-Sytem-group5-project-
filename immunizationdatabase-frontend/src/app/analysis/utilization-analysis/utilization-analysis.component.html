<div class="utilization-analysis-container">
  <!-- Page Header -->
  <mat-card class="page-header">
    <div class="header-content">
      <div class="icon-wrapper">
        <mat-icon>analytics</mat-icon>
      </div>
      <div class="header-text">
        <h1>Vaccine Utilization Analysis</h1>
        <p>Usage patterns, efficiency metrics, and optimization insights</p>
      </div>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="generateUtilizationReport()">
        <mat-icon>assessment</mat-icon>
        Generate Report
      </button>
      <button mat-icon-button [matMenuTriggerFor]="actionsMenu">
        <mat-icon>more_vert</mat-icon>
      </button>
      <mat-menu #actionsMenu="matMenu">
        <button mat-menu-item [matMenuTriggerFor]="exportMenu">
          <mat-icon>download</mat-icon>
          <span>Export Data</span>
        </button>
      </mat-menu>
      <mat-menu #exportMenu="matMenu">
        <button mat-menu-item (click)="exportUtilization('csv')">
          <mat-icon>table_chart</mat-icon>
          <span>Export as CSV</span>
        </button>
        <button mat-menu-item (click)="exportUtilization('json')">
          <mat-icon>code</mat-icon>
          <span>Export as JSON</span>
        </button>
        <button mat-menu-item (click)="exportUtilization('pdf')">
          <mat-icon>picture_as_pdf</mat-icon>
          <span>Export as PDF</span>
        </button>
      </mat-menu>
    </div>
  </mat-card>

  <!-- Statistics Overview -->
  <div class="stats-overview">
    <div class="stats-grid">
      <mat-card class="stat-card">
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>vaccines</mat-icon>
          </div>
          <div class="stat-details">
            <div class="stat-value">{{ stats.totalVaccinesAnalyzed }}</div>
            <div class="stat-label">Vaccines Analyzed</div>
          </div>
        </div>
      </mat-card>

      <mat-card class="stat-card">
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>trending_up</mat-icon>
          </div>
          <div class="stat-details">
            <div class="stat-value" 
                 [class.excellent]="stats.averageUtilizationRate >= 85"
                 [class.good]="stats.averageUtilizationRate >= 70 && stats.averageUtilizationRate < 85"
                 [class.fair]="stats.averageUtilizationRate >= 50 && stats.averageUtilizationRate < 70"
                 [class.poor]="stats.averageUtilizationRate < 50">
              {{ stats.averageUtilizationRate }}%
            </div>
            <div class="stat-label">Avg Utilization Rate</div>
          </div>
        </div>
      </mat-card>

      <mat-card class="stat-card">
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>delete_outline</mat-icon>
          </div>
          <div class="stat-details">
            <div class="stat-value"
                 [class.excellent]="stats.averageWastageRate < 5"
                 [class.good]="stats.averageWastageRate >= 5 && stats.averageWastageRate < 10"
                 [class.fair]="stats.averageWastageRate >= 10 && stats.averageWastageRate < 15"
                 [class.poor]="stats.averageWastageRate >= 15">
              {{ stats.averageWastageRate }}%
            </div>
            <div class="stat-label">Avg Wastage Rate</div>
          </div>
        </div>
      </mat-card>

      <mat-card class="stat-card success">
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>star</mat-icon>
          </div>
          <div class="stat-details">
            <div class="stat-value">{{ stats.excellentPerformance }}</div>
            <div class="stat-label">Excellent Performance</div>
          </div>
        </div>
      </mat-card>

      <mat-card class="stat-card info">
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>medication</mat-icon>
          </div>
          <div class="stat-details">
            <div class="stat-value">{{ formatNumber(stats.totalDosesAdministered) }}</div>
            <div class="stat-label">Total Doses Administered</div>
          </div>
        </div>
      </mat-card>

      <mat-card class="stat-card warning">
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>warning</mat-icon>
          </div>
          <div class="stat-details">
            <div class="stat-value">{{ formatNumber(stats.totalDosesWasted) }}</div>
            <div class="stat-label">Total Doses Wasted</div>
          </div>
        </div>
      </mat-card>
    </div>
  </div>

  <!-- Utilization Trends Chart -->
  <mat-card class="trends-card">
    <h2>
      <mat-icon>show_chart</mat-icon>
      Utilization Trends
    </h2>
    <div class="trends-chart">
      <div class="chart-grid">
        <div class="chart-label" *ngFor="let trend of trendData">{{ trend.month }}</div>
      </div>
      <div class="chart-lines">
        <div class="utilization-line" 
             *ngFor="let trend of trendData; let i = index"
             [style.left.%]="(i / (trendData.length - 1)) * 100"
             [style.bottom.%]="trend.utilization"></div>
        <div class="wastage-line"
             *ngFor="let trend of trendData; let i = index"
             [style.left.%]="(i / (trendData.length - 1)) * 100"
             [style.bottom.%]="trend.wastage"></div>
      </div>
      <div class="chart-legend">
        <div class="legend-item">
          <div class="legend-color utilization"></div>
          <span>Utilization Rate</span>
        </div>
        <div class="legend-item">
          <div class="legend-color wastage"></div>
          <span>Wastage Rate</span>
        </div>
      </div>
    </div>
  </mat-card>

  <!-- Vaccine Performance Analysis -->
  <mat-card class="performance-card">
    <h2>
      <mat-icon>leaderboard</mat-icon>
      Vaccine Performance Analysis
    </h2>
    <div class="performance-grid">
      <div class="performance-item" *ngFor="let vaccine of vaccinePerformance.slice(0, 6)">
        <div class="performance-header">
          <h3>{{ vaccine.vaccineName }}</h3>
          <mat-chip [color]="getTrendColor(vaccine.trend)">
            <mat-icon>{{ vaccine.trend === 'Increasing' ? 'trending_up' : vaccine.trend === 'Decreasing' ? 'trending_down' : 'trending_flat' }}</mat-icon>
            {{ vaccine.trend }}
          </mat-chip>
        </div>
        <div class="performance-metrics">
          <div class="metric">
            <span class="metric-label">Utilization:</span>
            <span class="metric-value" 
                  [class.excellent]="vaccine.utilizationRate >= 85"
                  [class.good]="vaccine.utilizationRate >= 70 && vaccine.utilizationRate < 85"
                  [class.fair]="vaccine.utilizationRate >= 50 && vaccine.utilizationRate < 70"
                  [class.poor]="vaccine.utilizationRate < 50">
              {{ vaccine.utilizationRate }}%
            </span>
          </div>
          <div class="metric">
            <span class="metric-label">Wastage:</span>
            <span class="metric-value"
                  [class.excellent]="vaccine.wastageRate < 5"
                  [class.good]="vaccine.wastageRate >= 5 && vaccine.wastageRate < 10"
                  [class.fair]="vaccine.wastageRate >= 10 && vaccine.wastageRate < 15"
                  [class.poor]="vaccine.wastageRate >= 15">
              {{ vaccine.wastageRate }}%
            </span>
          </div>
          <div class="metric">
            <span class="metric-label">Efficiency Score:</span>
            <span class="metric-value score">{{ vaccine.efficiencyScore }}</span>
          </div>
        </div>
        <div class="performance-recommendation">
          <mat-icon>lightbulb</mat-icon>
          <p>{{ vaccine.recommendation }}</p>
        </div>
      </div>
    </div>
  </mat-card>

  <!-- Facility Comparison -->
  <mat-card class="comparison-card">
    <h2>
      <mat-icon>compare_arrows</mat-icon>
      Facility Performance Comparison
    </h2>
    <div class="comparison-table">
      <table>
        <thead>
          <tr>
            <th>Rank</th>
            <th>Facility</th>
            <th>Utilization Rate</th>
            <th>Wastage Rate</th>
            <th>Efficiency Score</th>
            <th>Doses Administered</th>
            <th>Performance</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let facility of facilityComparison" [class.top-performer]="facility.rank === 1">
            <td>
              <div class="rank-badge" [class.gold]="facility.rank === 1" [class.silver]="facility.rank === 2" [class.bronze]="facility.rank === 3">
                <mat-icon *ngIf="facility.rank === 1">emoji_events</mat-icon>
                <span *ngIf="facility.rank > 1">{{ facility.rank }}</span>
              </div>
            </td>
            <td>
              <strong>{{ facility.facilityName }}</strong>
              <div class="facility-id">{{ facility.facilityId }}</div>
            </td>
            <td>
              <span class="rate-value"
                    [class.excellent]="facility.utilizationRate >= 85"
                    [class.good]="facility.utilizationRate >= 70 && facility.utilizationRate < 85"
                    [class.fair]="facility.utilizationRate >= 50 && facility.utilizationRate < 70"
                    [class.poor]="facility.utilizationRate < 50">
                {{ facility.utilizationRate }}%
              </span>
            </td>
            <td>
              <span class="rate-value"
                    [class.excellent]="facility.wastageRate < 5"
                    [class.good]="facility.wastageRate >= 5 && facility.wastageRate < 10"
                    [class.fair]="facility.wastageRate >= 10 && facility.wastageRate < 15"
                    [class.poor]="facility.wastageRate >= 15">
                {{ facility.wastageRate }}%
              </span>
            </td>
            <td>
              <strong class="score">{{ facility.efficiencyScore }}</strong>
            </td>
            <td>{{ formatNumber(facility.totalDosesAdministered) }}</td>
            <td>
              <mat-chip [color]="getPerformanceColor(facility.performance)">{{ facility.performance }}</mat-chip>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </mat-card>

  <!-- Filters -->
  <mat-card class="filters-card">
    <h2>
      <mat-icon>filter_list</mat-icon>
      Filters
    </h2>
    <form [formGroup]="filterForm">
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Search</mat-label>
          <mat-icon matPrefix>search</mat-icon>
          <input matInput formControlName="search" placeholder="Search utilization data...">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Vaccine</mat-label>
          <mat-select formControlName="vaccineName">
            <mat-option value="">All Vaccines</mat-option>
            <mat-option *ngFor="let vaccine of vaccines" [value]="vaccine">{{ vaccine }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Facility</mat-label>
          <mat-select formControlName="facilityId">
            <mat-option value="">All Facilities</mat-option>
            <mat-option *ngFor="let facility of facilities" [value]="facility.id">{{ facility.name }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Status</mat-label>
          <mat-select formControlName="status">
            <mat-option value="">All Status</mat-option>
            <mat-option value="Excellent">Excellent</mat-option>
            <mat-option value="Good">Good</mat-option>
            <mat-option value="Fair">Fair</mat-option>
            <mat-option value="Poor">Poor</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Trend</mat-label>
          <mat-select formControlName="trend">
            <mat-option value="">All Trends</mat-option>
            <mat-option value="Increasing">Increasing</mat-option>
            <mat-option value="Stable">Stable</mat-option>
            <mat-option value="Decreasing">Decreasing</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Period Start</mat-label>
          <input matInput [matDatepicker]="pickerStart" formControlName="periodStart" placeholder="From">
          <mat-datepicker-toggle matIconSuffix [for]="pickerStart"></mat-datepicker-toggle>
          <mat-datepicker #pickerStart></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Period End</mat-label>
          <input matInput [matDatepicker]="pickerEnd" formControlName="periodEnd" placeholder="To">
          <mat-datepicker-toggle matIconSuffix [for]="pickerEnd"></mat-datepicker-toggle>
          <mat-datepicker #pickerEnd></mat-datepicker>
        </mat-form-field>

        <div class="filter-actions">
          <button mat-raised-button type="button" class="reset-button" (click)="resetFilters()">
            <mat-icon>clear</mat-icon>
            Reset
          </button>
        </div>
      </div>

      <div class="filter-results">
        <mat-icon>info</mat-icon>
        <span>{{ filteredUtilization.length }} records found</span>
      </div>
    </form>
  </mat-card>

  <!-- Utilization Table -->
  <mat-card class="table-card">
    <div class="table-container">
      <table mat-table [dataSource]="getPaginatedUtilization()" class="utilization-table">
        <!-- Vaccine Column -->
        <ng-container matColumnDef="vaccine">
          <th mat-header-cell *matHeaderCellDef>Vaccine</th>
          <td mat-cell *matCellDef="let element">
            <div class="vaccine-info">
              <div class="vaccine-name">{{ element.vaccineName }}</div>
            </div>
          </td>
        </ng-container>

        <!-- Facility Column -->
        <ng-container matColumnDef="facility">
          <th mat-header-cell *matHeaderCellDef>Facility</th>
          <td mat-cell *matCellDef="let element">
            <div class="facility-info">
              <div class="facility-name">{{ element.facilityName }}</div>
              <div class="facility-id">{{ element.facilityId }}</div>
            </div>
          </td>
        </ng-container>

        <!-- Period Column -->
        <ng-container matColumnDef="period">
          <th mat-header-cell *matHeaderCellDef>Period</th>
          <td mat-cell *matCellDef="let element">
            <div class="period-info">
              {{ element.period }}
            </div>
          </td>
        </ng-container>

        <!-- Utilization Column -->
        <ng-container matColumnDef="utilization">
          <th mat-header-cell *matHeaderCellDef>Utilization</th>
          <td mat-cell *matCellDef="let element">
            <div class="utilization-info">
              <div class="stock-detail">
                <span class="label">Total:</span>
                <span class="value">{{ formatNumber(element.totalStock) }}</span>
              </div>
              <div class="stock-detail">
                <span class="label">Administered:</span>
                <span class="value">{{ formatNumber(element.administered) }}</span>
              </div>
              <div class="utilization-rate"
                   [class.excellent]="element.utilizationRate >= 85"
                   [class.good]="element.utilizationRate >= 70 && element.utilizationRate < 85"
                   [class.fair]="element.utilizationRate >= 50 && element.utilizationRate < 70"
                   [class.poor]="element.utilizationRate < 50">
                {{ element.utilizationRate }}%
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Wastage Column -->
        <ng-container matColumnDef="wastage">
          <th mat-header-cell *matHeaderCellDef>Wastage</th>
          <td mat-cell *matCellDef="let element">
            <div class="wastage-info">
              <div class="stock-detail">
                <span class="label">Wasted:</span>
                <span class="value">{{ formatNumber(element.wastage) }}</span>
              </div>
              <div class="stock-detail">
                <span class="label">Expired:</span>
                <span class="value">{{ formatNumber(element.expired) }}</span>
              </div>
              <div class="wastage-rate"
                   [class.excellent]="element.wastageRate < 5"
                   [class.good]="element.wastageRate >= 5 && element.wastageRate < 10"
                   [class.fair]="element.wastageRate >= 10 && element.wastageRate < 15"
                   [class.poor]="element.wastageRate >= 15">
                {{ element.wastageRate }}%
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Efficiency Column -->
        <ng-container matColumnDef="efficiency">
          <th mat-header-cell *matHeaderCellDef>Efficiency Score</th>
          <td mat-cell *matCellDef="let element">
            <div class="efficiency-score">{{ element.efficiencyScore }}</div>
          </td>
        </ng-container>

        <!-- Trend Column -->
        <ng-container matColumnDef="trend">
          <th mat-header-cell *matHeaderCellDef>Trend</th>
          <td mat-cell *matCellDef="let element">
            <mat-chip [color]="getTrendColor(element.trend)">
              <mat-icon>{{ element.trend === 'Increasing' ? 'trending_up' : element.trend === 'Decreasing' ? 'trending_down' : 'trending_flat' }}</mat-icon>
              {{ element.trend }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let element">
            <mat-chip [color]="getStatusColor(element.status)">{{ element.status }}</mat-chip>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let element">
            <button mat-icon-button [matMenuTriggerFor]="menu">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="viewUtilizationDetails(element)">
                <mat-icon>visibility</mat-icon>
                <span>View Details</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>

    <mat-paginator 
      [length]="filteredUtilization.length"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizeOptions"
      (page)="handlePageEvent($event)"
      showFirstLastButtons>
    </mat-paginator>
  </mat-card>

  <!-- Detail Dialog -->
  <div class="dialog-overlay" *ngIf="showDetailDialog" (click)="closeDetailDialog()">
    <div class="dialog-container" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Utilization Details</h2>
        <button mat-icon-button (click)="closeDetailDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="dialog-content" *ngIf="selectedUtilization">
        <div class="detail-section">
          <h3>Basic Information</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Vaccine:</span>
              <span class="value">{{ selectedUtilization.vaccineName }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Facility:</span>
              <span class="value">{{ selectedUtilization.facilityName }} ({{ selectedUtilization.facilityId }})</span>
            </div>
            <div class="detail-item">
              <span class="label">Period:</span>
              <span class="value">{{ selectedUtilization.period }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Status:</span>
              <mat-chip [color]="getStatusColor(selectedUtilization.status)">{{ selectedUtilization.status }}</mat-chip>
            </div>
          </div>
        </div>

        <mat-divider></mat-divider>

        <div class="detail-section">
          <h3>Stock Details</h3>
          <div class="detail-grid">
            <div class="detail-item full-width">
              <span class="label">Total Stock:</span>
              <span class="value">{{ formatNumber(selectedUtilization.totalStock) }} doses</span>
            </div>
            <div class="detail-item">
              <span class="label">Administered:</span>
              <span class="value">{{ formatNumber(selectedUtilization.administered) }} doses</span>
            </div>
            <div class="detail-item">
              <span class="label">Wastage:</span>
              <span class="value">{{ formatNumber(selectedUtilization.wastage) }} doses</span>
            </div>
            <div class="detail-item">
              <span class="label">Expired:</span>
              <span class="value">{{ formatNumber(selectedUtilization.expired) }} doses</span>
            </div>
            <div class="detail-item">
              <span class="label">Remaining:</span>
              <span class="value">{{ formatNumber(selectedUtilization.remaining) }} doses</span>
            </div>
          </div>
        </div>

        <mat-divider></mat-divider>

        <div class="detail-section">
          <h3>Performance Metrics</h3>
          <div class="metrics-display">
            <div class="metric-card">
              <div class="metric-label">Utilization Rate</div>
              <div class="metric-value"
                   [class.excellent]="selectedUtilization.utilizationRate >= 85"
                   [class.good]="selectedUtilization.utilizationRate >= 70 && selectedUtilization.utilizationRate < 85"
                   [class.fair]="selectedUtilization.utilizationRate >= 50 && selectedUtilization.utilizationRate < 70"
                   [class.poor]="selectedUtilization.utilizationRate < 50">
                {{ selectedUtilization.utilizationRate }}%
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Wastage Rate</div>
              <div class="metric-value"
                   [class.excellent]="selectedUtilization.wastageRate < 5"
                   [class.good]="selectedUtilization.wastageRate >= 5 && selectedUtilization.wastageRate < 10"
                   [class.fair]="selectedUtilization.wastageRate >= 10 && selectedUtilization.wastageRate < 15"
                   [class.poor]="selectedUtilization.wastageRate >= 15">
                {{ selectedUtilization.wastageRate }}%
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Efficiency Score</div>
              <div class="metric-value score">{{ selectedUtilization.efficiencyScore }}</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Trend</div>
              <mat-chip [color]="getTrendColor(selectedUtilization.trend)">
                <mat-icon>{{ selectedUtilization.trend === 'Increasing' ? 'trending_up' : selectedUtilization.trend === 'Decreasing' ? 'trending_down' : 'trending_flat' }}</mat-icon>
                {{ selectedUtilization.trend }}
              </mat-chip>
            </div>
          </div>
        </div>
      </div>

      <div class="dialog-actions">
        <button mat-raised-button (click)="closeDetailDialog()">Close</button>
      </div>
    </div>
  </div>
</div>
