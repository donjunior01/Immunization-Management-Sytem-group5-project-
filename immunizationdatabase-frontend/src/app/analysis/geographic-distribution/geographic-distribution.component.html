<div class="geographic-distribution-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="icon-wrapper">
        <mat-icon>map</mat-icon>
      </div>
      <div class="header-text">
        <h1>Geographic Distribution Analysis</h1>
        <p>Analyze immunization coverage and performance across hierarchical geographic locations</p>
      </div>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="generateReport()">
        <mat-icon>description</mat-icon>
        Generate Report
      </button>
      <button mat-button [matMenuTriggerFor]="actionsMenu">
        <mat-icon>more_vert</mat-icon>
      </button>
      <mat-menu #actionsMenu="matMenu">
        <button mat-menu-item [matMenuTriggerFor]="exportMenu">
          <mat-icon>file_download</mat-icon>
          Export Data
        </button>
      </mat-menu>
      <mat-menu #exportMenu="matMenu">
        <button mat-menu-item (click)="exportData('csv')">
          <mat-icon>insert_drive_file</mat-icon>
          Export as CSV
        </button>
        <button mat-menu-item (click)="exportData('json')">
          <mat-icon>code</mat-icon>
          Export as JSON
        </button>
        <button mat-menu-item (click)="exportData('pdf')">
          <mat-icon>picture_as_pdf</mat-icon>
          Export as PDF
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- Statistics Overview -->
  <div class="stats-overview">
    <div class="stats-grid">
      <mat-card class="stat-card">
        <div class="stat-icon">
          <mat-icon>location_on</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-label">Total Locations</div>
          <div class="stat-value">{{ stats.totalLocations }}</div>
        </div>
      </mat-card>

      <mat-card class="stat-card">
        <div class="stat-icon">
          <mat-icon>local_hospital</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-label">Total Facilities</div>
          <div class="stat-value">{{ stats.totalFacilities }}</div>
        </div>
      </mat-card>

      <mat-card class="stat-card">
        <div class="stat-icon">
          <mat-icon>people</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-label">Total Population</div>
          <div class="stat-value">{{ formatNumber(stats.totalPopulation) }}</div>
        </div>
      </mat-card>

      <mat-card class="stat-card">
        <div class="stat-icon">
          <mat-icon>show_chart</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-label">Average Coverage</div>
          <div class="stat-value">{{ formatPercentage(stats.averageCoverage) }}</div>
        </div>
      </mat-card>

      <mat-card class="stat-card excellent">
        <div class="stat-icon">
          <mat-icon>star</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-label">Excellent Locations</div>
          <div class="stat-value">{{ stats.excellentLocations }}</div>
        </div>
      </mat-card>

      <mat-card class="stat-card good">
        <div class="stat-icon">
          <mat-icon>thumb_up</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-label">Good Locations</div>
          <div class="stat-value">{{ stats.goodLocations }}</div>
        </div>
      </mat-card>

      <mat-card class="stat-card fair">
        <div class="stat-icon">
          <mat-icon>report</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-label">Fair Locations</div>
          <div class="stat-value">{{ stats.fairLocations }}</div>
        </div>
      </mat-card>

      <mat-card class="stat-card poor">
        <div class="stat-icon">
          <mat-icon>warning</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-label">Poor Locations</div>
          <div class="stat-value">{{ stats.poorLocations }}</div>
        </div>
      </mat-card>
    </div>
  </div>

  <!-- View Selector -->
  <mat-card class="view-selector-card">
    <div class="view-selector">
      <button 
        mat-raised-button 
        [color]="selectedView === 'hierarchy' ? 'primary' : ''"
        (click)="changeView('hierarchy')">
        <mat-icon>account_tree</mat-icon>
        Hierarchy View
      </button>
      <button 
        mat-raised-button 
        [color]="selectedView === 'comparison' ? 'primary' : ''"
        (click)="changeView('comparison')">
        <mat-icon>compare_arrows</mat-icon>
        Regional Comparison
      </button>
      <button 
        mat-raised-button 
        [color]="selectedView === 'performance' ? 'primary' : ''"
        (click)="changeView('performance')">
        <mat-icon>analytics</mat-icon>
        Performance Analysis
      </button>
    </div>
  </mat-card>

  <!-- Regional Comparison View -->
  <mat-card class="comparison-card" *ngIf="selectedView === 'comparison'">
    <mat-card-header>
      <mat-icon mat-card-avatar>compare_arrows</mat-icon>
      <mat-card-title>Regional Performance Comparison</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="comparison-grid">
        <div class="comparison-item" *ngFor="let region of regionalComparison">
          <div class="comparison-header">
            <h3>{{ region.regionName }}</h3>
            <span class="rank-badge">Rank #{{ region.rank - 1 }}</span>
          </div>
          <div class="comparison-metrics">
            <div class="metric">
              <span class="metric-label">Coverage Rate</span>
              <span class="metric-value" [style.color]="region.coverage >= 85 ? '#4caf50' : region.coverage >= 75 ? '#ff9800' : '#f44336'">
                {{ formatPercentage(region.coverage) }}
              </span>
            </div>
            <div class="metric">
              <span class="metric-label">Population</span>
              <span class="metric-value">{{ formatNumber(region.population) }}</span>
            </div>
            <div class="metric">
              <span class="metric-label">Facilities</span>
              <span class="metric-value">{{ region.facilities }}</span>
            </div>
            <div class="metric">
              <span class="metric-label">Vaccinations</span>
              <span class="metric-value">{{ formatNumber(region.vaccinations) }}</span>
            </div>
            <div class="metric">
              <span class="metric-label">Performance Score</span>
              <span class="metric-value highlight">{{ region.performanceScore.toFixed(1) }}</span>
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Performance Analysis View -->
  <mat-card class="performance-card" *ngIf="selectedView === 'performance'">
    <mat-card-header>
      <mat-icon mat-card-avatar>analytics</mat-icon>
      <mat-card-title>District Performance Analysis</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="performance-grid">
        <div class="performance-item" *ngFor="let district of districtPerformance.slice(0, 10)">
          <div class="performance-header">
            <div>
              <h4>{{ district.districtName }}</h4>
              <p class="region-name">{{ district.regionName }}</p>
            </div>
            <mat-chip [color]="getStatusColor(district.status)" selected>
              {{ district.status }}
            </mat-chip>
          </div>
          <div class="performance-metrics">
            <div class="metric-row">
              <span>Coverage:</span>
              <span class="value">{{ formatPercentage(district.coverage) }}</span>
            </div>
            <div class="metric-row">
              <span>Facilities:</span>
              <span class="value">{{ district.facilities }}</span>
            </div>
            <div class="metric-row">
              <span>Population:</span>
              <span class="value">{{ formatNumber(district.population) }}</span>
            </div>
            <div class="metric-row">
              <span>Performance:</span>
              <span class="value highlight">{{ district.performanceScore.toFixed(1) }}</span>
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Filters Card (for Hierarchy View) -->
  <mat-card class="filters-card" *ngIf="selectedView === 'hierarchy'">
    <mat-card-header>
      <mat-icon mat-card-avatar>filter_list</mat-icon>
      <mat-card-title>Filter Locations</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="filterForm" class="filter-form">
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Search</mat-label>
            <input matInput formControlName="search" placeholder="Search by name or code">
            <mat-icon matPrefix>search</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Level</mat-label>
            <mat-select formControlName="level">
              <mat-option *ngFor="let level of levels" [value]="level">{{ level }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Region</mat-label>
            <mat-select formControlName="region">
              <mat-option value="All">All Regions</mat-option>
              <mat-option *ngFor="let region of regions" [value]="region">{{ region }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Status</mat-label>
            <mat-select formControlName="status">
              <mat-option *ngFor="let status of statuses" [value]="status">{{ status }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Trend</mat-label>
            <mat-select formControlName="trend">
              <mat-option *ngFor="let trend of trends" [value]="trend">{{ trend }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Min Coverage %</mat-label>
            <input matInput type="number" formControlName="minCoverage" placeholder="Min coverage">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Max Coverage %</mat-label>
            <input matInput type="number" formControlName="maxCoverage" placeholder="Max coverage">
          </mat-form-field>
        </div>
        
        <div class="filter-actions">
          <button mat-raised-button type="button" class="reset-button" (click)="resetFilters()">
            <mat-icon>refresh</mat-icon>
            Reset Filters
          </button>
          <div class="filter-results">
            Showing {{ filteredLocations.length }} of {{ locations.length }} locations
          </div>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Locations Table (Hierarchy View) -->
  <mat-card class="table-card" *ngIf="selectedView === 'hierarchy'">
    <mat-card-header>
      <mat-icon mat-card-avatar>table_chart</mat-icon>
      <mat-card-title>Geographic Locations</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <table mat-table [dataSource]="getPaginatedLocations()" class="locations-table">
        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Location</th>
          <td mat-cell *matCellDef="let location">
            <div class="location-info">
              <mat-icon class="type-icon">{{ getTypeIcon(location.type) }}</mat-icon>
              <div class="location-details">
                <div class="location-name">{{ location.name }}</div>
                <div class="location-code">{{ location.code }}</div>
                <div class="location-parent" *ngIf="location.parentName">
                  <mat-icon>subdirectory_arrow_right</mat-icon>
                  {{ location.parentName }}
                </div>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Type Column -->
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef>Level</th>
          <td mat-cell *matCellDef="let location">
            <mat-chip>{{ location.type }}</mat-chip>
          </td>
        </ng-container>

        <!-- Population Column -->
        <ng-container matColumnDef="population">
          <th mat-header-cell *matHeaderCellDef>Population</th>
          <td mat-cell *matCellDef="let location">
            <div class="population-info">
              <div class="pop-value">{{ formatNumber(location.population) }}</div>
              <div class="pop-target">Target: {{ formatNumber(location.targetPopulation) }}</div>
              <div class="pop-vaccinated">Vaccinated: {{ formatNumber(location.vaccinesAdministered) }}</div>
            </div>
          </td>
        </ng-container>

        <!-- Facilities Column -->
        <ng-container matColumnDef="facilities">
          <th mat-header-cell *matHeaderCellDef>Resources</th>
          <td mat-cell *matCellDef="let location">
            <div class="resource-info">
              <div class="resource-item">
                <mat-icon>local_hospital</mat-icon>
                <span>{{ location.facilities }}</span>
              </div>
              <div class="resource-item">
                <mat-icon>people</mat-icon>
                <span>{{ location.healthWorkers }}</span>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Coverage Column -->
        <ng-container matColumnDef="coverage">
          <th mat-header-cell *matHeaderCellDef>Coverage</th>
          <td mat-cell *matCellDef="let location">
            <div class="coverage-info">
              <div class="coverage-rate" 
                   [style.color]="location.coverageRate >= 90 ? '#4caf50' : location.coverageRate >= 80 ? '#2196f3' : location.coverageRate >= 70 ? '#ff9800' : '#f44336'">
                {{ formatPercentage(location.coverageRate) }}
              </div>
              <div class="trend-indicator">
                <mat-icon [style.color]="getTrendColor(location.trend)">
                  {{ getTrendIcon(location.trend) }}
                </mat-icon>
                <span>{{ location.trend }}</span>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Performance Column -->
        <ng-container matColumnDef="performance">
          <th mat-header-cell *matHeaderCellDef>Performance</th>
          <td mat-cell *matCellDef="let location">
            <div class="performance-info">
              <div class="performance-score">{{ location.performanceScore.toFixed(1) }}</div>
              <div class="performance-rank">Rank #{{ location.rank }}</div>
            </div>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let location">
            <mat-chip [color]="getStatusColor(location.status)" selected>
              {{ location.status }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let location">
            <button mat-icon-button [matMenuTriggerFor]="locationMenu">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #locationMenu="matMenu">
              <button mat-menu-item (click)="viewLocationDetails(location)">
                <mat-icon>visibility</mat-icon>
                View Details
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <mat-paginator
        [length]="filteredLocations.length"
        [pageSize]="pageSize"
        [pageSizeOptions]="pageSizeOptions"
        [pageIndex]="pageIndex"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    </mat-card-content>
  </mat-card>

  <!-- Location Details Dialog -->
  <div class="dialog-overlay" *ngIf="showDetailDialog" (click)="closeDetailDialog()">
    <div class="dialog-container" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Location Details</h2>
        <button mat-icon-button (click)="closeDetailDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="dialog-content" *ngIf="selectedLocation">
        <!-- Basic Information -->
        <div class="detail-section">
          <h3>Basic Information</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Location Name:</span>
              <span class="value">{{ selectedLocation.name }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Code:</span>
              <span class="value">{{ selectedLocation.code }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Type:</span>
              <mat-chip>{{ selectedLocation.type }}</mat-chip>
            </div>
            <div class="detail-item">
              <span class="label">Level:</span>
              <span class="value">{{ selectedLocation.level }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedLocation.parentName">
              <span class="label">Parent Location:</span>
              <span class="value">{{ selectedLocation.parentName }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Status:</span>
              <mat-chip [color]="getStatusColor(selectedLocation.status)" selected>
                {{ selectedLocation.status }}
              </mat-chip>
            </div>
          </div>
        </div>

        <mat-divider></mat-divider>

        <!-- Population Metrics -->
        <div class="detail-section">
          <h3>Population Metrics</h3>
          <div class="metrics-display">
            <div class="metric-card">
              <mat-icon>people</mat-icon>
              <div class="metric-value">{{ formatNumber(selectedLocation.population) }}</div>
              <div class="metric-label">Total Population</div>
            </div>
            <div class="metric-card">
              <mat-icon>group</mat-icon>
              <div class="metric-value">{{ formatNumber(selectedLocation.targetPopulation) }}</div>
              <div class="metric-label">Target Population</div>
            </div>
            <div class="metric-card">
              <mat-icon>vaccines</mat-icon>
              <div class="metric-value">{{ formatNumber(selectedLocation.vaccinesAdministered) }}</div>
              <div class="metric-label">Vaccinations</div>
            </div>
            <div class="metric-card">
              <mat-icon>show_chart</mat-icon>
              <div class="metric-value" 
                   [style.color]="selectedLocation.coverageRate >= 90 ? '#4caf50' : selectedLocation.coverageRate >= 80 ? '#2196f3' : selectedLocation.coverageRate >= 70 ? '#ff9800' : '#f44336'">
                {{ formatPercentage(selectedLocation.coverageRate) }}
              </div>
              <div class="metric-label">Coverage Rate</div>
            </div>
          </div>
        </div>

        <mat-divider></mat-divider>

        <!-- Resource Metrics -->
        <div class="detail-section">
          <h3>Resource Metrics</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Facilities:</span>
              <span class="value">{{ selectedLocation.facilities }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Health Workers:</span>
              <span class="value">{{ selectedLocation.healthWorkers }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Performance Score:</span>
              <span class="value highlight">{{ selectedLocation.performanceScore.toFixed(1) }}</span>
            </div>
            <div class="detail-item">
              <span class="label">National Rank:</span>
              <span class="value">{{ selectedLocation.rank }}</span>
            </div>
          </div>
        </div>

        <mat-divider></mat-divider>

        <!-- Trend Analysis -->
        <div class="detail-section">
          <h3>Trend Analysis</h3>
          <div class="trend-details">
            <div class="trend-item">
              <mat-icon [style.color]="getTrendColor(selectedLocation.trend)">
                {{ getTrendIcon(selectedLocation.trend) }}
              </mat-icon>
              <span class="trend-label">Coverage Trend:</span>
              <span class="trend-value">{{ selectedLocation.trend }}</span>
            </div>
            <div class="trend-item">
              <mat-icon>schedule</mat-icon>
              <span class="trend-label">Last Updated:</span>
              <span class="trend-value">{{ selectedLocation.lastUpdated | date: 'medium' }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="dialog-actions">
        <button mat-button (click)="closeDetailDialog()">Close</button>
      </div>
    </div>
  </div>

  <!-- Top & Bottom Performers -->
  <div class="performers-section">
    <mat-card class="performer-card">
      <mat-card-header>
        <mat-icon mat-card-avatar class="top-icon">emoji_events</mat-icon>
        <mat-card-title>Top Performer</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="performer-name">{{ stats.topPerformer }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="performer-card">
      <mat-card-header>
        <mat-icon mat-card-avatar class="bottom-icon">trending_down</mat-icon>
        <mat-card-title>Needs Attention</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="performer-name">{{ stats.lowestPerformer }}</div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
