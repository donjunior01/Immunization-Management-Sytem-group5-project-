<div class="facility-management-container">
  <div class="page-header">
    <div class="header-content">
      <div class="icon-wrapper">
        <mat-icon>business</mat-icon>
      </div>
      <div>
        <h1>Facility Management</h1>
        <p>Manage healthcare facilities and distribution centers</p>
      </div>
    </div>
    <div class="header-actions">
      <button mat-stroked-button [matMenuTriggerFor]="exportMenu" matTooltip="Export facilities">
        <mat-icon>download</mat-icon> Export
      </button>
      <mat-menu #exportMenu="matMenu">
        <button mat-menu-item (click)="exportFacilities('csv')">
          <mat-icon>description</mat-icon> Export as CSV
        </button>
        <button mat-menu-item (click)="exportFacilities('json')">
          <mat-icon>code</mat-icon> Export as JSON
        </button>
        <button mat-menu-item (click)="exportFacilities('pdf')">
          <mat-icon>picture_as_pdf</mat-icon> Export as PDF
        </button>
      </mat-menu>
      <button mat-raised-button color="primary" (click)="openCreateForm()">
        <mat-icon>add</mat-icon> Add Facility
      </button>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <mat-card class="stat-card">
      <div class="stat-icon">
        <mat-icon>business</mat-icon>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ stats.total }}</span>
        <span class="stat-label">Total Facilities</span>
      </div>
    </mat-card>

    <mat-card class="stat-card">
      <div class="stat-icon active">
        <mat-icon>check_circle</mat-icon>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ stats.active }}</span>
        <span class="stat-label">Active</span>
      </div>
    </mat-card>

    <mat-card class="stat-card">
      <div class="stat-icon pending">
        <mat-icon>pending</mat-icon>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ stats.pending }}</span>
        <span class="stat-label">Pending</span>
      </div>
    </mat-card>

    <mat-card class="stat-card">
      <div class="stat-icon capacity">
        <mat-icon>inventory</mat-icon>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ stats.totalCapacity | number }}</span>
        <span class="stat-label">Total Capacity</span>
      </div>
    </mat-card>

    <mat-card class="stat-card">
      <div class="stat-icon utilization">
        <mat-icon>show_chart</mat-icon>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ stats.utilizationRate }}%</span>
        <span class="stat-label">Utilization Rate</span>
      </div>
    </mat-card>
  </div>

  <!-- Filters Card -->
  <mat-card class="filters-card">
    <h3><mat-icon>filter_list</mat-icon> Filters</h3>
    <form [formGroup]="filterForm">
      <div class="filters-grid">
        <mat-form-field appearance="outline">
          <mat-label>Search</mat-label>
          <input matInput formControlName="search" placeholder="Search by name, code, city...">
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Facility Type</mat-label>
          <mat-select formControlName="type">
            <mat-option value="">All Types</mat-option>
            <mat-option *ngFor="let type of facilityTypes" [value]="type">{{ type }}</mat-option>
          </mat-select>
          <mat-icon matPrefix>category</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Status</mat-label>
          <mat-select formControlName="status">
            <mat-option value="">All Statuses</mat-option>
            <mat-option *ngFor="let status of statusOptions" [value]="status">{{ status }}</mat-option>
          </mat-select>
          <mat-icon matPrefix>info</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>State</mat-label>
          <mat-select formControlName="state">
            <mat-option value="">All States</mat-option>
            <mat-option *ngFor="let state of stateOptions" [value]="state">{{ state }}</mat-option>
          </mat-select>
          <mat-icon matPrefix>map</mat-icon>
        </mat-form-field>
      </div>
      <div class="filter-actions">
        <button mat-stroked-button (click)="resetFilters()" type="button">
          <mat-icon>refresh</mat-icon> Reset Filters
        </button>
        <span class="results-count">{{ filteredFacilities.length }} facilities found</span>
      </div>
    </form>
  </mat-card>

  <!-- Facilities Table -->
  <mat-card class="table-card">
    <div class="table-container">
      <table mat-table [dataSource]="getPaginatedFacilities()" class="facilities-table">
        <!-- Code Column -->
        <ng-container matColumnDef="code">
          <th mat-header-cell *matHeaderCellDef>Code</th>
          <td mat-cell *matCellDef="let facility">
            <span class="facility-code">{{ facility.code }}</span>
          </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Facility Name</th>
          <td mat-cell *matCellDef="let facility">
            <div class="facility-name-cell">
              <strong>{{ facility.name }}</strong>
              <span class="facility-license">License: {{ facility.license }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Type Column -->
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef>Type</th>
          <td mat-cell *matCellDef="let facility">
            <mat-chip class="type-chip">{{ facility.type }}</mat-chip>
          </td>
        </ng-container>

        <!-- Location Column -->
        <ng-container matColumnDef="location">
          <th mat-header-cell *matHeaderCellDef>Location</th>
          <td mat-cell *matCellDef="let facility">
            <div class="location-cell">
              <span class="city">{{ facility.city }}, {{ facility.state }}</span>
              <span class="address">{{ facility.address }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Manager Column -->
        <ng-container matColumnDef="manager">
          <th mat-header-cell *matHeaderCellDef>Manager</th>
          <td mat-cell *matCellDef="let facility">
            <div class="manager-cell">
              <span class="manager-name">{{ facility.managerName }}</span>
              <span class="manager-email">{{ facility.managerEmail }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Capacity Column -->
        <ng-container matColumnDef="capacity">
          <th mat-header-cell *matHeaderCellDef>Capacity</th>
          <td mat-cell *matCellDef="let facility">
            <div class="capacity-cell">
              <div class="capacity-bar">
                <div class="capacity-fill" 
                     [style.width.%]="(facility.currentStock / facility.capacity) * 100"
                     [style.background-color]="getUtilizationColor(facility)"></div>
              </div>
              <span class="capacity-text">{{ facility.currentStock | number }} / {{ facility.capacity | number }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let facility">
            <mat-chip [class]="'status-' + facility.status.toLowerCase()">
              {{ facility.status }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let facility">
            <div class="action-buttons">
              <button mat-icon-button [matMenuTriggerFor]="actionsMenu" matTooltip="More actions">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #actionsMenu="matMenu">
                <button mat-menu-item (click)="viewDetails(facility)">
                  <mat-icon>visibility</mat-icon> View Details
                </button>
                <button mat-menu-item (click)="openEditForm(facility)">
                  <mat-icon>edit</mat-icon> Edit
                </button>
                <mat-divider></mat-divider>
                <button mat-menu-item (click)="updateStatus(facility, 'Active')" *ngIf="facility.status !== 'Active'">
                  <mat-icon>check_circle</mat-icon> Activate
                </button>
                <button mat-menu-item (click)="updateStatus(facility, 'Inactive')" *ngIf="facility.status !== 'Inactive'">
                  <mat-icon>cancel</mat-icon> Deactivate
                </button>
                <button mat-menu-item (click)="updateStatus(facility, 'Suspended')" *ngIf="facility.status !== 'Suspended'">
                  <mat-icon>block</mat-icon> Suspend
                </button>
                <mat-divider></mat-divider>
                <button mat-menu-item (click)="deleteFacility(facility)" class="delete-action">
                  <mat-icon>delete</mat-icon> Delete
                </button>
              </mat-menu>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell no-data" [attr.colspan]="displayedColumns.length">
            <mat-icon>inbox</mat-icon>
            <p>No facilities found</p>
          </td>
        </tr>
      </table>
    </div>

    <mat-paginator
      [length]="totalItems"
      [pageSize]="pageSize"
      [pageSizeOptions]="[5, 10, 25, 50]"
      [pageIndex]="pageIndex"
      (page)="handlePageEvent($event)"
      showFirstLastButtons>
    </mat-paginator>
  </mat-card>

  <!-- Create/Edit Form Dialog -->
  <div class="form-overlay" *ngIf="showForm">
    <mat-card class="form-dialog">
      <div class="form-header">
        <h2>
          <mat-icon>{{ isEditMode ? 'edit' : 'add' }}</mat-icon>
          {{ isEditMode ? 'Edit' : 'Add New' }} Facility
        </h2>
        <button mat-icon-button (click)="closeForm()" matTooltip="Close">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <form [formGroup]="facilityForm">
        <div class="form-section">
          <h3>Basic Information</h3>
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Facility Name</mat-label>
              <input matInput formControlName="name" placeholder="Enter facility name">
              <mat-icon matPrefix>business</mat-icon>
              <mat-error>{{ getFieldError('name') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Facility Code</mat-label>
              <input matInput formControlName="code" placeholder="e.g., FC000001" [readonly]="isEditMode">
              <mat-icon matPrefix>tag</mat-icon>
              <mat-hint>6-10 uppercase alphanumeric characters</mat-hint>
              <mat-error>{{ getFieldError('code') }}</mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Facility Type</mat-label>
              <mat-select formControlName="type">
                <mat-option *ngFor="let type of facilityTypes" [value]="type">{{ type }}</mat-option>
              </mat-select>
              <mat-icon matPrefix>category</mat-icon>
              <mat-error>{{ getFieldError('type') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Status</mat-label>
              <mat-select formControlName="status">
                <mat-option *ngFor="let status of statusOptions" [value]="status">{{ status }}</mat-option>
              </mat-select>
              <mat-icon matPrefix>info</mat-icon>
              <mat-error>{{ getFieldError('status') }}</mat-error>
            </mat-form-field>
          </div>
        </div>

        <mat-divider></mat-divider>

        <div class="form-section">
          <h3>Location Details</h3>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Street Address</mat-label>
            <input matInput formControlName="address" placeholder="Enter street address">
            <mat-icon matPrefix>home</mat-icon>
            <mat-error>{{ getFieldError('address') }}</mat-error>
          </mat-form-field>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>City</mat-label>
              <input matInput formControlName="city" placeholder="Enter city">
              <mat-icon matPrefix>location_city</mat-icon>
              <mat-error>{{ getFieldError('city') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>State</mat-label>
              <mat-select formControlName="state">
                <mat-option *ngFor="let state of stateOptions" [value]="state">{{ state }}</mat-option>
              </mat-select>
              <mat-icon matPrefix>map</mat-icon>
              <mat-error>{{ getFieldError('state') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>ZIP Code</mat-label>
              <input matInput formControlName="zipCode" placeholder="12345 or 12345-6789">
              <mat-icon matPrefix>pin_drop</mat-icon>
              <mat-error>{{ getFieldError('zipCode') }}</mat-error>
            </mat-form-field>
          </div>
        </div>

        <mat-divider></mat-divider>

        <div class="form-section">
          <h3>Contact Information</h3>
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Phone</mat-label>
              <input matInput formControlName="phone" placeholder="Enter phone number">
              <mat-icon matPrefix>phone</mat-icon>
              <mat-error>{{ getFieldError('phone') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Email</mat-label>
              <input matInput type="email" formControlName="email" placeholder="Enter email">
              <mat-icon matPrefix>email</mat-icon>
              <mat-error>{{ getFieldError('email') }}</mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Manager Name</mat-label>
              <input matInput formControlName="managerName" placeholder="Enter manager name">
              <mat-icon matPrefix>person</mat-icon>
              <mat-error>{{ getFieldError('managerName') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Manager Email</mat-label>
              <input matInput type="email" formControlName="managerEmail" placeholder="Enter manager email">
              <mat-icon matPrefix>email</mat-icon>
              <mat-error>{{ getFieldError('managerEmail') }}</mat-error>
            </mat-form-field>
          </div>
        </div>

        <mat-divider></mat-divider>

        <div class="form-section">
          <h3>Storage & Licensing</h3>
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Storage Capacity</mat-label>
              <input matInput type="number" formControlName="capacity" placeholder="Enter capacity">
              <mat-icon matPrefix>inventory</mat-icon>
              <mat-hint>Maximum storage capacity in units</mat-hint>
              <mat-error>{{ getFieldError('capacity') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Storage Type</mat-label>
              <mat-select formControlName="storageType">
                <mat-option *ngFor="let type of storageTypes" [value]="type">{{ type }}</mat-option>
              </mat-select>
              <mat-icon matPrefix>ac_unit</mat-icon>
              <mat-error>{{ getFieldError('storageType') }}</mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>License Number</mat-label>
              <input matInput formControlName="license" placeholder="Enter license number">
              <mat-icon matPrefix>verified</mat-icon>
              <mat-error>{{ getFieldError('license') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Certifications</mat-label>
              <input matInput formControlName="certifications" placeholder="e.g., ISO 9001, WHO GMP">
              <mat-icon matPrefix>stars</mat-icon>
              <mat-hint>Comma-separated list</mat-hint>
            </mat-form-field>
          </div>
        </div>

        <div class="form-actions">
          <button mat-stroked-button (click)="closeForm()" type="button">
            <mat-icon>cancel</mat-icon> Cancel
          </button>
          <button mat-raised-button color="primary" (click)="saveFacility()" type="button" [disabled]="facilityForm.invalid">
            <mat-icon>save</mat-icon> {{ isEditMode ? 'Update' : 'Create' }} Facility
          </button>
        </div>
      </form>
    </mat-card>
  </div>

  <!-- Detail View Dialog -->
  <div class="detail-overlay" *ngIf="showDetailDialog && detailFacility">
    <mat-card class="detail-dialog">
      <div class="detail-header">
        <h2>
          <mat-icon>business</mat-icon>
          Facility Details
        </h2>
        <button mat-icon-button (click)="closeDetailDialog()" matTooltip="Close">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="detail-content">
        <div class="detail-section">
          <h3>Basic Information</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Facility Name:</span>
              <span class="value">{{ detailFacility.name }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Facility Code:</span>
              <span class="value">{{ detailFacility.code }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Type:</span>
              <mat-chip class="type-chip">{{ detailFacility.type }}</mat-chip>
            </div>
            <div class="detail-item">
              <span class="label">Status:</span>
              <mat-chip [class]="'status-' + detailFacility.status.toLowerCase()">{{ detailFacility.status }}</mat-chip>
            </div>
          </div>
        </div>

        <mat-divider></mat-divider>

        <div class="detail-section">
          <h3>Location</h3>
          <div class="detail-grid">
            <div class="detail-item full-width">
              <span class="label">Address:</span>
              <span class="value">{{ detailFacility.address }}</span>
            </div>
            <div class="detail-item">
              <span class="label">City:</span>
              <span class="value">{{ detailFacility.city }}</span>
            </div>
            <div class="detail-item">
              <span class="label">State:</span>
              <span class="value">{{ detailFacility.state }}</span>
            </div>
            <div class="detail-item">
              <span class="label">ZIP Code:</span>
              <span class="value">{{ detailFacility.zipCode }}</span>
            </div>
          </div>
        </div>

        <mat-divider></mat-divider>

        <div class="detail-section">
          <h3>Contact Information</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Phone:</span>
              <span class="value">{{ detailFacility.phone }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Email:</span>
              <span class="value">{{ detailFacility.email }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Manager:</span>
              <span class="value">{{ detailFacility.managerName }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Manager Email:</span>
              <span class="value">{{ detailFacility.managerEmail }}</span>
            </div>
          </div>
        </div>

        <mat-divider></mat-divider>

        <div class="detail-section">
          <h3>Storage & Capacity</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Storage Type:</span>
              <span class="value">{{ detailFacility.storageType }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Total Capacity:</span>
              <span class="value">{{ detailFacility.capacity | number }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Current Stock:</span>
              <span class="value">{{ detailFacility.currentStock | number }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Utilization:</span>
              <span class="value">{{ ((detailFacility.currentStock / detailFacility.capacity) * 100).toFixed(1) }}%</span>
            </div>
          </div>
        </div>

        <mat-divider></mat-divider>

        <div class="detail-section">
          <h3>Licensing & Certifications</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">License Number:</span>
              <span class="value">{{ detailFacility.license }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Established Date:</span>
              <span class="value">{{ formatDate(detailFacility.establishedDate) }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Last Inspection:</span>
              <span class="value">{{ formatDate(detailFacility.lastInspection) }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Next Inspection:</span>
              <span class="value">{{ formatDate(detailFacility.nextInspection) }}</span>
            </div>
            <div class="detail-item full-width">
              <span class="label">Certifications:</span>
              <div class="certifications">
                <mat-chip *ngFor="let cert of detailFacility.certifications" class="cert-chip">
                  <mat-icon>verified</mat-icon> {{ cert }}
                </mat-chip>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="detail-actions">
        <button mat-stroked-button (click)="closeDetailDialog()">
          <mat-icon>close</mat-icon> Close
        </button>
        <button mat-raised-button color="primary" (click)="openEditForm(detailFacility); closeDetailDialog()">
          <mat-icon>edit</mat-icon> Edit Facility
        </button>
      </div>
    </mat-card>
  </div>
</div>
