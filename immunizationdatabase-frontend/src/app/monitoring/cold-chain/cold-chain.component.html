<div class="cold-chain-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="icon-wrapper">
        <mat-icon>ac_unit</mat-icon>
      </div>
      <div class="header-text">
        <h1>Cold Chain Monitoring</h1>
        <p>Real-time temperature tracking for vaccine storage</p>
      </div>
    </div>
    <div class="header-actions">
      <mat-slide-toggle [(ngModel)]="autoRefresh" (change)="toggleAutoRefresh()" color="primary">
        Auto Refresh
      </mat-slide-toggle>
      <button mat-raised-button color="primary" (click)="openDeviceDialog()">
        <mat-icon>add</mat-icon>
        Add Device
      </button>
      <button mat-icon-button [matMenuTriggerFor]="exportMenu" matTooltip="Export">
        <mat-icon>file_download</mat-icon>
      </button>
      <mat-menu #exportMenu="matMenu">
        <button mat-menu-item (click)="exportLogs('csv')">
          <mat-icon>description</mat-icon>
          <span>Export as CSV</span>
        </button>
        <button mat-menu-item (click)="exportLogs('json')">
          <mat-icon>code</mat-icon>
          <span>Export as JSON</span>
        </button>
        <button mat-menu-item (click)="exportLogs('pdf')">
          <mat-icon>picture_as_pdf</mat-icon>
          <span>Export as PDF</span>
        </button>
      </mat-menu>
      <button mat-icon-button (click)="refreshData()" matTooltip="Refresh">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>
  </div>

  <!-- Statistics Overview -->
  <div class="stats-overview">
    <div class="stats-grid">
      <mat-card class="stat-card">
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>devices</mat-icon>
          </div>
          <div class="stat-details">
            <div class="stat-value">{{ stats.totalDevices }}</div>
            <div class="stat-label">Total Devices</div>
          </div>
        </div>
      </mat-card>

      <mat-card class="stat-card">
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>check_circle</mat-icon>
          </div>
          <div class="stat-details">
            <div class="stat-value">{{ stats.activeDevices }}</div>
            <div class="stat-label">Active Devices</div>
          </div>
        </div>
      </mat-card>

      <mat-card class="stat-card critical">
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>error</mat-icon>
          </div>
          <div class="stat-details">
            <div class="stat-value">{{ stats.criticalAlerts }}</div>
            <div class="stat-label">Critical Alerts</div>
          </div>
        </div>
      </mat-card>

      <mat-card class="stat-card warning">
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>warning</mat-icon>
          </div>
          <div class="stat-details">
            <div class="stat-value">{{ stats.warningAlerts }}</div>
            <div class="stat-label">Warning Alerts</div>
          </div>
        </div>
      </mat-card>

      <mat-card class="stat-card">
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>thermostat</mat-icon>
          </div>
          <div class="stat-details">
            <div class="stat-value">{{ formatTemperature(stats.averageTemp) }}</div>
            <div class="stat-label">Average Temperature</div>
          </div>
        </div>
      </mat-card>

      <mat-card class="stat-card">
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>trending_up</mat-icon>
          </div>
          <div class="stat-details">
            <div class="stat-value" [class.good]="stats.complianceRate >= 95" 
                 [class.warning]="stats.complianceRate < 95 && stats.complianceRate >= 85"
                 [class.critical]="stats.complianceRate < 85">
              {{ stats.complianceRate }}%
            </div>
            <div class="stat-label">Compliance Rate</div>
          </div>
        </div>
      </mat-card>
    </div>
  </div>

  <!-- Devices Grid -->
  <mat-card class="devices-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>devices</mat-icon>
        Monitoring Devices
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="devices-grid">
        <mat-card *ngFor="let device of devices" class="device-card" 
                  [class.active]="device.status === 'Active'"
                  [class.error]="device.status === 'Error'">
          <div class="device-header">
            <div class="device-info">
              <div class="device-name">{{ device.name }}</div>
              <div class="device-location">{{ device.location }}</div>
            </div>
            <mat-chip [color]="getDeviceStatusColor(device.status)">
              {{ device.status }}
            </mat-chip>
          </div>
          <mat-divider></mat-divider>
          <div class="device-details">
            <div class="detail-row">
              <span class="detail-label">Type:</span>
              <span class="detail-value">{{ device.type }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Current Temp:</span>
              <span class="detail-value temp" 
                    [class.normal]="device.currentTemp && device.currentTemp >= device.minTemp && device.currentTemp <= device.maxTemp"
                    [class.warning]="device.currentTemp && (device.currentTemp < device.minTemp || device.currentTemp > device.maxTemp)">
                {{ device.currentTemp ? formatTemperature(device.currentTemp) : 'N/A' }}
              </span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Range:</span>
              <span class="detail-value">{{ formatTemperature(device.minTemp) }} - {{ formatTemperature(device.maxTemp) }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Battery:</span>
              <span class="detail-value">
                <mat-icon [color]="getBatteryColor(device.batteryLevel)" class="battery-icon">
                  {{ device.batteryLevel && device.batteryLevel > 50 ? 'battery_full' : 
                     device.batteryLevel && device.batteryLevel > 20 ? 'battery_3_bar' : 'battery_alert' }}
                </mat-icon>
                {{ device.batteryLevel }}%
              </span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Last Reading:</span>
              <span class="detail-value">{{ formatDate(device.lastReading!) }}</span>
            </div>
          </div>
          <mat-divider></mat-divider>
          <div class="device-actions">
            <button mat-button (click)="openDeviceDialog(device)">
              <mat-icon>edit</mat-icon>
              Edit
            </button>
            <button mat-button (click)="openAlertSettings(device)">
              <mat-icon>notifications</mat-icon>
              Alerts
            </button>
            <button mat-button color="warn" (click)="deleteDevice(device)">
              <mat-icon>delete</mat-icon>
              Delete
            </button>
          </div>
        </mat-card>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Filters Card -->
  <mat-card class="filters-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>filter_list</mat-icon>
        Filter Temperature Logs
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="filterForm" class="filter-form">
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Search</mat-label>
            <input matInput formControlName="search" placeholder="Search logs...">
            <mat-icon matPrefix>search</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Device</mat-label>
            <mat-select formControlName="deviceId">
              <mat-option value="">All Devices</mat-option>
              <mat-option *ngFor="let device of devices" [value]="device.id">
                {{ device.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Facility</mat-label>
            <mat-select formControlName="facilityId">
              <mat-option value="">All Facilities</mat-option>
              <mat-option *ngFor="let facility of facilities" [value]="facility.id">
                {{ facility.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Status</mat-label>
            <mat-select formControlName="status">
              <mat-option value="">All Status</mat-option>
              <mat-option *ngFor="let status of statusOptions" [value]="status">
                {{ status }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>From Date</mat-label>
            <input matInput [matDatepicker]="pickerFrom" formControlName="dateFrom" placeholder="From date">
            <mat-datepicker-toggle matSuffix [for]="pickerFrom"></mat-datepicker-toggle>
            <mat-datepicker #pickerFrom></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>To Date</mat-label>
            <input matInput [matDatepicker]="pickerTo" formControlName="dateTo" placeholder="To date">
            <mat-datepicker-toggle matSuffix [for]="pickerTo"></mat-datepicker-toggle>
            <mat-datepicker #pickerTo></mat-datepicker>
          </mat-form-field>
        </div>

        <div class="filter-actions">
          <button mat-raised-button type="button" (click)="resetFilters()" class="reset-button">
            <mat-icon>clear</mat-icon>
            Reset Filters
          </button>
          <span class="filter-results">{{ filteredLogs.length }} logs found</span>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Temperature Logs Table -->
  <mat-card class="table-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>history</mat-icon>
        Temperature Logs
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="table-container">
        <table mat-table [dataSource]="getPaginatedLogs()" class="logs-table">
          <!-- Device Column -->
          <ng-container matColumnDef="device">
            <th mat-header-cell *matHeaderCellDef>Device</th>
            <td mat-cell *matCellDef="let log">
              <div class="device-info">
                <div class="device-name">{{ log.deviceName }}</div>
                <div class="device-id">{{ log.deviceId }}</div>
              </div>
            </td>
          </ng-container>

          <!-- Location Column -->
          <ng-container matColumnDef="location">
            <th mat-header-cell *matHeaderCellDef>Location</th>
            <td mat-cell *matCellDef="let log">
              <div class="location-info">
                <div class="location-name">{{ log.location }}</div>
                <div class="facility-name">{{ log.facilityName }}</div>
              </div>
            </td>
          </ng-container>

          <!-- Temperature Column -->
          <ng-container matColumnDef="temperature">
            <th mat-header-cell *matHeaderCellDef>Temperature</th>
            <td mat-cell *matCellDef="let log">
              <div class="temp-info">
                <div class="temp-value" 
                     [class.normal]="log.status === 'Normal'"
                     [class.warning]="log.status === 'Warning'"
                     [class.critical]="log.status === 'Critical' || log.status === 'Alarm'">
                  {{ formatTemperature(log.temperature) }}
                </div>
                <div class="temp-range">
                  Range: {{ formatTemperature(log.minThreshold) }} - {{ formatTemperature(log.maxThreshold) }}
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Humidity Column -->
          <ng-container matColumnDef="humidity">
            <th mat-header-cell *matHeaderCellDef>Humidity</th>
            <td mat-cell *matCellDef="let log">
              {{ log.humidity ? log.humidity + '%' : 'N/A' }}
            </td>
          </ng-container>

          <!-- Timestamp Column -->
          <ng-container matColumnDef="timestamp">
            <th mat-header-cell *matHeaderCellDef>Timestamp</th>
            <td mat-cell *matCellDef="let log">
              {{ formatDate(log.timestamp) }}
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let log">
              <mat-chip [color]="getStatusColor(log.status)" [class.status-normal]="log.status === 'Normal'"
                        [class.status-warning]="log.status === 'Warning'"
                        [class.status-critical]="log.status === 'Critical'"
                        [class.status-alarm]="log.status === 'Alarm'">
                <mat-icon *ngIf="log.status !== 'Normal'">{{ log.status === 'Critical' || log.status === 'Alarm' ? 'error' : 'warning' }}</mat-icon>
                {{ log.status }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Battery Column -->
          <ng-container matColumnDef="battery">
            <th mat-header-cell *matHeaderCellDef>Battery</th>
            <td mat-cell *matCellDef="let log">
              <div class="battery-info" *ngIf="log.batteryLevel">
                <mat-icon [color]="getBatteryColor(log.batteryLevel)">
                  {{ log.batteryLevel > 50 ? 'battery_full' : 
                     log.batteryLevel > 20 ? 'battery_3_bar' : 'battery_alert' }}
                </mat-icon>
                <span>{{ log.batteryLevel }}%</span>
              </div>
              <span *ngIf="!log.batteryLevel">N/A</span>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let log">
              <button mat-icon-button [matMenuTriggerFor]="menu">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #menu="matMenu">
                <button mat-menu-item (click)="viewLogDetails(log)">
                  <mat-icon>visibility</mat-icon>
                  <span>View Details</span>
                </button>
                <button mat-menu-item *ngIf="log.alertSent" (click)="acknowledgeAlert(log)">
                  <mat-icon>check</mat-icon>
                  <span>Acknowledge Alert</span>
                </button>
              </mat-menu>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>

      <mat-paginator 
        [length]="filteredLogs.length"
        [pageSize]="pageSize"
        [pageIndex]="pageIndex"
        [pageSizeOptions]="pageSizeOptions"
        (page)="handlePageEvent($event)"
        showFirstLastButtons>
      </mat-paginator>
    </mat-card-content>
  </mat-card>

  <!-- Device Dialog -->
  <div class="dialog-overlay" *ngIf="showDeviceDialog" (click)="closeDeviceDialog()">
    <div class="dialog-container" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>{{ isEditMode ? 'Edit Device' : 'Register New Device' }}</h2>
        <button mat-icon-button (click)="closeDeviceDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="dialog-content">
        <form [formGroup]="deviceForm">
          <div class="form-section">
            <h3>Device Information</h3>
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Device ID</mat-label>
                <input matInput formControlName="id" [readonly]="isEditMode" placeholder="e.g., DEV001">
                <mat-error *ngIf="deviceForm.get('id')?.hasError('required')">Device ID is required</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Device Name</mat-label>
                <input matInput formControlName="name" placeholder="e.g., Refrigerator 1">
                <mat-error *ngIf="deviceForm.get('name')?.hasError('required')">Name is required</mat-error>
                <mat-error *ngIf="deviceForm.get('name')?.hasError('minlength')">Minimum 3 characters</mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Device Type</mat-label>
                <mat-select formControlName="type">
                  <mat-option *ngFor="let type of deviceTypeOptions" [value]="type">
                    {{ type }}
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="deviceForm.get('type')?.hasError('required')">Type is required</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Status</mat-label>
                <mat-select formControlName="status">
                  <mat-option *ngFor="let status of deviceStatusOptions" [value]="status">
                    {{ status }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>

          <div class="form-section">
            <h3>Location & Facility</h3>
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Location</mat-label>
                <input matInput formControlName="location" placeholder="e.g., Vaccine Storage Room">
                <mat-error *ngIf="deviceForm.get('location')?.hasError('required')">Location is required</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Facility</mat-label>
                <mat-select formControlName="facilityId">
                  <mat-option *ngFor="let facility of facilities" [value]="facility.id">
                    {{ facility.name }}
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="deviceForm.get('facilityId')?.hasError('required')">Facility is required</mat-error>
              </mat-form-field>
            </div>
          </div>

          <div class="form-section">
            <h3>Temperature Thresholds</h3>
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Minimum Temperature (°C)</mat-label>
                <input matInput type="number" formControlName="minTemp" placeholder="-20">
                <mat-error *ngIf="deviceForm.get('minTemp')?.hasError('required')">Min temperature is required</mat-error>
                <mat-error *ngIf="deviceForm.get('minTemp')?.hasError('min')">Must be at least -80°C</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Maximum Temperature (°C)</mat-label>
                <input matInput type="number" formControlName="maxTemp" placeholder="8">
                <mat-error *ngIf="deviceForm.get('maxTemp')?.hasError('required')">Max temperature is required</mat-error>
                <mat-error *ngIf="deviceForm.get('maxTemp')?.hasError('max')">Must be at most 50°C</mat-error>
              </mat-form-field>
            </div>
          </div>
        </form>
      </div>
      <div class="dialog-actions">
        <button mat-button (click)="closeDeviceDialog()">Cancel</button>
        <button mat-raised-button color="primary" (click)="saveDevice()" class="save-button">
          <mat-icon>save</mat-icon>
          {{ isEditMode ? 'Update' : 'Register' }} Device
        </button>
      </div>
    </div>
  </div>

  <!-- Alert Settings Dialog -->
  <div class="dialog-overlay" *ngIf="showAlertDialog" (click)="closeAlertDialog()">
    <div class="dialog-container" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Alert Settings</h2>
        <button mat-icon-button (click)="closeAlertDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="dialog-content">
        <form [formGroup]="alertForm">
          <div class="form-section">
            <h3>Temperature Thresholds</h3>
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Minimum Threshold (°C)</mat-label>
                <input matInput type="number" formControlName="minThreshold" placeholder="e.g., 2">
                <mat-error *ngIf="alertForm.get('minThreshold')?.hasError('required')">Required</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Maximum Threshold (°C)</mat-label>
                <input matInput type="number" formControlName="maxThreshold" placeholder="e.g., 8">
                <mat-error *ngIf="alertForm.get('maxThreshold')?.hasError('required')">Required</mat-error>
              </mat-form-field>
            </div>
          </div>

          <div class="form-section">
            <h3>Notification Settings</h3>
            <div class="toggle-row">
              <mat-slide-toggle formControlName="emailNotification" color="primary">
                Email Notifications
              </mat-slide-toggle>
            </div>
            <div class="toggle-row">
              <mat-slide-toggle formControlName="smsNotification" color="primary">
                SMS Notifications
              </mat-slide-toggle>
            </div>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Recipients Email</mat-label>
              <input matInput type="email" formControlName="recipients" placeholder="email@example.com">
              <mat-error *ngIf="alertForm.get('recipients')?.hasError('email')">Invalid email</mat-error>
            </mat-form-field>
          </div>
        </form>
      </div>
      <div class="dialog-actions">
        <button mat-button (click)="closeAlertDialog()">Cancel</button>
        <button mat-raised-button color="primary" (click)="saveAlertSettings()" class="save-button">
          <mat-icon>save</mat-icon>
          Save Settings
        </button>
      </div>
    </div>
  </div>

  <!-- Detail Dialog -->
  <div class="dialog-overlay" *ngIf="showDetailDialog" (click)="closeDetailDialog()">
    <div class="dialog-container" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Temperature Log Details</h2>
        <button mat-icon-button (click)="closeDetailDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="dialog-content" *ngIf="selectedLog">
        <div class="detail-section">
          <h3>Device Information</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Device ID:</span>
              <span class="value">{{ selectedLog.deviceId }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Device Name:</span>
              <span class="value">{{ selectedLog.deviceName }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Location:</span>
              <span class="value">{{ selectedLog.location }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Facility:</span>
              <span class="value">{{ selectedLog.facilityName }}</span>
            </div>
          </div>
        </div>

        <mat-divider></mat-divider>

        <div class="detail-section">
          <h3>Temperature Reading</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Temperature:</span>
              <span class="value temp" 
                    [class.normal]="selectedLog.status === 'Normal'"
                    [class.warning]="selectedLog.status === 'Warning'"
                    [class.critical]="selectedLog.status === 'Critical' || selectedLog.status === 'Alarm'">
                {{ formatTemperature(selectedLog.temperature) }}
              </span>
            </div>
            <div class="detail-item">
              <span class="label">Humidity:</span>
              <span class="value">{{ selectedLog.humidity ? selectedLog.humidity + '%' : 'N/A' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Min Threshold:</span>
              <span class="value">{{ formatTemperature(selectedLog.minThreshold) }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Max Threshold:</span>
              <span class="value">{{ formatTemperature(selectedLog.maxThreshold) }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Status:</span>
              <span class="value">
                <mat-chip [color]="getStatusColor(selectedLog.status)">{{ selectedLog.status }}</mat-chip>
              </span>
            </div>
            <div class="detail-item">
              <span class="label">Alert Sent:</span>
              <span class="value">{{ selectedLog.alertSent ? 'Yes' : 'No' }}</span>
            </div>
          </div>
        </div>

        <mat-divider></mat-divider>

        <div class="detail-section">
          <h3>Additional Information</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Timestamp:</span>
              <span class="value">{{ formatDate(selectedLog.timestamp) }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedLog.batteryLevel">
              <span class="label">Battery Level:</span>
              <span class="value">{{ selectedLog.batteryLevel }}%</span>
            </div>
            <div class="detail-item full-width" *ngIf="selectedLog.notes">
              <span class="label">Notes:</span>
              <span class="value">{{ selectedLog.notes }}</span>
            </div>
          </div>
        </div>
      </div>
      <div class="dialog-actions">
        <button mat-raised-button color="primary" (click)="closeDetailDialog()">Close</button>
      </div>
    </div>
  </div>
</div>
