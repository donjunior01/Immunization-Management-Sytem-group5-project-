<div class="analytics-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-title">
      <div class="icon-wrapper">
        <mat-icon>analytics</mat-icon>
      </div>
      <div>
        <h1>Campaign Analytics</h1>
        <p>Comprehensive performance insights and trends</p>
      </div>
    </div>
    <div class="header-actions">
      <button mat-raised-button (click)="refreshAnalytics()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
      <button mat-raised-button color="primary" (click)="exportAnalytics()">
        <mat-icon>download</mat-icon>
        Export Report
      </button>
    </div>
  </div>

  <!-- Filters Section -->
  <mat-card class="filters-card">
    <div class="filters-row">
      <mat-form-field appearance="outline">
        <mat-label>Time Range</mat-label>
        <mat-select [(ngModel)]="selectedTimeRange" (selectionChange)="onTimeRangeChange()">
          <mat-option *ngFor="let option of timeRangeOptions" [value]="option.value">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      
      <mat-form-field appearance="outline">
        <mat-label>Campaign Scope</mat-label>
        <mat-select [(ngModel)]="selectedScope" (selectionChange)="onScopeChange()">
          <mat-option *ngFor="let option of scopeOptions" [value]="option.value">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </mat-card>

  <!-- KPI Cards -->
  <div class="kpi-grid">
    <mat-card class="kpi-card kpi-total">
      <div class="kpi-icon">
        <mat-icon>campaign</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Total Campaigns</div>
        <div class="kpi-value">{{ kpis.totalCampaigns }}</div>
        <div class="kpi-sublabel">All time</div>
      </div>
    </mat-card>

    <mat-card class="kpi-card kpi-active">
      <div class="kpi-icon">
        <mat-icon>play_circle</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Active Campaigns</div>
        <div class="kpi-value">{{ kpis.activeCampaigns }}</div>
        <div class="kpi-sublabel">Currently running</div>
      </div>
    </mat-card>

    <mat-card class="kpi-card kpi-coverage">
      <div class="kpi-icon">
        <mat-icon>trending_up</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Average Coverage</div>
        <div class="kpi-value">{{ kpis.averageCoverage }}%</div>
        <div class="kpi-sublabel">Across all campaigns</div>
      </div>
    </mat-card>

    <mat-card class="kpi-card kpi-vaccinated">
      <div class="kpi-icon">
        <mat-icon>vaccines</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Total Vaccinated</div>
        <div class="kpi-value">{{ kpis.totalVaccinated | number }}</div>
        <div class="kpi-sublabel">of {{ kpis.targetPopulation | number }} target</div>
      </div>
    </mat-card>

    <mat-card class="kpi-card kpi-completion">
      <div class="kpi-icon">
        <mat-icon>check_circle</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Completion Rate</div>
        <div class="kpi-value">{{ kpis.completionRate }}%</div>
        <div class="kpi-sublabel">Campaigns completed</div>
      </div>
    </mat-card>
  </div>

  <!-- Charts Section -->
  <div class="charts-grid">
    <!-- Vaccine Distribution Chart -->
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>pie_chart</mat-icon>
          Vaccine Distribution
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="vaccine-distribution">
          <div class="distribution-chart">
            <div class="pie-chart">
              <svg viewBox="0 0 200 200" class="pie-svg">
                <circle cx="100" cy="100" r="80" fill="none" stroke="#f0f0f0" stroke-width="40"/>
                <!-- Simplified pie chart representation -->
                <circle 
                  *ngFor="let vd of vaccineDistribution; let i = index"
                  cx="100" 
                  cy="100" 
                  r="80"
                  fill="none"
                  [attr.stroke]="vd.color"
                  stroke-width="40"
                  [attr.stroke-dasharray]="(vd.percentage * 5.03) + ' 502'"
                  [attr.transform]="'rotate(' + (i * 60) + ' 100 100)'"
                />
              </svg>
            </div>
          </div>
          <div class="distribution-legend">
            <div class="legend-item" *ngFor="let vd of vaccineDistribution">
              <div class="legend-color" [style.background-color]="vd.color"></div>
              <div class="legend-label">
                <strong>{{ vd.vaccine }}</strong>
                <span>{{ vd.count }} campaigns ({{ vd.percentage }}%)</span>
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Coverage Trends Chart -->
    <mat-card class="chart-card coverage-trends-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>show_chart</mat-icon>
          Coverage Trends
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="trends-chart">
          <div class="chart-bars">
            <div class="bar-group" *ngFor="let trend of coverageTrends">
              <div class="bar-container">
                <div 
                  class="bar" 
                  [style.height.%]="trend.coverage"
                  [style.background-color]="getCoverageColor(trend.coverage)"
                  [matTooltip]="'Coverage: ' + trend.coverage + '%'">
                </div>
              </div>
              <div class="bar-label">{{ trend.month.split(' ')[0] }}</div>
              <div class="bar-value">{{ trend.coverage }}%</div>
            </div>
          </div>
          <div class="chart-legend">
            <div class="legend-item">
              <div class="legend-line"></div>
              <span>Target: 80% Coverage</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Age Group Analysis -->
  <mat-card class="chart-card age-group-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>people</mat-icon>
        Age Group Coverage Analysis
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="age-group-bars">
        <div class="age-group-item" *ngFor="let ag of ageGroupData">
          <div class="age-group-label">{{ ag.ageGroup }}</div>
          <div class="age-group-bar-container">
            <div 
              class="age-group-bar" 
              [style.width.%]="ag.coverage"
              [style.background-color]="getCoverageColor(ag.coverage)">
            </div>
          </div>
          <div class="age-group-stats">
            <span class="stat-value">{{ ag.vaccinated | number }} / {{ ag.targetPopulation | number }}</span>
            <span class="stat-coverage" [style.color]="getCoverageColor(ag.coverage)">{{ ag.coverage }}%</span>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Campaign Comparison Table -->
  <mat-card class="comparison-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>compare_arrows</mat-icon>
        Campaign Performance Comparison
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <table mat-table [dataSource]="campaigns" class="comparison-table">
        <!-- Campaign Column -->
        <ng-container matColumnDef="campaign">
          <th mat-header-cell *matHeaderCellDef>Campaign</th>
          <td mat-cell *matCellDef="let campaign">
            <div class="campaign-info">
              <strong>{{ campaign.name }}</strong>
              <span class="facility-name">{{ campaign.facilityName }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Vaccine Column -->
        <ng-container matColumnDef="vaccine">
          <th mat-header-cell *matHeaderCellDef>Vaccine</th>
          <td mat-cell *matCellDef="let campaign">
            <mat-chip class="vaccine-chip">
              <mat-icon>vaccines</mat-icon>
              {{ campaign.vaccineName }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Target Column -->
        <ng-container matColumnDef="target">
          <th mat-header-cell *matHeaderCellDef>Target Population</th>
          <td mat-cell *matCellDef="let campaign">{{ campaign.targetPopulation | number }}</td>
        </ng-container>

        <!-- Vaccinated Column -->
        <ng-container matColumnDef="vaccinated">
          <th mat-header-cell *matHeaderCellDef>Vaccinated</th>
          <td mat-cell *matCellDef="let campaign">{{ campaign.vaccinatedCount | number }}</td>
        </ng-container>

        <!-- Coverage Column -->
        <ng-container matColumnDef="coverage">
          <th mat-header-cell *matHeaderCellDef>Coverage</th>
          <td mat-cell *matCellDef="let campaign">
            <span 
              class="coverage-badge" 
              [style.background-color]="getCoverageColor(campaign.coveragePercent)">
              {{ campaign.coveragePercent }}%
            </span>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let campaign">
            <mat-chip [ngClass]="getStatusClass(campaign.status)">
              <mat-icon>{{ getStatusIcon(campaign.status) }}</mat-icon>
              {{ campaign.status }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Days Left Column -->
        <ng-container matColumnDef="daysLeft">
          <th mat-header-cell *matHeaderCellDef>Days Remaining</th>
          <td mat-cell *matCellDef="let campaign">
            <span [ngClass]="getDaysRemainingClass(campaign.daysRemaining)">
              {{ campaign.daysRemaining > 0 ? campaign.daysRemaining : 'Ended' }}
            </span>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="comparisonColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: comparisonColumns;" (click)="viewCampaignDetails(row)" class="clickable-row"></tr>
      </table>
    </mat-card-content>
  </mat-card>

  <!-- Facility Performance Table -->
  <mat-card class="performance-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>leaderboard</mat-icon>
        Top Performing Facilities
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <table mat-table [dataSource]="facilityPerformance" class="performance-table">
        <!-- Rank Column -->
        <ng-container matColumnDef="rank">
          <th mat-header-cell *matHeaderCellDef>Rank</th>
          <td mat-cell *matCellDef="let facility">
            <div class="rank-badge" [class.rank-top]="facility.rank === 1">
              <mat-icon *ngIf="facility.rank === 1">emoji_events</mat-icon>
              <span>{{ facility.rank }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Facility Column -->
        <ng-container matColumnDef="facility">
          <th mat-header-cell *matHeaderCellDef>Facility Name</th>
          <td mat-cell *matCellDef="let facility">
            <strong>{{ facility.facilityName }}</strong>
          </td>
        </ng-container>

        <!-- Campaigns Column -->
        <ng-container matColumnDef="campaigns">
          <th mat-header-cell *matHeaderCellDef>Active Campaigns</th>
          <td mat-cell *matCellDef="let facility">{{ facility.activeCampaigns }}</td>
        </ng-container>

        <!-- Vaccinated Column -->
        <ng-container matColumnDef="vaccinated">
          <th mat-header-cell *matHeaderCellDef>Total Vaccinated</th>
          <td mat-cell *matCellDef="let facility">{{ facility.totalVaccinated | number }}</td>
        </ng-container>

        <!-- Average Coverage Column -->
        <ng-container matColumnDef="avgCoverage">
          <th mat-header-cell *matHeaderCellDef>Avg. Coverage</th>
          <td mat-cell *matCellDef="let facility">
            <span 
              class="coverage-badge" 
              [style.background-color]="getCoverageColor(facility.averageCoverage)">
              {{ facility.averageCoverage }}%
            </span>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="performanceColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: performanceColumns;"></tr>
      </table>
    </mat-card-content>
  </mat-card>
</div>
