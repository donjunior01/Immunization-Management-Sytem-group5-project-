<div class="activity-log-container">
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <mat-icon class="page-icon">history</mat-icon>
        <div class="header-text">
          <h1>Activity Log</h1>
          <p>System audit trail and user activity monitoring</p>
        </div>
      </div>
      <div class="header-actions">
        <button mat-icon-button matTooltip="Refresh" (click)="refreshLog()">
          <mat-icon>refresh</mat-icon>
        </button>
        <button mat-raised-button [matMenuTriggerFor]="exportMenu" class="export-button">
          <mat-icon>download</mat-icon>
          Export
        </button>
        <mat-menu #exportMenu="matMenu">
          <button mat-menu-item (click)="exportLogs('csv')">
            <mat-icon>description</mat-icon>
            Export to CSV
          </button>
          <button mat-menu-item (click)="exportLogs('json')">
            <mat-icon>code</mat-icon>
            Export to JSON
          </button>
          <button mat-menu-item (click)="exportLogs('pdf')">
            <mat-icon>picture_as_pdf</mat-icon>
            Export to PDF
          </button>
        </mat-menu>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <mat-card class="stat-card">
      <div class="stat-icon total">
        <mat-icon>list_alt</mat-icon>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.totalActivities }}</div>
        <div class="stat-label">Total Activities</div>
      </div>
    </mat-card>

    <mat-card class="stat-card">
      <div class="stat-icon today">
        <mat-icon>today</mat-icon>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.todayActivities }}</div>
        <div class="stat-label">Today's Activities</div>
      </div>
    </mat-card>

    <mat-card class="stat-card">
      <div class="stat-icon users">
        <mat-icon>people</mat-icon>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.uniqueUsers }}</div>
        <div class="stat-label">Unique Users</div>
      </div>
    </mat-card>

    <mat-card class="stat-card">
      <div class="stat-icon critical">
        <mat-icon>warning</mat-icon>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.criticalActions }}</div>
        <div class="stat-label">Critical Actions</div>
      </div>
    </mat-card>
  </div>

  <!-- Filters Card -->
  <mat-card class="filters-card">
    <div class="filters-header">
      <h2>
        <mat-icon>filter_list</mat-icon>
        Filters
      </h2>
      <button mat-button (click)="resetFilters()" class="reset-button">
        <mat-icon>clear</mat-icon>
        Reset
      </button>
    </div>

    <div class="filters-grid">
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Search</mat-label>
        <input matInput 
               [(ngModel)]="filters.search" 
               placeholder="Search user, entity, description..."
               (input)="applyFilters()">
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Category</mat-label>
        <mat-select [(ngModel)]="filters.category" (selectionChange)="applyFilters()">
          <mat-option *ngFor="let option of categoryOptions" [value]="option.value">
            <mat-icon>{{ option.icon }}</mat-icon>
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Action</mat-label>
        <mat-select [(ngModel)]="filters.action" (selectionChange)="applyFilters()">
          <mat-option *ngFor="let option of actionOptions" [value]="option.value">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Status</mat-label>
        <mat-select [(ngModel)]="filters.status" (selectionChange)="applyFilters()">
          <mat-option *ngFor="let option of statusOptions" [value]="option.value">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>From Date</mat-label>
        <input matInput 
               [matDatepicker]="pickerFrom"
               [(ngModel)]="filters.dateFrom"
               (dateChange)="applyFilters()">
        <mat-datepicker-toggle matSuffix [for]="pickerFrom"></mat-datepicker-toggle>
        <mat-datepicker #pickerFrom></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>To Date</mat-label>
        <input matInput 
               [matDatepicker]="pickerTo"
               [(ngModel)]="filters.dateTo"
               (dateChange)="applyFilters()">
        <mat-datepicker-toggle matSuffix [for]="pickerTo"></mat-datepicker-toggle>
        <mat-datepicker #pickerTo></mat-datepicker>
      </mat-form-field>
    </div>
  </mat-card>

  <!-- Activity Log Table -->
  <mat-card class="log-table-card">
    <div class="table-header">
      <h2>
        <mat-icon>list</mat-icon>
        Activity Logs
      </h2>
      <div class="results-count">
        Showing {{ displayedActivities.length }} of {{ totalItems }} activities
      </div>
    </div>

    <div class="table-container">
      <table mat-table [dataSource]="displayedActivities" class="activity-table">
        <!-- Timestamp Column -->
        <ng-container matColumnDef="timestamp">
          <th mat-header-cell *matHeaderCellDef>Timestamp</th>
          <td mat-cell *matCellDef="let activity">
            <div class="timestamp-cell">
              <div class="time-primary">{{ formatTimestamp(activity.timestamp) }}</div>
              <div class="time-secondary">{{ formatDate(activity.timestamp) }}</div>
            </div>
          </td>
        </ng-container>

        <!-- User Column -->
        <ng-container matColumnDef="user">
          <th mat-header-cell *matHeaderCellDef>User</th>
          <td mat-cell *matCellDef="let activity">
            <div class="user-cell">
              <div class="user-name">{{ activity.user }}</div>
              <div class="user-details">
                <mat-chip class="role-chip">{{ activity.role }}</mat-chip>
                <span class="user-id">{{ activity.userId }}</span>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Action Column -->
        <ng-container matColumnDef="action">
          <th mat-header-cell *matHeaderCellDef>Action</th>
          <td mat-cell *matCellDef="let activity">
            <div class="action-cell">
              <mat-chip [ngClass]="getActionClass(activity.action)">
                {{ activity.action | uppercase }}
              </mat-chip>
              <div class="category">
                <mat-icon>{{ getCategoryIcon(activity.category) }}</mat-icon>
                {{ activity.category }}
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Entity Column -->
        <ng-container matColumnDef="entity">
          <th mat-header-cell *matHeaderCellDef>Entity</th>
          <td mat-cell *matCellDef="let activity">
            <div class="entity-cell">
              <div class="entity-name">{{ activity.entity }}</div>
              <div class="entity-id">ID: {{ activity.entityId }}</div>
              <div class="description">{{ activity.description }}</div>
            </div>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let activity">
            <mat-chip [ngClass]="getStatusClass(activity.status)">
              {{ activity.status | uppercase }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let activity">
            <button mat-icon-button 
                    [matMenuTriggerFor]="activityMenu"
                    matTooltip="Actions">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #activityMenu="matMenu">
              <button mat-menu-item (click)="viewDetails(activity)">
                <mat-icon>visibility</mat-icon>
                View Details
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>

    <mat-paginator
      [length]="totalItems"
      [pageSize]="pageSize"
      [pageSizeOptions]="[10, 20, 50, 100]"
      [pageIndex]="pageIndex"
      (page)="handlePageEvent($event)"
      showFirstLastButtons>
    </mat-paginator>
  </mat-card>
</div>

<!-- Detail Dialog -->
<div class="detail-overlay" *ngIf="showDetailDialog" (click)="closeDetailDialog()">
  <div class="detail-dialog" (click)="$event.stopPropagation()" *ngIf="selectedActivity">
    <div class="dialog-header">
      <h2>
        <mat-icon>info</mat-icon>
        Activity Details
      </h2>
      <button mat-icon-button (click)="closeDetailDialog()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="dialog-content">
      <div class="detail-section">
        <h3>Basic Information</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">Activity ID:</span>
            <span class="detail-value">{{ selectedActivity.id }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Timestamp:</span>
            <span class="detail-value">{{ formatDate(selectedActivity.timestamp) }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">User:</span>
            <span class="detail-value">{{ selectedActivity.user }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">User ID:</span>
            <span class="detail-value">{{ selectedActivity.userId }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Role:</span>
            <span class="detail-value">{{ selectedActivity.role }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Status:</span>
            <mat-chip [ngClass]="getStatusClass(selectedActivity.status)">
              {{ selectedActivity.status | uppercase }}
            </mat-chip>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h3>Action Details</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">Action:</span>
            <mat-chip [ngClass]="getActionClass(selectedActivity.action)">
              {{ selectedActivity.action | uppercase }}
            </mat-chip>
          </div>
          <div class="detail-item">
            <span class="detail-label">Category:</span>
            <span class="detail-value">
              <mat-icon>{{ getCategoryIcon(selectedActivity.category) }}</mat-icon>
              {{ selectedActivity.category }}
            </span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Entity:</span>
            <span class="detail-value">{{ selectedActivity.entity }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Entity ID:</span>
            <span class="detail-value">{{ selectedActivity.entityId }}</span>
          </div>
          <div class="detail-item full-width">
            <span class="detail-label">Description:</span>
            <span class="detail-value">{{ selectedActivity.description }}</span>
          </div>
        </div>
      </div>

      <div class="detail-section" *ngIf="selectedActivity.changes && selectedActivity.changes.length > 0">
        <h3>Changes</h3>
        <div class="changes-list">
          <div class="change-item" *ngFor="let change of selectedActivity.changes">
            <div class="change-field">{{ change.field }}</div>
            <div class="change-values">
              <div class="old-value">
                <span class="label">Old:</span>
                <span class="value">{{ change.oldValue }}</span>
              </div>
              <mat-icon>arrow_forward</mat-icon>
              <div class="new-value">
                <span class="label">New:</span>
                <span class="value">{{ change.newValue }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h3>Technical Information</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">IP Address:</span>
            <span class="detail-value">{{ selectedActivity.ipAddress }}</span>
          </div>
          <div class="detail-item full-width">
            <span class="detail-label">User Agent:</span>
            <span class="detail-value user-agent">{{ selectedActivity.userAgent }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="dialog-actions">
      <button mat-raised-button (click)="closeDetailDialog()">Close</button>
    </div>
  </div>
</div>
