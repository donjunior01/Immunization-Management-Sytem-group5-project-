<div class="print-container">
  <!-- Screen Actions (hidden when printing) -->
  <div class="screen-only actions-bar">
    <button mat-button (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
      Back to History
    </button>
    <button mat-raised-button color="primary" (click)="printCard()">
      <mat-icon>print</mat-icon>
      Print Card
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-overlay">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading vaccination card...</p>
  </div>

  <!-- Vaccination Card (print-friendly) -->
  <div *ngIf="!isLoading && patient" class="vaccination-card">
    <!-- Card Header -->
    <div class="card-header">
      <div class="header-content">
        <div class="logo-section">
          <mat-icon class="large-icon">vaccines</mat-icon>
          <div class="title-section">
            <h1>VACCINATION CARD</h1>
            <p class="subtitle">National Immunization Program</p>
          </div>
        </div>
        <div class="qr-section">
          <qrcode 
            [qrdata]="qrCodeData" 
            [width]="100" 
            [errorCorrectionLevel]="'M'">
          </qrcode>
          <p class="qr-label">Scan for Details</p>
        </div>
      </div>
    </div>

    <!-- Patient Information -->
    <mat-card class="patient-info-card">
      <mat-card-header>
        <mat-icon mat-card-avatar>person</mat-icon>
        <mat-card-title>Patient Information</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Full Name:</span>
            <span class="value">{{ patient.fullName }}</span>
          </div>
          <div class="info-item">
            <span class="label">Date of Birth:</span>
            <span class="value">{{ patient.dateOfBirth | date: 'mediumDate' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Age:</span>
            <span class="value">{{ getAge(patient.dateOfBirth) }}</span>
          </div>
          <div class="info-item">
            <span class="label">Patient ID:</span>
            <span class="value">{{ patient.id }}</span>
          </div>
          <div class="info-item">
            <span class="label">Guardian Name:</span>
            <span class="value">{{ patient.guardianName }}</span>
          </div>
          <div class="info-item">
            <span class="label">Phone Number:</span>
            <span class="value">{{ patient.phoneNumber || 'N/A' }}</span>
          </div>
          <div class="info-item full-width">
            <span class="label">Address:</span>
            <span class="value">{{ patient.address }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Vaccination Summary -->
    <mat-card class="summary-card">
      <mat-card-content>
        <div class="summary-grid">
          <div class="summary-item">
            <mat-icon>local_hospital</mat-icon>
            <div class="summary-details">
              <span class="summary-label">Status</span>
              <span class="summary-value">{{ getVaccinationStatus() }}</span>
            </div>
          </div>
          <div class="summary-item">
            <mat-icon>event</mat-icon>
            <div class="summary-details">
              <span class="summary-label">Last Vaccination</span>
              <span class="summary-value">
                {{ vaccinations.length > 0 ? (vaccinations[0].dateAdministered | date: 'mediumDate') : 'None' }}
              </span>
            </div>
          </div>
          <div class="summary-item">
            <mat-icon>schedule</mat-icon>
            <div class="summary-details">
              <span class="summary-label">Next Due</span>
              <span class="summary-value">{{ getNextDueVaccine() }}</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Vaccination History Table -->
    <mat-card class="history-card">
      <mat-card-header>
        <mat-icon mat-card-avatar>history</mat-icon>
        <mat-card-title>Vaccination History</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container" *ngIf="vaccinations.length > 0">
          <table mat-table [dataSource]="vaccinations" class="vaccination-table">
            <!-- Date Column -->
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef>Date</th>
              <td mat-cell *matCellDef="let vaccination">
                {{ vaccination.dateAdministered | date: 'dd/MM/yyyy' }}
              </td>
            </ng-container>

            <!-- Vaccine Column -->
            <ng-container matColumnDef="vaccine">
              <th mat-header-cell *matHeaderCellDef>Vaccine</th>
              <td mat-cell *matCellDef="let vaccination">
                <strong>{{ vaccination.vaccineName }}</strong>
                <div class="facility-name">{{ vaccination.facilityName }}</div>
              </td>
            </ng-container>

            <!-- Dose Column -->
            <ng-container matColumnDef="dose">
              <th mat-header-cell *matHeaderCellDef>Dose</th>
              <td mat-cell *matCellDef="let vaccination">
                <span class="dose-badge">
                  {{ vaccination.doseNumber === 4 ? 'Booster' : 'Dose ' + vaccination.doseNumber }}
                </span>
              </td>
            </ng-container>

            <!-- Batch Number Column -->
            <ng-container matColumnDef="batch">
              <th mat-header-cell *matHeaderCellDef>Batch Number</th>
              <td mat-cell *matCellDef="let vaccination">{{ vaccination.batchNumber || 'Batch ' + vaccination.batchId }}</td>
            </ng-container>

            <!-- Administered By Column -->
            <ng-container matColumnDef="administeredBy">
              <th mat-header-cell *matHeaderCellDef>Administered By</th>
              <td mat-cell *matCellDef="let vaccination">Nurse {{ vaccination.nurseId }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>

        <!-- No Data State -->
        <div *ngIf="vaccinations.length === 0" class="no-data">
          <mat-icon>info</mat-icon>
          <p>No vaccination records found</p>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Important Notes -->
    <mat-card class="notes-card">
      <mat-card-header>
        <mat-icon mat-card-avatar>info</mat-icon>
        <mat-card-title>Important Notes</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <ul class="notes-list">
          <li>Keep this card safe and bring it to all vaccination appointments</li>
          <li>Follow the recommended immunization schedule</li>
          <li>Report any adverse reactions to your health facility immediately</li>
          <li>This card is valid for all health facilities in the country</li>
          <li>QR code can be scanned for digital verification</li>
        </ul>
      </mat-card-content>
    </mat-card>

    <!-- Card Footer -->
    <div class="card-footer">
      <div class="footer-content">
        <div class="footer-item">
          <strong>Issued On:</strong> {{ currentDate | date: 'medium' }}
        </div>
        <div class="footer-item">
          <strong>Valid Throughout:</strong> National Territory
        </div>
        <div class="footer-item">
          <strong>Contact:</strong> +254 700 000 000 | immunization&#64;health.gov
        </div>
      </div>
    </div>
  </div>
</div>
