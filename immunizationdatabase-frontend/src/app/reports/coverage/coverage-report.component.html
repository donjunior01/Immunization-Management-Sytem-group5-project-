<div class="coverage-report-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-left">
      <mat-icon class="header-icon">assessment</mat-icon>
      <div class="header-text">
        <h1>Coverage Report</h1>
        <p>Comprehensive vaccination coverage analysis and trends</p>
      </div>
    </div>
    <div class="header-actions">
      <button mat-raised-button class="refresh-btn" (click)="refreshReport()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
      <button mat-raised-button class="export-btn" [matMenuTriggerFor]="exportMenu">
        <mat-icon>download</mat-icon>
        Export
        <mat-icon>arrow_drop_down</mat-icon>
      </button>
      <mat-menu #exportMenu="matMenu">
        <button mat-menu-item (click)="exportReport('csv')">
          <mat-icon>description</mat-icon>
          Export as CSV
        </button>
        <button mat-menu-item (click)="exportReport('pdf')">
          <mat-icon>picture_as_pdf</mat-icon>
          Export as PDF
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- Filters Section -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-grid">
        <mat-form-field appearance="outline">
          <mat-label>Start Date</mat-label>
          <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate">
          <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>End Date</mat-label>
          <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate">
          <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>District</mat-label>
          <mat-select [(ngModel)]="selectedDistrict">
            <mat-option *ngFor="let district of districtOptions" [value]="district">
              {{ district }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Vaccine</mat-label>
          <mat-select [(ngModel)]="selectedVaccine">
            <mat-option *ngFor="let vaccine of vaccineOptions" [value]="vaccine">
              {{ vaccine }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="filter-actions">
        <button mat-raised-button color="primary" (click)="applyFilters()">
          <mat-icon>filter_alt</mat-icon>
          Apply Filters
        </button>
        <button mat-button (click)="resetFilters()">Reset</button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- KPI Cards -->
  <div class="kpi-grid">
    <mat-card class="kpi-card total-coverage">
      <mat-card-content>
        <div class="kpi-icon">
          <mat-icon>vaccine</mat-icon>
        </div>
        <div class="kpi-details">
          <div class="kpi-label">Total Coverage Rate</div>
          <div class="kpi-value">{{ kpis.totalCoverageRate }}%</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="kpi-card fully-vaccinated">
      <mat-card-content>
        <div class="kpi-icon">
          <mat-icon>check_circle</mat-icon>
        </div>
        <div class="kpi-details">
          <div class="kpi-label">Fully Vaccinated</div>
          <div class="kpi-value">{{ kpis.fullyVaccinated }}</div>
          <div class="kpi-sublabel">Children</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="kpi-card partially-vaccinated">
      <mat-card-content>
        <div class="kpi-icon">
          <mat-icon>hourglass_empty</mat-icon>
        </div>
        <div class="kpi-details">
          <div class="kpi-label">Partially Vaccinated</div>
          <div class="kpi-value">{{ kpis.partiallyVaccinated }}</div>
          <div class="kpi-sublabel">Children</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="kpi-card unvaccinated">
      <mat-card-content>
        <div class="kpi-icon">
          <mat-icon>cancel</mat-icon>
        </div>
        <div class="kpi-details">
          <div class="kpi-label">Unvaccinated</div>
          <div class="kpi-value">{{ kpis.unvaccinated }}</div>
          <div class="kpi-sublabel">Children</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="kpi-card dropout-rate">
      <mat-card-content>
        <div class="kpi-icon">
          <mat-icon>trending_down</mat-icon>
        </div>
        <div class="kpi-details">
          <div class="kpi-label">Dropout Rate</div>
          <div class="kpi-value">{{ kpis.dropoutRate }}%</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="kpi-card on-time-rate">
      <mat-card-content>
        <div class="kpi-icon">
          <mat-icon>schedule</mat-icon>
        </div>
        <div class="kpi-details">
          <div class="kpi-label">On-Time Rate</div>
          <div class="kpi-value">{{ kpis.onTimeRate }}%</div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Coverage by Vaccine -->
  <mat-card class="coverage-card">
    <mat-card-header>
      <mat-card-title>Coverage by Vaccine Type</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="vaccine-list">
        <div class="vaccine-item" *ngFor="let vaccine of vaccineCoverageData">
          <div class="vaccine-header">
            <span class="vaccine-name">{{ vaccine.vaccineName }}</span>
            <mat-chip [ngClass]="getVaccineStatusClass(vaccine.status)">
              {{ vaccine.status }}
            </mat-chip>
          </div>
          <div class="vaccine-stats">
            <span>{{ vaccine.vaccinated }} / {{ vaccine.targetPopulation }}</span>
            <span class="coverage-percentage">{{ vaccine.coverageRate }}%</span>
          </div>
          <div class="vaccine-bars">
            <div class="target-bar" [style.width.%]="vaccine.targetRate"></div>
            <div class="actual-bar" [style.width.%]="vaccine.coverageRate" 
                 [style.background-color]="getCoverageColor(vaccine.coverageRate)"></div>
          </div>
          <div class="vaccine-legend">
            <span class="target-legend">Target: {{ vaccine.targetRate }}%</span>
            <span class="actual-legend">Actual: {{ vaccine.coverageRate }}%</span>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Coverage by Age Group -->
  <mat-card class="coverage-card">
    <mat-card-header>
      <mat-card-title>Coverage by Age Group</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="age-group-list">
        <div class="age-group-item" *ngFor="let group of ageGroupData">
          <div class="age-group-header">
            <div class="age-group-info">
              <span class="age-group-name">{{ group.ageGroup }}</span>
              <span class="age-range">{{ group.ageRange }}</span>
            </div>
            <span class="age-coverage">{{ group.coverageRate }}%</span>
          </div>
          <mat-progress-bar mode="determinate" [value]="group.coverageRate" 
                            [color]="group.coverageRate >= 90 ? 'primary' : 'accent'">
          </mat-progress-bar>
          <div class="age-group-breakdown">
            <div class="breakdown-item">
              <mat-icon class="breakdown-icon fully">check_circle</mat-icon>
              <span>Fully: {{ group.fullyVaccinated }}</span>
            </div>
            <div class="breakdown-item">
              <mat-icon class="breakdown-icon partial">hourglass_empty</mat-icon>
              <span>Partially: {{ group.partiallyVaccinated }}</span>
            </div>
            <div class="breakdown-item">
              <span class="target-text">Target: {{ group.targetPopulation }}</span>
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Coverage Trends -->
  <mat-card class="coverage-card">
    <mat-card-header>
      <mat-card-title>Coverage Trends (6 Months)</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="trends-chart">
        <div class="chart-row" *ngFor="let trend of coverageTrends">
          <div class="month-label">{{ trend.month }}</div>
          <div class="trend-bars">
            <div class="trend-bar fully" 
                 [style.width.%]="(trend.fullyVaccinated / 1500) * 100"
                 matTooltip="Fully Vaccinated: {{ trend.fullyVaccinated }}">
            </div>
            <div class="trend-bar partial" 
                 [style.width.%]="(trend.partiallyVaccinated / 1500) * 100"
                 matTooltip="Partially Vaccinated: {{ trend.partiallyVaccinated }}">
            </div>
          </div>
          <div class="coverage-rate-label">{{ trend.coverageRate }}%</div>
        </div>
      </div>
      <div class="chart-legend">
        <div class="legend-item">
          <span class="legend-color fully"></span>
          <span>Fully Vaccinated</span>
        </div>
        <div class="legend-item">
          <span class="legend-color partial"></span>
          <span>Partially Vaccinated</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Geographical Coverage -->
  <mat-card class="coverage-card">
    <mat-card-header>
      <mat-card-title>Geographical Coverage by District</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <table mat-table [dataSource]="geographicalData" class="coverage-table">
        <ng-container matColumnDef="district">
          <th mat-header-cell *matHeaderCellDef>District</th>
          <td mat-cell *matCellDef="let row">{{ row.district }}</td>
        </ng-container>

        <ng-container matColumnDef="facilities">
          <th mat-header-cell *matHeaderCellDef>Facilities</th>
          <td mat-cell *matCellDef="let row">{{ row.facilities }}</td>
        </ng-container>

        <ng-container matColumnDef="target">
          <th mat-header-cell *matHeaderCellDef>Target</th>
          <td mat-cell *matCellDef="let row">{{ row.targetPopulation }}</td>
        </ng-container>

        <ng-container matColumnDef="vaccinated">
          <th mat-header-cell *matHeaderCellDef>Vaccinated</th>
          <td mat-cell *matCellDef="let row">{{ row.vaccinated }}</td>
        </ng-container>

        <ng-container matColumnDef="coverage">
          <th mat-header-cell *matHeaderCellDef>Coverage</th>
          <td mat-cell *matCellDef="let row">{{ row.coverageRate }}%</td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let row">
            <mat-chip [ngClass]="getGeoStatusClass(row.status)">
              {{ row.status }}
            </mat-chip>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="geoDisplayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: geoDisplayedColumns;"></tr>
      </table>
    </mat-card-content>
  </mat-card>

  <!-- Demographic Analysis -->
  <mat-card class="coverage-card">
    <mat-card-header>
      <mat-card-title>Demographic Analysis</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="demographic-grid">
        <div class="demographic-item" *ngFor="let demo of demographicData">
          <h3 class="demo-category">{{ demo.category }}</h3>
          <div class="demo-stats">
            <div class="demo-stat male">
              <mat-icon>male</mat-icon>
              <div class="stat-details">
                <span class="stat-count">{{ demo.male }}</span>
                <span class="stat-percentage">{{ demo.malePercentage }}%</span>
              </div>
            </div>
            <div class="demo-stat female">
              <mat-icon>female</mat-icon>
              <div class="stat-details">
                <span class="stat-count">{{ demo.female }}</span>
                <span class="stat-percentage">{{ demo.femalePercentage }}%</span>
              </div>
            </div>
          </div>
          <div class="demo-total">Total: {{ demo.total }} children</div>
          <div class="demo-bars">
            <div class="demo-bar male" [style.width.%]="demo.malePercentage"></div>
            <div class="demo-bar female" [style.width.%]="demo.femalePercentage"></div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Defaulters Tracking -->
  <mat-card class="coverage-card">
    <mat-card-header>
      <mat-card-title>Defaulters Tracking</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <table mat-table [dataSource]="defaulterData" class="coverage-table">
        <ng-container matColumnDef="vaccine">
          <th mat-header-cell *matHeaderCellDef>Vaccine</th>
          <td mat-cell *matCellDef="let row">{{ row.vaccine }}</td>
        </ng-container>

        <ng-container matColumnDef="due">
          <th mat-header-cell *matHeaderCellDef>Due Patients</th>
          <td mat-cell *matCellDef="let row">{{ row.duePatients }}</td>
        </ng-container>

        <ng-container matColumnDef="missed">
          <th mat-header-cell *matHeaderCellDef>Missed Doses</th>
          <td mat-cell *matCellDef="let row">{{ row.missedDoses }}</td>
        </ng-container>

        <ng-container matColumnDef="rate">
          <th mat-header-cell *matHeaderCellDef>Defaulter Rate</th>
          <td mat-cell *matCellDef="let row">{{ row.defaulterRate }}%</td>
        </ng-container>

        <ng-container matColumnDef="priority">
          <th mat-header-cell *matHeaderCellDef>Priority</th>
          <td mat-cell *matCellDef="let row">
            <mat-chip [ngClass]="getPriorityClass(row.priority)">
              {{ row.priority }}
            </mat-chip>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let row">
            <button mat-icon-button color="primary" 
                    (click)="contactDefaulters(row.vaccine)"
                    matTooltip="Contact Defaulters">
              <mat-icon>contact_phone</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="defaulterDisplayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: defaulterDisplayedColumns;"></tr>
      </table>
    </mat-card-content>
  </mat-card>
</div>
