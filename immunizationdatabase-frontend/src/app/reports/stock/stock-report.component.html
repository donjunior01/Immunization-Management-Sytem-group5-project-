<div class="stock-report-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-left">
      <div class="header-icon">
        <mat-icon>bar_chart</mat-icon>
      </div>
      <div class="header-title">
        <h1>Stock Report</h1>
        <p class="subtitle">Comprehensive stock usage, wastage, and turnover analytics</p>
      </div>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="refreshReport()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
      <button mat-raised-button [matMenuTriggerFor]="exportMenu">
        <mat-icon>download</mat-icon>
        Export
      </button>
      <mat-menu #exportMenu="matMenu">
        <button mat-menu-item (click)="exportReport('csv')">
          <mat-icon>description</mat-icon>
          <span>Export as CSV</span>
        </button>
        <button mat-menu-item (click)="exportReport('pdf')">
          <mat-icon>picture_as_pdf</mat-icon>
          <span>Export as PDF</span>
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- Filters Card -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-grid">
        <mat-form-field appearance="outline">
          <mat-label>Start Date</mat-label>
          <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate">
          <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>End Date</mat-label>
          <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate">
          <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Vaccine</mat-label>
          <mat-select [(ngModel)]="selectedVaccine">
            <mat-option *ngFor="let vaccine of vaccineOptions" [value]="vaccine">
              {{ vaccine }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Period</mat-label>
          <mat-select [(ngModel)]="selectedPeriod">
            <mat-option *ngFor="let period of periodOptions" [value]="period.value">
              {{ period.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="filter-actions">
        <button mat-raised-button color="primary" (click)="applyFilters()">Apply Filters</button>
        <button mat-button (click)="resetFilters()">Reset</button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- KPI Cards Grid -->
  <div class="kpi-grid">
    <mat-card class="kpi-card">
      <div class="kpi-icon total-consumption">
        <mat-icon>inventory_2</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Total Consumption</div>
        <div class="kpi-value">{{ kpis.totalConsumption }}</div>
        <div class="kpi-subtitle">Doses administered</div>
      </div>
    </mat-card>

    <mat-card class="kpi-card">
      <div class="kpi-icon wastage-rate">
        <mat-icon>delete_outline</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Wastage Rate</div>
        <div class="kpi-value">{{ kpis.wastageRate }}%</div>
        <div class="kpi-subtitle">Of total stock</div>
      </div>
    </mat-card>

    <mat-card class="kpi-card">
      <div class="kpi-icon stock-turnover">
        <mat-icon>sync_alt</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Stock Turnover</div>
        <div class="kpi-value">{{ kpis.stockTurnover }}</div>
        <div class="kpi-subtitle">Times per year</div>
      </div>
    </mat-card>

    <mat-card class="kpi-card">
      <div class="kpi-icon reorder-frequency">
        <mat-icon>shopping_cart</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Reorder Frequency</div>
        <div class="kpi-value">{{ kpis.reorderFrequency }}</div>
        <div class="kpi-subtitle">Orders per year</div>
      </div>
    </mat-card>

    <mat-card class="kpi-card">
      <div class="kpi-icon average-usage">
        <mat-icon>show_chart</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Average Usage</div>
        <div class="kpi-value">{{ kpis.averageUsage }}</div>
        <div class="kpi-subtitle">Doses per month</div>
      </div>
    </mat-card>

    <mat-card class="kpi-card">
      <div class="kpi-icon utilization-rate">
        <mat-icon>speed</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Utilization Rate</div>
        <div class="kpi-value">{{ kpis.utilizationRate }}%</div>
        <div class="kpi-subtitle">Stock efficiency</div>
      </div>
    </mat-card>
  </div>

  <!-- Usage Patterns Section -->
  <mat-card class="section-card">
    <div class="section-header">
      <mat-icon>trending_up</mat-icon>
      <h2>Usage Patterns</h2>
    </div>
    <div class="table-container">
      <table mat-table [dataSource]="usagePatterns" class="usage-table">
        <ng-container matColumnDef="vaccine">
          <th mat-header-cell *matHeaderCellDef>Vaccine</th>
          <td mat-cell *matCellDef="let pattern">{{ pattern.vaccineName }}</td>
        </ng-container>

        <ng-container matColumnDef="totalUsed">
          <th mat-header-cell *matHeaderCellDef>Total Used</th>
          <td mat-cell *matCellDef="let pattern">{{ pattern.totalUsed }} doses</td>
        </ng-container>

        <ng-container matColumnDef="averageMonthly">
          <th mat-header-cell *matHeaderCellDef>Avg Monthly</th>
          <td mat-cell *matCellDef="let pattern">{{ pattern.averageMonthly }} doses</td>
        </ng-container>

        <ng-container matColumnDef="peakMonth">
          <th mat-header-cell *matHeaderCellDef>Peak Period</th>
          <td mat-cell *matCellDef="let pattern">
            {{ pattern.peakMonth }}<br>
            <span class="peak-usage">({{ pattern.peakUsage }} doses)</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="trend">
          <th mat-header-cell *matHeaderCellDef>Trend</th>
          <td mat-cell *matCellDef="let pattern">
            <div class="trend-indicator" [ngClass]="getTrendClass(pattern.trend)">
              <mat-icon>{{ getTrendIcon(pattern.trend) }}</mat-icon>
              <span>{{ pattern.trend }}</span>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="growth">
          <th mat-header-cell *matHeaderCellDef>Growth Rate</th>
          <td mat-cell *matCellDef="let pattern">
            <span [ngClass]="getTrendClass(pattern.trend)">{{ pattern.growthRate }}%</span>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="usageDisplayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: usageDisplayedColumns;"></tr>
      </table>
    </div>
  </mat-card>

  <!-- Monthly Usage Chart -->
  <mat-card class="section-card">
    <div class="section-header">
      <mat-icon>insert_chart</mat-icon>
      <h2>Monthly Usage Trends</h2>
    </div>
    <div class="chart-container">
      <div class="chart-legend">
        <div class="legend-item"><span class="legend-color bcg-color"></span> BCG</div>
        <div class="legend-item"><span class="legend-color opv-color"></span> OPV</div>
        <div class="legend-item"><span class="legend-color dtp-color"></span> DTP</div>
        <div class="legend-item"><span class="legend-color measles-color"></span> Measles</div>
        <div class="legend-item"><span class="legend-color hepatitis-color"></span> Hepatitis B</div>
        <div class="legend-item"><span class="legend-color polio-color"></span> Polio</div>
      </div>
      <div class="monthly-chart">
        <div *ngFor="let month of monthlyUsage" class="month-bar-group">
          <div class="month-label">{{ month.month }}</div>
          <div class="stacked-bars">
            <div class="vaccine-bar bcg-bar" 
                 [style.height.%]="month.bcg / 3.12"
                 [matTooltip]="'BCG: ' + month.bcg">
            </div>
            <div class="vaccine-bar opv-bar" 
                 [style.height.%]="month.opv / 2.45"
                 [matTooltip]="'OPV: ' + month.opv">
            </div>
            <div class="vaccine-bar dtp-bar" 
                 [style.height.%]="month.dtp / 1.98"
                 [matTooltip]="'DTP: ' + month.dtp">
            </div>
            <div class="vaccine-bar measles-bar" 
                 [style.height.%]="month.measles / 1.76"
                 [matTooltip]="'Measles: ' + month.measles">
            </div>
            <div class="vaccine-bar hepatitis-bar" 
                 [style.height.%]="month.hepatitis / 1.34"
                 [matTooltip]="'Hepatitis B: ' + month.hepatitis">
            </div>
            <div class="vaccine-bar polio-bar" 
                 [style.height.%]="month.polio / 1.18"
                 [matTooltip]="'Polio: ' + month.polio">
            </div>
          </div>
        </div>
      </div>
    </div>
  </mat-card>

  <!-- Wastage Analysis Section -->
  <mat-card class="section-card">
    <div class="section-header">
      <mat-icon>warning</mat-icon>
      <h2>Wastage Analysis</h2>
    </div>
    <div class="table-container">
      <table mat-table [dataSource]="wastageData" class="wastage-table">
        <ng-container matColumnDef="vaccine">
          <th mat-header-cell *matHeaderCellDef>Vaccine</th>
          <td mat-cell *matCellDef="let wastage">{{ wastage.vaccineName }}</td>
        </ng-container>

        <ng-container matColumnDef="totalWasted">
          <th mat-header-cell *matHeaderCellDef>Total Wasted</th>
          <td mat-cell *matCellDef="let wastage">{{ wastage.totalWasted }} doses</td>
        </ng-container>

        <ng-container matColumnDef="wastageRate">
          <th mat-header-cell *matHeaderCellDef>Wastage Rate</th>
          <td mat-cell *matCellDef="let wastage">{{ wastage.wastageRate }}%</td>
        </ng-container>

        <ng-container matColumnDef="expiry">
          <th mat-header-cell *matHeaderCellDef>Expiry</th>
          <td mat-cell *matCellDef="let wastage">
            <div class="wastage-breakdown">
              <mat-icon class="breakdown-icon">event_busy</mat-icon>
              {{ wastage.expiryWaste }}
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="damage">
          <th mat-header-cell *matHeaderCellDef>Damage</th>
          <td mat-cell *matCellDef="let wastage">
            <div class="wastage-breakdown">
              <mat-icon class="breakdown-icon">broken_image</mat-icon>
              {{ wastage.damageWaste }}
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="costImpact">
          <th mat-header-cell *matHeaderCellDef>Cost Impact</th>
          <td mat-cell *matCellDef="let wastage">${{ wastage.costImpact }}</td>
        </ng-container>

        <ng-container matColumnDef="severity">
          <th mat-header-cell *matHeaderCellDef>Severity</th>
          <td mat-cell *matCellDef="let wastage">
            <mat-chip [ngClass]="getSeverityClass(wastage.severity)">
              {{ wastage.severity }}
            </mat-chip>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="wastageDisplayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: wastageDisplayedColumns;"></tr>
      </table>
    </div>
  </mat-card>

  <!-- Stock Turnover Section -->
  <mat-card class="section-card">
    <div class="section-header">
      <mat-icon>autorenew</mat-icon>
      <h2>Stock Turnover Analysis</h2>
    </div>
    <div class="table-container">
      <table mat-table [dataSource]="turnoverData" class="turnover-table">
        <ng-container matColumnDef="vaccine">
          <th mat-header-cell *matHeaderCellDef>Vaccine</th>
          <td mat-cell *matCellDef="let turnover">{{ turnover.vaccineName }}</td>
        </ng-container>

        <ng-container matColumnDef="turnoverRate">
          <th mat-header-cell *matHeaderCellDef>Turnover Rate</th>
          <td mat-cell *matCellDef="let turnover">{{ turnover.turnoverRate }}x</td>
        </ng-container>

        <ng-container matColumnDef="averageStock">
          <th mat-header-cell *matHeaderCellDef>Avg Stock</th>
          <td mat-cell *matCellDef="let turnover">{{ turnover.averageStock }} doses</td>
        </ng-container>

        <ng-container matColumnDef="daysInStock">
          <th mat-header-cell *matHeaderCellDef>Days in Stock</th>
          <td mat-cell *matCellDef="let turnover">{{ turnover.daysInStock }} days</td>
        </ng-container>

        <ng-container matColumnDef="reorderPoint">
          <th mat-header-cell *matHeaderCellDef>Reorder Point</th>
          <td mat-cell *matCellDef="let turnover">{{ turnover.reorderPoint }} doses</td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let turnover">
            <mat-chip [ngClass]="getTurnoverStatusClass(turnover.status)">
              {{ turnover.status }}
            </mat-chip>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="turnoverDisplayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: turnoverDisplayedColumns;"></tr>
      </table>
    </div>
  </mat-card>

  <!-- Reorder Analytics Section -->
  <mat-card class="section-card">
    <div class="section-header">
      <mat-icon>shopping_cart</mat-icon>
      <h2>Reorder Analytics</h2>
    </div>
    <div class="reorder-actions">
      <button mat-raised-button color="accent" (click)="generateReorderList()">
        <mat-icon>list_alt</mat-icon>
        Generate Reorder List
      </button>
    </div>
    <div class="table-container">
      <table mat-table [dataSource]="reorderAnalytics" class="reorder-table">
        <ng-container matColumnDef="vaccine">
          <th mat-header-cell *matHeaderCellDef>Vaccine</th>
          <td mat-cell *matCellDef="let reorder">{{ reorder.vaccineName }}</td>
        </ng-container>

        <ng-container matColumnDef="currentStock">
          <th mat-header-cell *matHeaderCellDef>Current Stock</th>
          <td mat-cell *matCellDef="let reorder">{{ reorder.currentStock }} doses</td>
        </ng-container>

        <ng-container matColumnDef="reorderLevel">
          <th mat-header-cell *matHeaderCellDef>Reorder Level</th>
          <td mat-cell *matCellDef="let reorder">{{ reorder.reorderLevel }} doses</td>
        </ng-container>

        <ng-container matColumnDef="optimalOrder">
          <th mat-header-cell *matHeaderCellDef>Optimal Order</th>
          <td mat-cell *matCellDef="let reorder">{{ reorder.optimalOrder }} doses</td>
        </ng-container>

        <ng-container matColumnDef="leadTime">
          <th mat-header-cell *matHeaderCellDef>Lead Time</th>
          <td mat-cell *matCellDef="let reorder">{{ reorder.leadTime }} days</td>
        </ng-container>

        <ng-container matColumnDef="nextDue">
          <th mat-header-cell *matHeaderCellDef>Next Order Due</th>
          <td mat-cell *matCellDef="let reorder">{{ reorder.nextOrderDue }}</td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let reorder">
            <mat-chip [ngClass]="getReorderStatusClass(reorder.status)">
              {{ reorder.status }}
            </mat-chip>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="reorderDisplayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: reorderDisplayedColumns;"></tr>
      </table>
    </div>
  </mat-card>

  <!-- Stock Movements Section -->
  <mat-card class="section-card">
    <div class="section-header">
      <mat-icon>history</mat-icon>
      <h2>Recent Stock Movements</h2>
    </div>
    <div class="table-container">
      <table mat-table [dataSource]="stockMovements" class="movements-table">
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef>Date</th>
          <td mat-cell *matCellDef="let movement">{{ movement.date }}</td>
        </ng-container>

        <ng-container matColumnDef="vaccine">
          <th mat-header-cell *matHeaderCellDef>Vaccine</th>
          <td mat-cell *matCellDef="let movement">{{ movement.vaccineName }}</td>
        </ng-container>

        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef>Type</th>
          <td mat-cell *matCellDef="let movement">
            <mat-chip [ngClass]="getMovementTypeClass(movement.movementType)">
              {{ movement.movementType }}
            </mat-chip>
          </td>
        </ng-container>

        <ng-container matColumnDef="quantity">
          <th mat-header-cell *matHeaderCellDef>Quantity</th>
          <td mat-cell *matCellDef="let movement">{{ movement.quantity }} doses</td>
        </ng-container>

        <ng-container matColumnDef="remaining">
          <th mat-header-cell *matHeaderCellDef>Remaining</th>
          <td mat-cell *matCellDef="let movement">{{ movement.remainingStock }} doses</td>
        </ng-container>

        <ng-container matColumnDef="batch">
          <th mat-header-cell *matHeaderCellDef>Batch</th>
          <td mat-cell *matCellDef="let movement">{{ movement.batchNumber }}</td>
        </ng-container>

        <ng-container matColumnDef="notes">
          <th mat-header-cell *matHeaderCellDef>Notes</th>
          <td mat-cell *matCellDef="let movement">{{ movement.notes }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="movementDisplayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: movementDisplayedColumns;"></tr>
      </table>
    </div>
  </mat-card>
</div>
