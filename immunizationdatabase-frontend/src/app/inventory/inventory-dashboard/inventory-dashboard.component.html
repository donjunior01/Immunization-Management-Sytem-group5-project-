<div class="inventory-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <mat-icon class="page-icon">inventory_2</mat-icon>
      <h1 class="page-title">Facility Inventory Dashboard</h1>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="refreshInventory()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
      <button mat-raised-button color="accent" (click)="addNewBatch()">
        <mat-icon>add</mat-icon>
        Add Batch
      </button>
      <button mat-raised-button (click)="exportInventoryReport()">
        <mat-icon>download</mat-icon>
        Export Report
      </button>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="kpi-grid">
    <mat-card class="kpi-card">
      <div class="kpi-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <mat-icon>inventory</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Total Batches</div>
        <div class="kpi-value">{{ kpis.totalBatches }}</div>
        <div class="kpi-sublabel">In facility</div>
      </div>
    </mat-card>

    <mat-card class="kpi-card">
      <div class="kpi-icon" style="background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%);">
        <mat-icon>vaccines</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Active Vaccines</div>
        <div class="kpi-value">{{ kpis.activeVaccines }}</div>
        <div class="kpi-sublabel">Types available</div>
      </div>
    </mat-card>

    <mat-card class="kpi-card">
      <div class="kpi-icon" style="background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);">
        <mat-icon>warning</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Low Stock Alerts</div>
        <div class="kpi-value">{{ kpis.lowStockAlerts }}</div>
        <div class="kpi-sublabel">Requires attention</div>
      </div>
    </mat-card>

    <mat-card class="kpi-card">
      <div class="kpi-icon" style="background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);">
        <mat-icon>schedule</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Expiring Soon</div>
        <div class="kpi-value">{{ kpis.expiringSoon }}</div>
        <div class="kpi-sublabel">Within 30 days</div>
      </div>
    </mat-card>

    <mat-card class="kpi-card">
      <div class="kpi-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
        <mat-icon>medical_services</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Total Doses</div>
        <div class="kpi-value">{{ kpis.totalDoses | number }}</div>
        <div class="kpi-sublabel">Available</div>
      </div>
    </mat-card>

    <mat-card class="kpi-card">
      <div class="kpi-icon" style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);">
        <mat-icon>trending_up</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Utilization Rate</div>
        <div class="kpi-value">{{ kpis.utilizationRate }}%</div>
        <div class="kpi-sublabel">Overall usage</div>
      </div>
    </mat-card>
  </div>

  <!-- Stock Alerts Section -->
  <mat-card class="alerts-section" *ngIf="stockAlerts.length > 0">
    <div class="section-header">
      <mat-icon class="section-icon">notifications_active</mat-icon>
      <h2>Stock Alerts</h2>
      <span class="alert-count">{{ stockAlerts.length }} alerts</span>
    </div>
    <div class="alerts-grid">
      <div class="alert-item" *ngFor="let alert of stockAlerts.slice(0, 6)" [ngClass]="getSeverityClass(alert.severity)">
        <mat-icon class="alert-icon">{{ getAlertIcon(alert.type) }}</mat-icon>
        <div class="alert-content">
          <div class="alert-header">
            <span class="alert-vaccine">{{ alert.vaccineName }}</span>
            <span class="alert-batch">{{ alert.batchNumber }}</span>
          </div>
          <div class="alert-message">{{ alert.message }}</div>
        </div>
        <div class="alert-severity">
          <span class="severity-badge">{{ alert.severity }}</span>
        </div>
      </div>
    </div>
  </mat-card>

  <!-- Vaccine Categories -->
  <mat-card class="categories-section">
    <div class="section-header">
      <mat-icon class="section-icon">category</mat-icon>
      <h2>Vaccine Categories</h2>
    </div>
    <div class="categories-grid">
      <div class="category-card" *ngFor="let category of vaccineCategories" [ngClass]="getStockLevelClass(category.stockLevel)">
        <div class="category-header">
          <h3>{{ category.name }}</h3>
          <span class="stock-level-badge">{{ category.stockLevel }}</span>
        </div>
        <div class="category-stats">
          <div class="stat-item">
            <span class="stat-label">Batches</span>
            <span class="stat-value">{{ category.batches }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Total Doses</span>
            <span class="stat-value">{{ category.totalDoses | number }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Available</span>
            <span class="stat-value">{{ category.availableDoses | number }}</span>
          </div>
        </div>
        <div class="category-progress">
          <div class="progress-label">
            <span>Stock Level</span>
            <span>{{ ((category.availableDoses / category.totalDoses) * 100).toFixed(1) }}%</span>
          </div>
          <mat-progress-bar 
            mode="determinate" 
            [value]="(category.availableDoses / category.totalDoses) * 100"
            [color]="category.stockLevel === 'GOOD' ? 'primary' : category.stockLevel === 'MEDIUM' ? 'accent' : 'warn'">
          </mat-progress-bar>
        </div>
        <div class="category-utilization">
          <span>Utilization: {{ category.utilizationPercent }}%</span>
        </div>
      </div>
    </div>
  </mat-card>

  <!-- Filters -->
  <mat-card class="filters-card">
    <div class="filters-content">
      <mat-form-field appearance="outline">
        <mat-label>Search</mat-label>
        <input matInput [(ngModel)]="searchTerm" (ngModelChange)="onFilterChange()" placeholder="Search batch, vaccine, or manufacturer">
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Vaccine Type</mat-label>
        <mat-select [(ngModel)]="selectedVaccine" (ngModelChange)="onFilterChange()">
          <mat-option *ngFor="let vaccine of vaccineOptions" [value]="vaccine">
            {{ vaccine === 'all' ? 'All Vaccines' : vaccine }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Status</mat-label>
        <mat-select [(ngModel)]="selectedStatus" (ngModelChange)="onFilterChange()">
          <mat-option *ngFor="let status of statusOptions" [value]="status.value">
            {{ status.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </mat-card>

  <!-- Batch Inventory Table -->
  <mat-card class="table-card">
    <div class="section-header">
      <mat-icon class="section-icon">view_list</mat-icon>
      <h2>Batch Inventory</h2>
      <span class="batch-count">{{ filteredBatches.length }} batches</span>
    </div>
    
    <table mat-table [dataSource]="filteredBatches" class="inventory-table">
      <!-- Batch Column -->
      <ng-container matColumnDef="batch">
        <th mat-header-cell *matHeaderCellDef>Batch Details</th>
        <td mat-cell *matCellDef="let batch">
          <div class="batch-info">
            <div class="batch-number">{{ batch.batchNumber }}</div>
            <div class="batch-receipt">Received: {{ batch.receiptDate }}</div>
          </div>
        </td>
      </ng-container>

      <!-- Vaccine Column -->
      <ng-container matColumnDef="vaccine">
        <th mat-header-cell *matHeaderCellDef>Vaccine</th>
        <td mat-cell *matCellDef="let batch">
          <div class="vaccine-info">
            <div class="vaccine-name">{{ batch.vaccineName }}</div>
            <div class="manufacturer">{{ batch.manufacturer }}</div>
          </div>
        </td>
      </ng-container>

      <!-- Stock Column -->
      <ng-container matColumnDef="stock">
        <th mat-header-cell *matHeaderCellDef>Stock</th>
        <td mat-cell *matCellDef="let batch">
          <div class="stock-info">
            <div class="stock-remaining">{{ batch.quantityRemaining | number }} / {{ batch.quantityReceived | number }}</div>
            <div class="stock-bar">
              <mat-progress-bar 
                mode="determinate" 
                [value]="(batch.quantityRemaining / batch.quantityReceived) * 100"
                [color]="batch.quantityRemaining / batch.quantityReceived > 0.5 ? 'primary' : batch.quantityRemaining / batch.quantityReceived > 0.2 ? 'accent' : 'warn'">
              </mat-progress-bar>
            </div>
          </div>
        </td>
      </ng-container>

      <!-- Utilization Column -->
      <ng-container matColumnDef="utilization">
        <th mat-header-cell *matHeaderCellDef>Utilization</th>
        <td mat-cell *matCellDef="let batch">
          <span class="utilization-badge" [style.background]="batch.utilizationPercent > 50 ? '#38ef7d' : '#ffa726'">
            {{ batch.utilizationPercent }}%
          </span>
        </td>
      </ng-container>

      <!-- Expiry Column -->
      <ng-container matColumnDef="expiry">
        <th mat-header-cell *matHeaderCellDef>Expiry</th>
        <td mat-cell *matCellDef="let batch">
          <div class="expiry-info">
            <div class="expiry-date">{{ batch.expiryDate }}</div>
            <div class="days-remaining" [ngClass]="{
              'critical': batch.daysUntilExpiry < 0,
              'warning': batch.daysUntilExpiry >= 0 && batch.daysUntilExpiry <= 7,
              'caution': batch.daysUntilExpiry > 7 && batch.daysUntilExpiry <= 30,
              'normal': batch.daysUntilExpiry > 30
            }">
              {{ batch.daysUntilExpiry < 0 ? 'Expired' : batch.daysUntilExpiry + ' days left' }}
            </div>
          </div>
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let batch">
          <mat-chip [ngClass]="getStatusClass(batch.status)">
            <mat-icon>{{ getStatusIcon(batch.status) }}</mat-icon>
            {{ batch.status.replace('_', ' ') }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let batch">
          <div class="action-buttons">
            <button mat-icon-button color="primary" (click)="viewBatchDetails(batch)" matTooltip="View Details">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button color="accent" (click)="adjustStock(batch)" matTooltip="Adjust Stock" *ngIf="batch.status !== 'EXPIRED'">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="disposeBatch(batch)" matTooltip="Dispose Batch" *ngIf="batch.status === 'EXPIRED'">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="batch-row"></tr>
    </table>

    <div class="no-data" *ngIf="filteredBatches.length === 0">
      <mat-icon>inventory</mat-icon>
      <p>No batches found matching the current filters</p>
    </div>
  </mat-card>
</div>
