<div class="alerts-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <mat-icon class="page-icon">notifications_active</mat-icon>
      <h1 class="page-title">Stock Alerts Management</h1>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="refreshAlerts()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
      <button mat-raised-button (click)="exportAlertsReport()">
        <mat-icon>download</mat-icon>
        Export Report
      </button>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="kpi-grid">
    <mat-card class="kpi-card">
      <div class="kpi-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <mat-icon>notifications</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Total Alerts</div>
        <div class="kpi-value">{{ kpis.totalAlerts }}</div>
        <div class="kpi-sublabel">Active alerts</div>
      </div>
    </mat-card>

    <mat-card class="kpi-card">
      <div class="kpi-icon" style="background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);">
        <mat-icon>warning</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Critical Alerts</div>
        <div class="kpi-value">{{ kpis.criticalAlerts }}</div>
        <div class="kpi-sublabel">Requires immediate action</div>
      </div>
    </mat-card>

    <mat-card class="kpi-card">
      <div class="kpi-icon" style="background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);">
        <mat-icon>pending_actions</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Pending Actions</div>
        <div class="kpi-value">{{ kpis.pendingActions }}</div>
        <div class="kpi-sublabel">Awaiting response</div>
      </div>
    </mat-card>

    <mat-card class="kpi-card">
      <div class="kpi-icon" style="background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%);">
        <mat-icon>check_circle</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">Resolved Today</div>
        <div class="kpi-value">{{ kpis.resolvedToday }}</div>
        <div class="kpi-sublabel">Successfully resolved</div>
      </div>
    </mat-card>
  </div>

  <!-- Alert Statistics Chart -->
  <mat-card class="statistics-card">
    <div class="section-header">
      <mat-icon class="section-icon">bar_chart</mat-icon>
      <h2>Alert Trends (Last 7 Days)</h2>
    </div>
    <div class="chart-container">
      <div class="chart-bars">
        <div class="chart-bar-group" *ngFor="let stat of alertStatistics">
          <div class="bars-wrapper">
            <div class="bar bar-total" [style.height.%]="(stat.totalAlerts / 10) * 100" matTooltip="Total: {{stat.totalAlerts}}"></div>
            <div class="bar bar-critical" [style.height.%]="(stat.critical / 10) * 100" matTooltip="Critical: {{stat.critical}}"></div>
            <div class="bar bar-resolved" [style.height.%]="(stat.resolved / 10) * 100" matTooltip="Resolved: {{stat.resolved}}"></div>
          </div>
          <div class="bar-label">{{ stat.date | date:'MM/dd' }}</div>
        </div>
      </div>
      <div class="chart-legend">
        <div class="legend-item">
          <span class="legend-color" style="background: #f093fb;"></span>
          <span>Total</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #ff6b6b;"></span>
          <span>Critical</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #38ef7d;"></span>
          <span>Resolved</span>
        </div>
      </div>
    </div>
  </mat-card>

  <!-- Filters Card -->
  <mat-card class="filters-card">
    <div class="filters-content">
      <mat-form-field appearance="outline">
        <mat-label>Search</mat-label>
        <input matInput [(ngModel)]="searchTerm" (ngModelChange)="onFilterChange()" placeholder="Search vaccine, batch, or message">
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Severity</mat-label>
        <mat-select [(ngModel)]="selectedSeverity" (ngModelChange)="onFilterChange()">
          <mat-option *ngFor="let option of severityOptions" [value]="option.value">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Alert Type</mat-label>
        <mat-select [(ngModel)]="selectedAlertType" (ngModelChange)="onFilterChange()">
          <mat-option *ngFor="let option of alertTypeOptions" [value]="option.value">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Status</mat-label>
        <mat-select [(ngModel)]="selectedStatus" (ngModelChange)="onFilterChange()">
          <mat-option *ngFor="let option of statusOptions" [value]="option.value">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Start Date</mat-label>
        <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate" (ngModelChange)="onFilterChange()">
        <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
        <mat-datepicker #startPicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>End Date</mat-label>
        <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate" (ngModelChange)="onFilterChange()">
        <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
        <mat-datepicker #endPicker></mat-datepicker>
      </mat-form-field>
    </div>
  </mat-card>

  <!-- Bulk Actions -->
  <mat-card class="bulk-actions-card" *ngIf="selectedAlerts.size > 0">
    <div class="bulk-actions-content">
      <span class="selection-count">{{ selectedAlerts.size }} alert(s) selected</span>
      <div class="action-buttons">
        <button mat-raised-button color="primary" (click)="bulkMarkAsRead()">
          <mat-icon>drafts</mat-icon>
          Mark as Read
        </button>
        <button mat-raised-button color="accent" (click)="bulkAcknowledge()">
          <mat-icon>check_circle_outline</mat-icon>
          Acknowledge
        </button>
        <button mat-raised-button color="primary" (click)="bulkResolve()">
          <mat-icon>check_circle</mat-icon>
          Resolve
        </button>
        <button mat-raised-button (click)="bulkDismiss()">
          <mat-icon>cancel</mat-icon>
          Dismiss
        </button>
      </div>
    </div>
  </mat-card>

  <!-- Alerts Tabs and Table -->
  <mat-card class="alerts-table-card">
    <mat-tab-group (selectedIndexChange)="onTabChange($event)">
      <mat-tab label="All Alerts">
        <ng-template matTabLabel>
          <mat-icon class="tab-icon">notifications</mat-icon>
          All Alerts
          <span class="tab-badge">{{ alerts.length }}</span>
        </ng-template>
      </mat-tab>
      
      <mat-tab label="Low Stock">
        <ng-template matTabLabel>
          <mat-icon class="tab-icon">inventory_2</mat-icon>
          Low Stock
          <span class="tab-badge">{{ getAlertCountByType('LOW_STOCK') }}</span>
        </ng-template>
      </mat-tab>
      
      <mat-tab label="Expiring">
        <ng-template matTabLabel>
          <mat-icon class="tab-icon">schedule</mat-icon>
          Expiring
          <span class="tab-badge">{{ getAlertCountByType('EXPIRING') }}</span>
        </ng-template>
      </mat-tab>
      
      <mat-tab label="Expired">
        <ng-template matTabLabel>
          <mat-icon class="tab-icon">warning</mat-icon>
          Expired
          <span class="tab-badge">{{ getAlertCountByType('EXPIRED') }}</span>
        </ng-template>
      </mat-tab>
      
      <mat-tab label="Reorder">
        <ng-template matTabLabel>
          <mat-icon class="tab-icon">shopping_cart</mat-icon>
          Reorder
          <span class="tab-badge">{{ getAlertCountByType('REORDER') }}</span>
        </ng-template>
      </mat-tab>
    </mat-tab-group>

    <div class="table-container">
      <table mat-table [dataSource]="filteredAlerts" class="alerts-table">
        <!-- Select Column -->
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox 
              [checked]="isAllSelected()"
              [indeterminate]="selectedAlerts.size > 0 && !isAllSelected()"
              (change)="toggleSelectAll($event)">
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let alert">
            <mat-checkbox 
              [checked]="isSelected(alert.id)"
              (change)="toggleSelect(alert.id)">
            </mat-checkbox>
          </td>
        </ng-container>

        <!-- Type Column -->
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef>Type</th>
          <td mat-cell *matCellDef="let alert">
            <mat-icon class="alert-type-icon" [style.color]="alert.severity === 'CRITICAL' ? '#ef5350' : alert.severity === 'HIGH' ? '#ffa726' : '#4facfe'">
              {{ getAlertIcon(alert.type) }}
            </mat-icon>
          </td>
        </ng-container>

        <!-- Vaccine Column -->
        <ng-container matColumnDef="vaccine">
          <th mat-header-cell *matHeaderCellDef>Vaccine</th>
          <td mat-cell *matCellDef="let alert">
            <span class="vaccine-name">{{ alert.vaccineName }}</span>
          </td>
        </ng-container>

        <!-- Batch Column -->
        <ng-container matColumnDef="batch">
          <th mat-header-cell *matHeaderCellDef>Batch Number</th>
          <td mat-cell *matCellDef="let alert">
            <span class="batch-number">{{ alert.batchNumber }}</span>
          </td>
        </ng-container>

        <!-- Severity Column -->
        <ng-container matColumnDef="severity">
          <th mat-header-cell *matHeaderCellDef>Severity</th>
          <td mat-cell *matCellDef="let alert">
            <mat-chip [ngClass]="getSeverityClass(alert.severity)">
              {{ alert.severity }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Message Column -->
        <ng-container matColumnDef="message">
          <th mat-header-cell *matHeaderCellDef>Message</th>
          <td mat-cell *matCellDef="let alert">
            <span class="alert-message">{{ alert.message }}</span>
          </td>
        </ng-container>

        <!-- Info Column -->
        <ng-container matColumnDef="info">
          <th mat-header-cell *matHeaderCellDef>Info</th>
          <td mat-cell *matCellDef="let alert">
            <div class="alert-info">
              <span *ngIf="alert.quantity" class="info-badge">
                <mat-icon>inventory</mat-icon>
                {{ alert.quantity }} doses
              </span>
              <span *ngIf="alert.daysRemaining !== undefined" class="info-badge">
                <mat-icon>schedule</mat-icon>
                {{ alert.daysRemaining >= 0 ? alert.daysRemaining + ' days' : 'Expired' }}
              </span>
            </div>
          </td>
        </ng-container>

        <!-- Created Column -->
        <ng-container matColumnDef="created">
          <th mat-header-cell *matHeaderCellDef>Created</th>
          <td mat-cell *matCellDef="let alert">
            <span class="date-text">{{ alert.createdAt | date:'short' }}</span>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let alert">
            <mat-chip [ngClass]="getStatusClass(alert.status)">
              <mat-icon>{{ getStatusIcon(alert.status) }}</mat-icon>
              {{ alert.status }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let alert">
            <div class="action-buttons">
              <button mat-icon-button *ngIf="alert.status === 'UNREAD'" (click)="markAsRead(alert)" matTooltip="Mark as Read">
                <mat-icon>drafts</mat-icon>
              </button>
              <button mat-icon-button *ngIf="alert.status !== 'RESOLVED' && alert.status !== 'DISMISSED'" (click)="acknowledgeAlert(alert)" matTooltip="Acknowledge">
                <mat-icon>check_circle_outline</mat-icon>
              </button>
              <button mat-icon-button color="primary" *ngIf="alert.status !== 'RESOLVED' && alert.status !== 'DISMISSED'" (click)="resolveAlert(alert)" matTooltip="Resolve">
                <mat-icon>check_circle</mat-icon>
              </button>
              <button mat-icon-button color="warn" *ngIf="alert.status !== 'DISMISSED'" (click)="dismissAlert(alert)" matTooltip="Dismiss">
                <mat-icon>cancel</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="alert-row" [ngClass]="{'unread-row': row.status === 'UNREAD'}"></tr>
      </table>

      <div class="no-data" *ngIf="filteredAlerts.length === 0">
        <mat-icon>notifications_none</mat-icon>
        <p>No alerts found matching the current filters</p>
      </div>
    </div>
  </mat-card>

  <!-- Notification Preferences -->
  <mat-card class="preferences-card">
    <div class="section-header">
      <mat-icon class="section-icon">settings</mat-icon>
      <h2>Notification Preferences</h2>
    </div>
    
    <div class="preferences-content">
      <div class="preference-section">
        <h3>Notification Channels</h3>
        <div class="preference-row">
          <mat-slide-toggle [(ngModel)]="notificationPreferences.email">
            Email Notifications
          </mat-slide-toggle>
        </div>
        <div class="preference-row">
          <mat-slide-toggle [(ngModel)]="notificationPreferences.sms">
            SMS Notifications
          </mat-slide-toggle>
        </div>
      </div>

      <div class="preference-section">
        <h3>Alert Thresholds</h3>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Low Stock Threshold (%)</mat-label>
          <input matInput type="number" [(ngModel)]="notificationPreferences.lowStockThreshold" min="1" max="100">
          <span matSuffix>%</span>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Expiry Warning Days</mat-label>
          <input matInput type="number" [(ngModel)]="notificationPreferences.expiryWarningDays" min="1" max="365">
          <span matSuffix>days</span>
        </mat-form-field>
      </div>

      <div class="preference-section">
        <h3>Notification Frequency</h3>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Frequency</mat-label>
          <mat-select [(ngModel)]="notificationPreferences.frequency">
            <mat-option *ngFor="let option of frequencyOptions" [value]="option.value">
              {{ option.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="preference-actions">
        <button mat-raised-button color="primary" (click)="saveNotificationPreferences()">
          <mat-icon>save</mat-icon>
          Save Preferences
        </button>
      </div>
    </div>
  </mat-card>
</div>
